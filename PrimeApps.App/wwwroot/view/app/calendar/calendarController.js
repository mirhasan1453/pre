"use strict";angular.module("primeapps").controller("CalendarController",["$rootScope","$scope","$state","$filter","activityTypes","$templateCache","$modal","$timeout","$cache","$dropdown","ModuleService","calendarConfig","$http","config",function(e,a,t,n,l,s,i,d,o,r,v,c,m,p){var u=window.localStorage.NG_TRANSLATE_LANG_KEY||"tr",y=window.localStorage.locale_key||u;e.user.profile.has_admin_rights||m.get(p.apiUrl+"settings/get_by_key/custom/calendar_delete_show").then(function(e){a.calendarDeleteShow=e.data.value}),c.dateFormatter="angular",c.allDateFormats.angular.title.month="MMMM yyyy",c.allDateFormats.angular.title.year="yyyy",a.users=angular.copy(e.users),a.users.unshift({id:0,FullName:n("translate")("Tasks.AllUsers"),IsActive:!0}),a.filter={owner:a.users[0]},"tr"===u?(c.allDateFormats.angular.title.week="{week}. Hafta {year}",c.i18nStrings.weekNumber="{week}. Hafta"):(c.allDateFormats.angular.title.week="Week {week} of {year}",c.i18nStrings.weekNumber="Week {week}"),"tr"===y?(c.allDateFormats.angular.date.hour="HH:mm",c.allDateFormats.angular.date.datetime="dd.MM.yyyy HH:mm"):(c.allDateFormats.angular.date.hour="ha",c.allDateFormats.angular.date.datetime="MMM d, h:mm a"),a.moduleActivity=n("filter")(e.modules,{name:"activities"},!0)[0],a.modules=n("filter")(e.modules,{display_calendar:!0,name:"!activities"},!0),a.calendarView="month",a.calendarDay=new Date,a.calendarTitle="",a.events=[],a.activityPermissions=n("filter")(e.user.profile.permissions,{module_id:a.moduleActivity.id},!0)[0],s.put("view/app/calendar/templates/calendarMonthCell.html",'<div mwl-droppable on-drop="vm.handleEventDrop(dropData.event, day.date, dropData.draggedFromDate)" mwl-drag-select="!!vm.onDateRangeSelect" on-drag-select-start="vm.onDragSelectStart(day)" on-drag-select-move="vm.onDragSelectMove(day)" on-drag-select-end="vm.onDragSelectEnd(day)" class="cal-month-day {{ day.cssClass }}" ng-class="{ \'cal-day-outmonth\': !day.inMonth, \'cal-day-inmonth\': day.inMonth, \'cal-day-weekend\': day.isWeekend, \'cal-day-past\': day.isPast, \'cal-day-today\': day.isToday, \'cal-day-future\': day.isFuture, \'cal-day-selected\': vm.dateRangeSelect && vm.dateRangeSelect.startDate <= day.date && day.date <= vm.dateRangeSelect.endDate, \'cal-day-open\': dayIndex === vm.openDayIndex }">  <span class="pull-right" data-cal-date ng-click="vm.calendarCtrl.dateClicked(day.date)" ng-bind="day.label"> </span>  <div class="add-button"> <a href class="btn btn-xs btn-default" ng-click="vm.templateScope.openCreateModal($event, day)">+</a> </div>  <div class="counts"> <span ng-repeat="(type, group) in day.groups track by type" data-title="{{group.module}}" data-trigger="hover" data-placement="top" bs-tooltip> <span class="label" ng-style="{\'background-color\': group.color}"> {{ group.events.length }} </span>&nbsp; </span> </div>  <div class="cal-day-tick" ng-show="dayIndex === vm.openDayIndex && (vm.cellAutoOpenDisabled || vm.view[vm.openDayIndex].events.length > 0) && !vm.slideBoxDisabled"> <i class="glyphicon glyphicon-chevron-up"></i> <i class="fa fa-chevron-up"></i> </div>  <ng-include src="vm.customTemplateUrls.calendarMonthCellEvents || vm.calendarConfig.templates.calendarMonthCellEvents"></ng-include>  <div id="cal-week-box" ng-if="$first && rowHovered"> <span ng-bind="vm.getWeekNumberLabel(day)"></span> </div>  </div>'),s.put("view/app/calendar/templates/calendarSlideBox.html",'<div   class="cal-slide-box" uib-collapse="vm.isCollapsed" mwl-collapse-fallback="vm.isCollapsed"> <div class="cal-slide-content cal-event-list"> <ul class="unstyled list-unstyled"> <li ng-repeat="event in vm.events | orderBy:\'startsAt\' track by event.calendarEventId"  class="event-line" ng-class="event.cssClass" mwl-draggable="event.draggable === true" drop-data="{event: event}"> <span class="event-bullet" ng-style="{backgroundColor: event.color.primary}" data-title="{{event.module}}" data-trigger="hover" data-placement="right" bs-tooltip></span>  <a href="#/app/module/{{event.type}}{{\'?id=\' + event.id + \'&back=calendar\'}}" class="event-item"> <span ng-bind-html="isMonthView ? vm.calendarEventTitle.monthView(event) : vm.calendarEventTitle.yearView(event) | calendarTrustAsHtml"></span> </a>  <span class="action-buttons"> <a  href="#/app/moduleForm/{{event.type}}{{\'?id=\' + event.id + \'&back=calendar\'}}"  ng-show="event.permissions.modify" class="action-icon" title="{{\'Common.Edit\' | translate}}"><i class="flaticon-pencil124"></i></a> <i ng-show="event.permissions.remove && event.calendardeleteshow !=\'active\'"  class="action-icon flaticon-bin9" confirm-click action="vm.templateScope.delete(event)" placement="left" confirm-message="{{\'Common.AreYouSure\' | translate}}" confirm-yes="{{\'Common.Yes\' | translate}}" confirm-no="{{\'Common.No\' | translate}}" title="{{\'Common.Delete\' | translate}}"></i> </span> </li> </ul> </div> </div>'),s.put("view/app/calendar/templates/calendarYearView.html",'<div class="cal-year-box"> <div ng-repeat="rowOffset in [0, 4, 8] track by rowOffset"> <div class="row cal-before-eventlist"> <div class="span3 col-md-3 col-xs-6 cal-cell {{ day.cssClass }}" ng-repeat="month in vm.view | calendarLimitTo:4:rowOffset track by $index" ng-init="monthIndex = vm.view.indexOf(month)" ng-click="vm.calendarCtrl.dateClicked(month.date)" ng-class="{\'cal-day-today\': month.isToday}" mwl-droppable on-drop="vm.handleEventDrop(dropData.event, month.date)">  <span class="pull-right" data-cal-date ng-click="vm.calendarCtrl.dateClicked(month.date)" ng-bind="month.label"> </span>  <div class="counts"> <span ng-repeat="(type, group) in month.groups track by type" data-title="{{group.module}}" data-trigger="hover" data-placement="top" bs-tooltip> <span class="label" ng-style="{\'background-color\': group.color}"> {{ group.events.length }} </span>&nbsp; </span> </div>  <div class="cal-day-tick" ng-show="monthIndex === vm.openMonthIndex && (vm.cellAutoOpenDisabled || vm.view[vm.openMonthIndex].events.length > 0) && !vm.slideBoxDisabled"> <i class="glyphicon glyphicon-chevron-up"></i> <i class="fa fa-chevron-up"></i> </div>  </div> </div>  </div>  </div>'),s.put("view/app/calendar/templates/calendarDayView.html",'<div class="cal-week-box cal-all-day-events-box" ng-if="vm.allDayEvents.length > 0"> <div class="cal-day-panel clearfix"> <div class="row"> <div class="col-xs-12"> <div class="cal-row-fluid"> <div class="cal-cell-6 day-highlight" ng-style="{backgroundColor: event.color.secondary}" data-event-class ng-repeat="event in vm.allDayEvents track by event.calendarEventId"> <strong>{{\'Calendar.AllDay\' | translate}}</strong> <a href="#/app/module/{{event.type}}{{\'?id=\' + event.id + \'&back=calendar\'}}" class="event-item" ng-bind-html="vm.calendarEventTitle.dayView(event) | calendarTrustAsHtml"> </a> </div> </div> </div> </div> </div> </div>  <div class="cal-day-box"> <div class="cal-day-panel clearfix" ng-style="{height: vm.dayViewHeight + \'px\', minWidth: vm.viewWidth + \'px\'}">  <mwl-calendar-hour-list day-view-start="vm.dayViewStart" day-view-end="vm.dayViewEnd" day-view-split="vm.dayViewSplit" on-timespan-click="vm.onTimespanClick" on-date-range-select="vm.onDateRangeSelect" on-event-times-changed="vm.onEventTimesChanged" view-date="vm.viewDate" custom-template-urls="vm.customTemplateUrls" template-scope="vm.templateScope" cell-modifier="vm.cellModifier"> </mwl-calendar-hour-list>  <div class="pull-left day-event day-highlight" ng-repeat="dayEvent in vm.nonAllDayEvents track by dayEvent.event.calendarEventId" ng-class="dayEvent.event.cssClass" ng-style="{ top: dayEvent.top - 1 + \'px\', left: dayEvent.left + 60 + \'px\', height: dayEvent.height + \'px\', width: dayEvent.width + \'px\', backgroundColor: dayEvent.event.color.secondary, borderColor: dayEvent.event.color.primary }" mwl-draggable="dayEvent.event.draggable === true" axis="\'xy\'" snap-grid="{y: vm.dayViewEventChunkSize || 30, x: 50}" on-drag="vm.eventDragged(dayEvent.event, y / 30)" on-drag-end="vm.eventDragComplete(dayEvent.event, y / 30)" mwl-resizable="dayEvent.event.resizable === true && dayEvent.event.endsAt" resize-edges="{top: true, bottom: true}" on-resize="vm.eventResized(dayEvent.event, edge, y / 30)" on-resize-end="vm.eventResizeComplete(dayEvent.event, edge, y / 30)" uib-tooltip-html="vm.calendarEventTitle.dayViewTooltip(dayEvent.event) | calendarTrustAsHtml" tooltip-append-to-body="true">  <span class="cal-hours"> <span ng-show="dayEvent.top == 0"><span ng-bind="(dayEvent.event.tempStartsAt || dayEvent.event.startsAt) | calendarDate:\'day\':true"></span>, </span> <span ng-bind="(dayEvent.event.tempStartsAt || dayEvent.event.startsAt) | calendarDate:\'time\':true"></span> </span> <a href="#/app/module/{{dayEvent.event.type}}{{\'?id=\' + dayEvent.event.id + \'&back=calendar\'}}" class="event-item" ng-click="vm.onEventClick({calendarEvent: dayEvent.event})"> <span ng-bind-html="vm.calendarEventTitle.dayView(dayEvent.event) | calendarTrustAsHtml"></span> </a>  <a href="javascript:;" class="event-item-action" ng-repeat="action in dayEvent.event.actions track by $index" ng-class="action.cssClass" ng-bind-html="action.label | calendarTrustAsHtml" ng-click="action.onClick({calendarEvent: dayEvent.event})"> </a>  </div>  </div>  </div>'),s.put("view/app/calendar/templates/calendarWeekView.html",'<div class="cal-week-box" ng-class="{\'cal-day-box\': vm.showTimes}"> <div class="cal-row-fluid cal-row-head">  <div class="cal-cell1" ng-repeat="day in vm.view.days track by $index" ng-class="{ \'cal-day-weekend\': day.isWeekend, \'cal-day-past\': day.isPast, \'cal-day-today\': day.isToday, \'cal-day-future\': day.isFuture}" mwl-element-dimensions="vm.dayColumnDimensions" mwl-droppable on-drop="vm.eventDropped(dropData.event, day.date)">  <span ng-bind="day.weekDayLabel"></span> <br> <small> <span data-cal-date ng-click="vm.calendarCtrl.dateClicked(day.date)" class="pointer" ng-bind="day.dayLabel"> </span> </small>  </div>  </div>  <div class="cal-day-panel clearfix" ng-style="{height: vm.showTimes ? (vm.dayViewHeight + \'px\') : \'auto\'}">  <mwl-calendar-hour-list day-view-start="vm.dayViewStart" day-view-end="vm.dayViewEnd" day-view-split="vm.dayViewSplit" day-width="vm.dayColumnDimensions.width" view-date="vm.viewDate" on-timespan-click="vm.onTimespanClick" on-date-range-select="vm.onDateRangeSelect" custom-template-urls="vm.customTemplateUrls" cell-modifier="vm.cellModifier" template-scope="vm.templateScope" ng-if="vm.showTimes"> </mwl-calendar-hour-list>  <div class="row" ng-repeat="row in vm.view.eventRows track by $index"> <div class="col-xs-12"> <div class="cal-row-fluid"> <div ng-repeat="eventRow in row.row track by eventRow.event.calendarEventId" ng-class="\'cal-cell\' + (vm.showTimes ? 1 : eventRow.span) + (vm.showTimes ? \'\' : \' cal-offset\' + eventRow.offset)" ng-style="{ top: vm.showTimes ? ((eventRow.top) + \'px\') : \'auto\', position: vm.showTimes ? \'absolute\' : \'inherit\', width: vm.showTimes ? (vm.dayColumnDimensions.width + \'px\') : \'\', left: vm.showTimes ? (vm.dayColumnDimensions.width * eventRow.offset) + 15 + \'px\' : \'\' }"> <div class="day-highlight" ng-class="[eventRow.event.cssClass, !vm.showTimes && eventRow.startsBeforeWeek ? \'\' : \'border-left-rounded\', !vm.showTimes && eventRow.endsAfterWeek ? \'\' : \'border-right-rounded\']" ng-style="{backgroundColor: eventRow.event.color.secondary}" data-event-class mwl-draggable="eventRow.event.draggable === true" axis="vm.showTimes ? \'xy\' : \'x\'" snap-grid="vm.showTimes ? {x: vm.dayColumnDimensions.width, y: vm.dayViewEventChunkSize || 30} : {x: vm.dayColumnDimensions.width}" on-drag="vm.tempTimeChanged(eventRow.event, y / 30)" on-drag-end="vm.weekDragged(eventRow.event, x / vm.dayColumnDimensions.width, y / 30)" mwl-resizable="eventRow.event.resizable === true && eventRow.event.endsAt && !vm.showTimes" resize-edges="{left: true, right: true}" on-resize-end="vm.weekResized(eventRow.event, edge, x / vm.dayColumnDimensions.width)"> <strong ng-bind="(eventRow.event.tempStartsAt || eventRow.event.startsAt) | calendarDate:\'time\':true" ng-show="vm.showTimes"></strong> <a href="#/app/module/{{eventRow.event.type}}{{\'?id=\' + eventRow.event.id + \'&back=calendar\'}}" ng-click="vm.onEventClick({calendarEvent: eventRow.event})" class="event-item" ng-bind-html="vm.calendarEventTitle.weekView(eventRow.event) | calendarTrustAsHtml" uib-tooltip-html="vm.calendarEventTitle.weekViewTooltip(eventRow.event) | calendarTrustAsHtml" tooltip-placement="left" tooltip-append-to-body="true"> </a> </div> </div> </div> </div>  </div>  </div> </div>');var g=function(t){var s=o.get("calendar_events");if(!t&&s)return void(a.events=s);if(e.calendarFields){a.additionalFields=[];for(var i=e.calendarFields.value.split("|"),r=0;r<i.length;r++){var c=i[r],m=c.split(";"),p={};p.module=m[0],p.fields=m[1].split(","),a.additionalFields.push(p)}}a.events=[],a.permissions=[],a.permissions.activities=a.activityPermissions,a.modules.length>0&&angular.forEach(a.modules,function(t){var l=n("filter")(t.fields,{primary:!0},!0)[0],s=n("filter")(t.fields,{primary_lookup:!0},!0)[0],i=n("filter")(t.fields,{calendar_date_type:"start_date"},!0)[0],d=n("filter")(t.fields,{calendar_date_type:"end_date"},!0)[0];if(l&&i&&d&&(a.permissions[t.name]||(a.permissions[t.name]=n("filter")(e.user.profile.permissions,{module_id:t.id},!0)[0]),a.permissions[t.name].read)){s&&(l=s);var o={};if(o.fields=[l.name,i.name,d.name,"owner.users.full_name"],o.sort_field="created_at",o.sort_direction="desc",o.limit=2e3,a.filter&&a.filter.owner&&a.filter.owner.id>0&&(o.filters||(o.filters=[]),o.filters.push({field:"owner",operator:"equals",value:a.filter.owner.id,no:1})),a.additionalFields){var r=n("filter")(a.additionalFields,{module:t.name},!0)[0];r&&r.fields&&(o.fields=o.fields.concat(r.fields))}v.getPicklists(t).then(function(s){v.findRecords(t.name,o).then(function(c){var m=angular.copy(c.data);if(m){if(r){for(var p=[],u=0;u<o.fields.length;u++){var y={};y.field=o.fields[u],y.order=u+1,p.push(y)}m=v.processRecordMulti(m,t,s,p,t.name)}angular.forEach(c.data,function(s){var o={};if(o.id=s.id,o.title="",o.color={primary:t.calendar_color_dark||"#fbb903",secondary:t.calendar_color_light||"#fdf1ba"},o.module=t["label_"+e.language+"_singular"],o.type=t.name,o.permissions=a.permissions[o.type],o.calendardeleteshow=a.calendarDeleteShow,r){var v=n("filter")(m,{id:s.id},!0)[0];o.title=n("filter")(v.fields,{name:l.name},!0)[0].valueFormatted;for(var c=0;c<r.fields.length;c++){var p=r.fields[c];p.indexOf(".")>-1&&(p=p.split(".")[2]);var u=n("filter")(v.fields,{name:p},!0)[0];o.title+=u?" | "+u.valueFormatted:" | "}}else o.title=s[l.name]?(l.auto_number_prefix||"")+s[l.name]+(l.auto_number_suffix||""):s["owner.users.full_name"];if(o.title+=' | <span class="event-user">'+s["owner.users.full_name"]+"</span>",s[i.name]||(s[i.name]=s[d.name]),"izinler"==o.type&&s[d.name]){var y=s[d.name],g=y.split("T"),h=g[0].split("-"),w=parseInt(h[2])-1,f=g[0].split("-"),b=f[0]+"-"+f[1]+"-"+w.toString()+"T"+g[1];s[d.name]=b}o.startsAt=moment.utc(s[i.name]).toDate(),o.endsAt=moment.utc(s[d.name]).toDate(),a.events.push(o)})}})})}});var u=n("filter")(a.moduleActivity.fields,{primary:!0},!0)[0],y=n("filter")(l,{system_code:"event"},!0)[0],g={};g.fields=[u.name,"event_start_date","event_end_date","all_day_event","owner.users.full_name"],g.filters=[{field:"activity_type_system",operator:"is",value:"event",no:1}],g.sort_field="created_at",g.sort_direction="desc",g.limit=2e3,a.filter&&a.filter.owner&&a.filter.owner.id>0&&g.filters.push({field:"owner",operator:"equals",value:a.filter.owner.id,no:2}),a.permissions.activities.read&&v.findRecords("activities",g).then(function(t){angular.forEach(t.data,function(t){var n=moment.utc(t.event_start_date).toDate(),l=moment.utc(t.event_end_date).toDate(),s={};if(s.id=t.id,s.title=t[u.name]?t[u.name]+' | <span class="event-user">'+t["owner.users.full_name"]+"</span>":t["owner.users.full_name"],s.color={primary:a.moduleActivity.calendar_color_dark||"#fbb903",secondary:a.moduleActivity.calendar_color_light||"#fdf1ba"},s.module=y.label[e.language],s.type="activities",s.permissions=a.permissions[s.type],s.calendardeleteshow=a.calendarDeleteShow,"Yes"===t.all_day_event||"Evet"===t.all_day_event){var i=new Date(n.getFullYear(),n.getMonth(),n.getDate(),0,0,0),d=new Date(l.getFullYear(),l.getMonth(),l.getDate(),23,59,59);s.startsAt=i,s.endsAt=d,s.allDay=!0}else s.startsAt=n,s.endsAt=l;a.events.push(s)})}),d(function(){o.put("calendar_events",a.events)},5e3)};g(),a.filterChanged=function(){g(!0)},a.groupEvents=function(e){e.events&&e.events.length&&(e.groups={},e.events.forEach(function(a){e.groups[a.type]=e.groups[a.type]||{},e.groups[a.type].module=a.module,e.groups[a.type].color=a.color.primary,e.groups[a.type].events=e.groups[a.type].events||[],e.groups[a.type].events.push(a)}))},a["delete"]=function(e){v.deleteRecord(e.type,e.id).then(function(){g(!0),o.remove(e.type+"_"+e.type)})},a.openCreateModal=function(t,n,l){return n&&(a.calendarDate=n.date),!l&&a.modules.length>0?(a.dropdownModules={},a.content=[],a.content.push({text:"tr"===e.language?"Etkinlik":"Event",href:"",click:'openCreateModal(null, null, "activities")'}),angular.forEach(a.modules,function(t){a.content.push({text:t["label_"+e.language+"_singular"],href:"",click:'openCreateModal(null, null, "'+t.name+'")'})}),a.dropdownModules[n.label]=a.dropdownModules[n.label]||r(angular.element(t.target),{scope:a,show:!1,animation:""}),void a.dropdownModules[n.label].$promise.then(a.dropdownModules[n.label].show)):(l||(l="activities"),a.currentLookupField={lookup_type:l},a.formModal=a.formModal||i({scope:a,templateUrl:"view/app/module/moduleFormModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),void a.formModal.$promise.then(a.formModal.show))},a.formModalSuccess=function(){g(!0)}}]);