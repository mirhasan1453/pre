"use strict";angular.module("primeapps").directive("documentList",["$filter","guidEmpty","entityTypes","helper","operations","DocumentService","$localStorage","config","$stateParams","$window","ngToast",function(e,t,n,o,i,a,r,c,s,l,d){return{restrict:"EA",scope:{documents:"=",entityId:"=",entityType:"=",isAll:"="},templateUrl:cdnUrl+"view/app/documents/documentList.html",controller:["$scope",function(u){u.editedDocument=null,u.documentState={},u.documentUpdating=!1,u.apiUrl=u.$root.config.apiUrl,u.guidEmpty=t,u.hasPermission=o.hasPermission,u.hasDocumentsPermission=o.hasDocumentsPermission,u.entityTypes=n,u.operations=i,u.lightBox=!1,u.type=s.type,u.module=e("filter")(u.$root.modules,{name:s.type},!0)[0],u.moduleId=u.module.id;var m=u.$root.workgroup.tenant_id,p=u.entityId,f=u.moduleId;u.edit=function(e){u.editedDocument=e,u.documentState=angular.copy(e),e.editing=!0},u.cancelEdit=function(){this.document=u.documentState,u.editedDocument=null},u.update=function(e){if(u.editedDocument&&u.editedDocument.name_plain&&u.editedDocument.name_plain.trim()){u.documentUpdating=!0;var t=u.editedDocument.NamePlain.trim()+"."+u.editedDocument.Extension;a.update(u.editedDocument.id,u.$root.workgroup.tenant_id,t,u.editedDocument.description,u.editedDocument.RecordId,u.editedDocument.ModuleId).then(function(){u.documentUpdating=!1,u.editedDocument=null,e.Name=t})["catch"](function(){u.documentUpdating=!1})}},u.remove=function(e){a.remove(e).then(function(){u.isAll?a.getDocuments(m,p,f).then(function(e){var t=a.processDocuments(e.data,u.$root.users);u.$parent.documents=t.documentList,u.$parent.documentsResultSet&&(u.$parent.documentsResultSet.totalDocumentCount=e.data.total_documents_count)}):a.getEntityDocuments(m,p,f).then(function(e){var t=a.processDocuments(e.data,u.$root.users);u.$parent.documents=t.documentList,u.$parent.documentsResultSet.totalDocumentCount=e.data.total_documents_count})})},u.getParentEntityName=function(t,n){var o=e("filter")(u.$root.clientData,{EntityType:t,EntityID:n})[0];return o?o.EntityName:""},u.icon=function(e){var t="fa fa-2x ";switch(e){case"doc":case"docx":t+="fa-file-word-o";break;case"xls":case"xlsx":t+="fa-file-excel-o";break;case"ppt":case"pptx":t+="fa-file-powerpoint-o";break;case"pdf":t+="fa-file-pdf-o";break;case"txt":t+="fa-file-text-o";break;case"bmp":case"jpeg":case"jpg":case"png":case"gif":t+="fa-file-image-o";break;case"zip":t+="fa-file-archive-o";break;case"rar":t+="fa-file-archive-o";break;case"eml":case"msg":t+="fa fa-envelope";break;default:t+="fa-file-o"}return t},u.downloadDocument=function(t){a.getDocument(t.id).then(function(n){n.data?l.open("/storage/download?fileId="+t.id,"_blank"):d.create({content:e("translate")("Documents.NotFound"),className:"warning",timeout:6e3})})},u.getDownloadUrl=function(e){return c.apiUrl+"storage/download?fileID="+e.id+"&access_token="+r.read("access_token")},u.showLightBox=function(e,t){u.lightBox=!0,u.fileData=e,u.Index=t},l.addEventListener("keydown",function(e){switch(e.key){case"ArrowLeft":angular.element(document.getElementById("previous")).triggerHandler("click");break;case"ArrowRight":angular.element(document.getElementById("next")).triggerHandler("click");break;case"Escape":angular.element(document.getElementById("close-lightbox")).triggerHandler("click")}}),u.closeLightBox=function(){u.lightBox=!1}}]}}]).directive("documentForm",["config","guidEmpty","$localStorage","$filter","$q","ngToast","helper","FileUploader","resizeService","DocumentService","$timeout","$stateParams","$cookies",function(e,t,n,o,i,a,r,c,s,l,d,u){return{restrict:"EA",scope:{entityId:"=",entityType:"=",isAll:"=",show:"=",hideCloseButton:"=",hideUploadButton:"=",hideAllPanel:"=",customUploader:"=",entityIdFunc:"&",moduleId:"="},templateUrl:cdnUrl+"view/app/documents/documentForm.html",controller:["$scope","$timeout",function(e,t){function n(e){var t=i.defer(),n=new FileReader;return n.onload=function(e){t.resolve(e.target.result)},n.readAsDataURL(e),t.promise}e.documentCreating=!1;var d=e.$root.workgroup.tenant_id,m=e.entityId,p=u.type;e.module=o("filter")(e.$root.modules,{name:p},!0)[0];var f=e.module.id,g=e.uploader=e.customUploader||new c({url:"storage/upload_whole"});g.onCompleteItem=function(t,n,o){if(200===o){var i=n.unique_name,a=n.chunks,r=t.file.name,c=n.content_type,s=t._file.size,u="";e.customUploader?(m=e.entityIdFunc(),l.create(d,i,r,c,s,u,m,f,a)):l.create(d,i,r,c,s,u,m,f,a)}},e.customUploader||(g.onCompleteAll=function(){t(function(){e.isAll?l.getDocuments(d,m,f).then(function(t){var n=l.processDocuments(t.data,e.$root.users);e.$parent.documents=n.documentList,e.$parent.documentsResultSet.totalDocumentCount=t.data.total_documents_count}):l.getEntityDocuments(d,m,f).then(function(t){var n=l.processDocuments(t.data,e.$root.users);e.$parent.documents=n.documentList,e.$parent.documentsResultSet.totalDocumentCount=t.data.total_documents_count})},2e3)}),g.onWhenAddingFileFailed=function(e,t){switch(t.name){case"docFilter":a.create({content:o("translate")("Documents.FormatError"),className:"warning",timeout:8e3});break;case"sizeFilter":a.create({content:o("translate")("Documents.SizeError"),className:"warning",timeout:6e3});break;case"limitFilter":a.create({content:o("translate")("Documents.LimitError"),className:"warning",timeout:6e3})}},g.onAfterAddingFile=function(e){var t="|"+e.file.type.slice(e.file.type.lastIndexOf("/")+1)+"|";"|jpg|png|jpeg|bmp|gif".indexOf(t)>-1&&n(e._file).then(function(t){e.image=t;var n=new Image;n.onload=function(){n.width<=1024||s.resizeImage(e.image,{width:1024},function(t,n){t||(e._file=h(n),e.file.size=e._file.size)})},n.src=t})},g.filters.push({name:"docFilter",fn:function(e){var t=r.getFileExtension(e.name);if("mpp"===t)return!0;if("rar"===t)var n="|x-rar-compressed|";else if("zip"===t)var n="|zip|";else if("eml"===t)var n="|eml|";else if("msg"===t)var n="|msg|";else var n="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|msword|x-rar-compressed|zip|eml|msg|vnd.ms-excel|vnd.ms-powerpoint|vnd.openxmlformats-officedocument.wordprocessingml.document|vnd.openxmlformats-officedocument.wordprocessingml.template|vnd.openxmlformats-officedocument.spreadsheetml.sheet|vnd.openxmlformats-officedocument.presentationml.presentation|vnd.openxmlformats-officedocument.presentationml.template|vnd.openxmlformats-officedocument.presentationml.slideshow|rtf|pdf|plain|tiff|bmp|jpeg|jpg|png|gif|".indexOf(n)>-1}}),g.filters.push({name:"sizeFilter",fn:function(e){return e.size<10485760}});var h=function(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],o=[],i=0;i<t.length;i++)o.push(t.charCodeAt(i));return new Blob([new Uint8Array(o)],{type:n})}}]}}]).directive("lightboxDirective",function(){return{restrict:"E",transclude:!0,template:"<section ng-transclude></section>"}});