"use strict";angular.module("primeapps").controller("ExpenseController",["$rootScope","$scope","moment","$modal","$filter","$location","ModuleService","config","$http","$state","helper","ngToast",function(e,t,r,a,n,o,s,l,i,p,u,c){var d=t;t.module=n("filter")(e.modules,{name:"masraflar"},!0)[0],t.masrafItemModule=n("filter")(e.modules,{name:"masraf_kalemleri"},!0)[0],t.relationModule=n("filter")(t.module.relations,{related_module:"masraf_kalemleri"},!0)[0],t.owner=n("filter")(e.users,{Id:o.search().user?parseInt(o.search().user):e.user.ID},!0)[0],t.hasAdminRights=angular.copy(e.user.profile.has_admin_rights),t.currentMonth=r().month()+1,t.spinnerShow=!1,t.settings={},t.settingsCheck={},t.settingsCurrentYear=r().year(),t.yearsPicklist={},t.hasManuelProcess=!1,t.waitingForApproval=!1,t.manuelApproveRequest=!1,t.isApproved=!1,t.currentUser=s.processUser(e.user),t.masrafKalemleri=n("filter")(e.modules,{name:"masraf_kalemleri"},!0)[0],t.lookupTypes=n("filter")(t.masrafKalemleri.fields,{data_type:"lookup"},!0),t.ExpenseItemFreeze=!0,t.sendApproveShow=!1,t.Approved=!0,t.runProcess=!0,t.totalAmountShow=!1,t.urlId=o.search().id,t.ApproveFreeze=!0,t.showFullName=!1,t.payableTotalAmountShow=!1,t.AnyExpenseItemShow=!0,t.ExpenseItemFreezeYear=!0,t.automaticApprovelButtonShow=!0,t.labels=[];for(var m=0;m<t.relationModule.display_fields_array.length;m++){var f=t.relationModule.display_fields_array[m],h=n("filter")(t.masrafItemModule.fields,{name:f},!0)[0];h&&t.labels.push(h)}t.lookupTypeForLabel=n("filter")(t.labels,{data_type:"lookup"},!0),t.getExpenseItem=function(){if(t.currentExpense){var r={};r.fields=[],angular.forEach(t.masrafItemModule.fields,function(e){e.deleted||r.fields.push(e.name)}),angular.forEach(t.lookupTypes,function(e){angular.forEach(t.lookupTypeForLabel,function(t){e.name===t.name&&r.fields.push(t.name+"."+t.lookup_type+"."+t.lookupModulePrimaryField.name)})}),r.filters=t.urlId?[{field:"owner",operator:"equals",value:t.currentExpense.owner,no:1},{field:"masraf",operator:"equals",value:t.currentExpense.id,no:2}]:[{field:"owner",operator:"equals",value:t.owner.id,no:1},{field:"masraf",operator:"equals",value:t.currentExpense.id,no:2}],r.sort_field="created_at",r.sort_direction="desc",r.limit=2e3,s.findRecords("masraf_kalemleri",r).then(function(r){if(r.data.length>0){t.expense_items=n("orderBy")(r.data,"-faturafis_tarihi"),t.AnyExpenseItemShow=!1,t.sendApproveShow=!0;for(var a=0;a<r.data.length;a++){var o=r.data[a];angular.forEach(t.lookupTypeForLabel,function(e){o[e.name]&&null!==o[e.name]&&(o[e.name]=o[e.name+"."+e.lookup_type+"."+e.lookupModulePrimaryField.name])})}var l={};l.fields=[],angular.forEach(t.module.fields,function(e){e.deleted||l.fields.push(e.name)}),l.filters=t.urlId?[{field:"id",operator:"equals",value:t.urlId,no:1}]:[{field:"masraf_donemi_yil",operator:"equals",value:t.currentYear,no:1},{field:"masraf_donemi_ay",operator:"equals",value:t.selectCurrentMonth.label_tr,no:2},{field:"owner",operator:"equals",value:t.owner.id,no:3}],l.limit=1,s.findRecords("masraflar",l).then(function(r){var a=r.data[0];if(a&&t.selectCurrentMonth.labelStr==a.masraf_donemi_ay&&t.selectCurrentYear.labelStr==a.masraf_donemi_yil&&a.toplam_tutar>0&&(t.totalAmount=a.toplam_tutar,t.totalAmountShow=!0),a&&t.selectCurrentMonth.labelStr==a.masraf_donemi_ay&&t.selectCurrentYear.labelStr==a.masraf_donemi_yil&&a.odenecek_toplam_tutar&&a.odenecek_toplam_tutar>0&&(t.payableTotalAmount=a.odenecek_toplam_tutar,t.payableTotalAmountShow=!0),t.urlId){var o=n("filter")(t.monthList,{labelStr:a.masraf_donemi_ay})[0];t.filter={selectMonth:o},t.currentMonthSet="tr"===e.language?t.filter.selectMonth.label_tr:t.filter.selectMonth.label_en,t.ApproveFreeze=!1,t.showFullName=!0,t.ExpenseItemFreeze=3==t.currentExpense.process_status&&t.currentExpense.created_by===t.currentUser.id?!0:!1,a&&a.toplam_tutar&&a.toplam_tutar>0&&(t.totalAmount=a.toplam_tutar,t.totalAmountShow=!0),a&&a.odenecek_toplam_tutar&&a.odenecek_toplam_tutar>0&&(t.payableTotalAmount=a.odenecek_toplam_tutar,t.payableTotalAmountShow=!0)}setTimeout(function(){s.findRecords("masraflar",l).then(function(e){var r=e.data[0];r&&t.selectCurrentMonth.labelStr==r.masraf_donemi_ay&&t.selectCurrentYear.labelStr==r.masraf_donemi_yil&&r.toplam_tutar>0&&(t.totalAmount=r.toplam_tutar,t.totalAmountShow=!0),r&&t.selectCurrentMonth.labelStr==r.masraf_donemi_ay&&t.selectCurrentYear.labelStr==r.masraf_donemi_yil&&r.odenecek_toplam_tutar&&r.odenecek_toplam_tutar>0&&(t.payableTotalAmount=r.odenecek_toplam_tutar,t.payableTotalAmountShow=!0),t.spinnerShow=!1})},2e3)})}else t.expense_items=null,t.sendApproveShow=!1,t.totalAmountShow=!1,t.payableTotalAmountShow=!1,t.currentExpense.masraf_donemi_ay===t.selectCurrentMonth.labelStr&&(t.AnyExpenseItemShow=!0)})}else t.totalAmountShow=!1,t.payableTotalAmountShow=!1},s.getPicklists(t.module).then(function(r){t.monthList=r[11];var a=n("filter")(t.module.fields,{name:"masraf_donemi_yil"})[0];t.yearList=r[a.picklist_id],t.setMonth=n("filter")(t.monthList,{value:t.currentMonth})[0],t.yearsPicklist.selectYear=n("filter")(t.yearList,{labelStr:t.settingsCurrentYear.toString()})[0],t.filter={selectMonth:t.setMonth},t.currentMonthSet="tr"===e.language?t.filter.selectMonth.label_tr:t.filter.selectMonth.label_en,t.getExpenseSettings=function(){i.get(l.apiUrl+"settings/get_by_key/5/expense_settings").then(function(e){if(e.data){t.expenseSettingId=e.data.id;var r=n("filter")(t.monthList,{value:t.filter.selectMonth.value})[0];t.relatedSetting=angular.fromJson(e.data.value),t.settings=n("filter")(t.relatedSetting,{systemCode:r.value},!0)[0];var a=n("filter")(t.yearList,{labelStr:t.settingsCurrentYear.toString()},!0)[0];t.settings.expenseYear=a,t.settings.expenseMonth=t.filter.selectMonth,t.settingsCheck.expenseLastYearLastMonth=t.relatedSetting[12].LastYearLastMonth,t.settingsCheck.automaticApprovel=t.relatedSetting[13].AutomaticApprovel,t.expenseEntryEndDateControl(),t.ExpenseItemFreezeYear=t.settingsCurrentYear!=parseInt(t.yearsPicklist.selectYear.labelStr)?!1:!0;var o=t.relatedSetting[12].LastYearLastMonth,s=t.settingsCurrentYear-1,l=parseInt(t.filter.selectMonth.value),i=parseInt(t.yearsPicklist.selectYear.labelStr);o&&s==i&&12===l&&(t.ExpenseItemFreezeYear=!0);var p=t.relatedSetting[13].AutomaticApprovel;t.automaticApprovelButtonShow=p?!1:!0}})},t.getExpenseSettings(),t.monthListChange()}),t.expenseEntryEndDateControl=function(){if(Object.keys(t.settings).length>0){var e=t.currentYear.toString(),a=t.filter.selectMonth,o=r(t.settings.expenseEntryEndDate).format("YYYY-MM-DD"),s=n("date")(new Date,"yyyy-MM-dd"),l=r(s).format("YYYY-MM-DD");t.settings.expenseMonth.value===a.value&&t.settings.expenseYear.labelStr===e&&l>o?t.ExpenseItemFreeze=!1:t.urlId||(t.ExpenseItemFreeze=!0),t.currentExpense&&t.currentExpense.masraf_donemi_ay===a.labelStr&&t.currentExpense.masraf_donemi_yil===e&&(1===t.currentExpense.process_status||2===t.currentExpense.process_status)&&(t.ExpenseItemFreeze=!1)}},t.expenseApprovedControl=function(){if(Object.keys(t.settings).length>0){var e=t.currentYear.toString(),a=t.filter.selectMonth,o=r(t.settings.expenseProcessDate).format("YYYY-MM-DD"),s=n("date")(new Date,"yyyy-MM-dd"),l=r(s).format("YYYY-MM-DD");t.settings.expenseMonth.value===a.value&&t.settings.expenseYear.labelStr===e&&l>o?(c.create({content:n("translate")("Expenses.ExpenseApprovalExpired"),className:"warning"}),t.runProcess=!1):t.runProcess=!0}},t.monthListChange=function(){t.waitingForApproval=!1,t.sendApproveShow=!1,t.isApproved=!1,t.currentMonthSet="tr"===e.language?t.filter.selectMonth.label_tr:t.filter.selectMonth.label_en,t.selectCurrentYear=n("filter")(t.yearList,{labelStr:t.yearsPicklist.selectYear.labelStr})[0],t.selectCurrentMonth=n("filter")(t.monthList,{value:t.filter.selectMonth.value})[0],t.currentYear=parseInt(t.selectCurrentYear.labelStr),t.getExpenseSettings(),t.expenseEntryEndDateControl();var r={};r.fields=[],angular.forEach(t.module.fields,function(e){e.deleted||r.fields.push(e.name)}),r.filters=t.urlId?[{field:"id",operator:"equals",value:t.urlId,no:3}]:[{field:"masraf_donemi_yil",operator:"equals",value:t.currentYear,no:1},{field:"masraf_donemi_ay",operator:"equals",value:t.selectCurrentMonth.label_tr,no:2},{field:"owner",operator:"equals",value:t.owner.id,no:3}],r.limit=1,s.findRecords("masraflar",r).then(function(e){if(e.data.length<1){var r=t.owner.email,a={};a.fields=["id"],a.filters=[{field:"e_posta",operator:"is",value:r,no:1}],a.limit=1,s.findRecords("calisanlar",a).then(function(e){if(e.data.length>0){var r={};r.masraf_donemi_yil=t.selectCurrentYear.id,r.masraf_donemi_ay=t.selectCurrentMonth.id,r.calisan=e.data[0].id,r.owner=t.owner.id,r.toplam_tutar=0,s.insertRecord("masraflar",r).then(function(e){t.currentExpense=e.data,t.totalAmountShow=!1,t.payableTotalAmountShow=!1,t.expense_items=null,t.getExpenseItem()})}else c.create({content:n("translate")("Common.TimetrackerNotFound"),className:"warning"}),p.go("app.dashboard")})}else t.currentExpense=e.data[0],t.currentExpense&&t.selectCurrentMonth.labelStr==t.currentExpense.masraf_donemi_ay&&t.selectCurrentYear.labelStr==t.currentExpense.masraf_donemi_yil&&t.currentExpense.toplam_tutar>0&&(t.totalAmount=e.data[0].toplam_tutar,t.totalAmountShow=!0),t.currentExpense&&t.selectCurrentMonth.labelStr==t.currentExpense.masraf_donemi_ay&&t.selectCurrentYear.labelStr==t.currentExpense.masraf_donemi_yil&&e.data[0].odenecek_toplam_tutar&&e.data[0].odenecek_toplam_tutar>0&&(t.payableTotalAmount=e.data[0].odenecek_toplam_tutar,t.payableTotalAmountShow=!0),t.getExpenseItem(),t.getItems()})},t.yearListChange=function(){t.monthListChange()},t.getItems=function(){if(t.currentExpense){t.currentExpense.process_id=t.currentExpense["process.process_requests.process_id"],t.currentExpense.process_status=t.currentExpense["process.process_requests.process_status"],t.currentExpense.process_status_order=t.currentExpense["process.process_requests.process_status_order"],t.currentExpense.operation_type=t.currentExpense["process.process_requests.operation_type"],(t.currentExpense.process_status&&1===t.currentExpense.process_status||2===t.currentExpense.process_status)&&(t.ExpenseItemFreeze=!1);for(var r=0;r<e.approvalProcesses.length;r++){var a=e.approvalProcesses[r];a.module_id===t.module.id&&"manuel"===a.trigger_time&&(t.hasManuelProcess=!0)}t.currentExpense.process_status&&(2===t.currentExpense.process_status&&(t.isApproved=!0),(1===t.currentExpense.process_status||2===t.currentExpense.process_status||t.currentExpense.updated_by!==t.currentUser.id)&&(t.freeze=!0),s.getProcess(t.currentExpense.process_id).then(function(r){var a=t.currentExpense.custom_approver;if(a===e.user.email?(t.isApprovalRecord=!0,t.waitingForApproval=!1):a!==e.user.email&&1===t.currentExpense.process_status&&(t.waitingForApproval=!0,t.isApproved=!1,t.isApprovalRecord=!1),0===t.currentExpense.operation_type&&2===t.currentExpense.process_status)for(var n=0;n<r.data.operations_array.length;n++){var o=r.data.operations_array[n];"update"===o&&(t.freeze=!1)}1===t.currentExpense.operation_type&&2===t.currentExpense.process_status&&(t.freeze=!1)}))}else t.isApproved=!1,t.freeze=!1},t.openCreateModal=function(){t.content=[],t.content.push({text:"tr"===e.language?"Masraf":"Event",href:"",click:'openCreateModal(null, null, "masraflar")'});var r="masraf_kalemleri";t.currentLookupField={lookup_type:r},t.formModal=t.formModal||a({scope:t,templateUrl:"views/app/module/moduleFormModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.formModal.$promise.then(t.formModal.show)},t.openExpenseModal=function(e){t.type="masraf_kalemleri",t.id=e?e.id:null,t.formType="modal",t.item=e,t.editformModal=t.editformModal||a({scope:t,resolve:{plugins:["$$animateJs","$ocLazyLoad",function(e,t){return t.load([cdnUrl+"view/app/module/moduleFormModalController.js",cdnUrl+"view/app/product/quoteProductsController.js",cdnUrl+"view/app/module/moduleFormController.js",cdnUrl+"view/app/product/quoteProductsService.js",cdnUrl+"view/app/product/orderProductsController.js",cdnUrl+"view/app/product/orderProductsService.js",cdnUrl+"view/app/product/purchaseProductsController.js",cdnUrl+"view/app/product/purchaseProductsService.js",cdnUrl+"view/app/actionbutton/actionButtonFrameController.js",cdnUrl+"view/app/product/salesInvoiceProductsController.js",cdnUrl+"view/app/product/salesInvoiceProductsService.js",cdnUrl+"view/app/product/purchaseInvoiceProductsController.js",cdnUrl+"view/app/product/purchaseInvoiceProductsService.js"])}]},templateUrl:"view/app/module/moduleForm.html",backdrop:"static",show:!1,tag:"editModal",container:"body",controller:"ModuleFormController"}),t.editformModal.$promise.then(t.editformModal.show)},t.openExpenseDetailModal=function(e){t.type="masraf_kalemleri",t.freeze=!0,t.id=e?e.id:null,t.formType="modal",t.item=e,t.editformDetailModal=t.editformDetailModal||a({scope:t,resolve:{plugins:["$$animateJs","$ocLazyLoad",function(e,t){return t.load([cdnUrl+"view/app/module/moduleDetailController.js",cdnUrl+"view/pp/product/quoteProductsController.js",cdnUrl+"view/app/product/quoteProductsService.js",cdnUrl+"view/app/product/orderProductsController.js",cdnUrl+"view/app/product/orderProductsService.js",cdnUrl+"view/app/product/purchaseProductsController.js",cdnUrl+"view/app/product/purchaseProductsService.js",cdnUrl+"view/app/actionbutton/actionButtonFrameController.js",cdnUrl+"view/app/product/salesInvoiceProductsController.js",cdnUrl+"view/app/product/salesInvoiceProductsService.js",cdnUrl+"view/app/product/purchaseInvoiceProductsController.js",cdnUrl+"view/app/product/purchaseInvoiceProductsService.js"])}]},templateUrl:"view/app/module/moduleDetail.html",backdrop:"static",show:!1,tag:"editModal",container:"body",controller:"ModuleDetailController"}),t.editformDetailModal.$promise.then(t.editformDetailModal.show)},t.afterSave=function(){d.editformModal.hide(),t.spinnerShow=!0,t.getExpenseItem()},t.beforeSave=function(e){var a=r(e.faturafis_tarihi).format().split("+"),o=a[0],s=o.split("-"),l=s[1].split("0"),i=s[0],p=l[1];p||(p=l[0]);var u=t.filter.selectMonth.value,d=t.currentExpense.masraf_donemi_yil;p==u&&i==d?t.executeCode=!1:(t.executeCode=!0,c.create({content:n("translate")("Lütfen masraf dönemine ait masraf kalemi giriniz."),className:"warning"}))},t.expenseSettingsModal=function(){t.settingsFormModal=t.settingsFormModal||a({scope:t,templateUrl:"view/app/expensesheet/expenseSettingsModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.settingsFormModal.$promise.then(t.settingsFormModal.show)},t.expenseSubmitSettings=function(){if(t.settings){t.relatedSetting[t.settings.systemCode-1]=t.settings,t.relatedSetting[12].LastYearLastMonth=t.settingsCheck.expenseLastYearLastMonth,t.relatedSetting[13].AutomaticApprovel=t.settingsCheck.automaticApprovel;var e={key:"expense_settings",value:angular.toJson(t.relatedSetting),type:5};i.put(l.apiUrl+"settings/update/"+t.expenseSettingId,e).then(function(e){t.settings=e.data.value,c.create({content:n("translate")("Expenses.SettingsUpdate"),className:"success"}),t.getExpenseSettings()})}d.settingsFormModal.hide()},t.formModalSuccess=function(){t.getExpenseItem()},t["delete"]=function(e){t.spinnerShow=!0,s.deleteRecord("masraf_kalemleri",e).then(function(){c.create({content:n("translate")("Expenses.DeleteExpenseItem"),className:"success"}),t.getExpenseItem()})},t.sendToProcessApproval=function(){t.manuelApproveRequest=!0;var e=!0;if(e){var r={record_id:t.currentExpense.id,module_id:t.module.id};s.sendApprovalManuel(r).then(function(){t.hasManuelProcess=!1,t.waitingForApproval=!0,t.freeze=!0,t.manuelApproveRequest=!1,t.currentExpense.process_status=1,t.currentExpense.process_status_order++,1===t.currentExpense.process_status&&(t.ExpenseItemFreeze=!1)})["catch"](function(){t.manuelApproveRequest=!1})}else c.create({content:n("translate")("Common.CanNotSendToProcess",{minSaat:t.settings.dayMinHour}),className:"warning"}),t.manuelApproveRequest=!1},t.approveProcess=function(){t.runProcess&&(t.approving=!0,t.ExpenseItemFreeze=!1,s.approveProcessRequest(t.currentExpense.operation_type,t.module.name,t.currentExpense.id).then(function(){t.isApproved=!0,t.freeze=!0,t.approving=!1,t.currentExpense.process_status=2,t.waitingForApproval=!0})["catch"](function(){t.approving=!1}))},t.rejectProcess=function(e){t.runProcess&&(t.rejecting=!0,s.rejectProcessRequest(t.currentExpense.operation_type,t.module.name,e,t.currentExpense.id).then(function(){t.isRejectedRequest=!0,t.rejecting=!1,t.currentExpense.process_status=3,t.ExpenseItemFreeze=!0,t.rejectModal.hide()})["catch"](function(){t.rejecting=!1}))},t.reApproveProcess=function(){t.reapproving=!0;var e=!0;e?s.send_approval(t.currentExpense.operation_type,t.module.name,t.currentExpense.id).then(function(){t.waitingForApproval=!0,t.freeze=!0,t.reapproving=!1,t.currentExpense.process_status=1,t.currentExpense.process_status_order++,1===t.currentExpense.process_status&&(t.ExpenseItemFreeze=!1)})["catch"](function(){t.reapproving=!1}):(c.create({content:n("translate")("Common.CanNotSendToProcess",{minSaat:t.settings.dayMinHour}),className:"warning"}),t.reapproving=!1)},t.openRejectApprovalModal=function(){t.runProcess&&(t.rejectModal=t.rejectModal||a({scope:t,templateUrl:"view/app/module/rejectProcessModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.rejectModal.$promise.then(t.rejectModal.show))}}]);