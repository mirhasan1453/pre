"use strict";angular.module("primeapps").controller("CollectiveLeaveController",["$rootScope","$scope","ngToast","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","ModuleService","TemplateService","$timeout",function(e,i,a,t,r,l,n,s,o,d,c,u,_,m,p,f){i.loadingModal=!0,i.submittingModal=!1,i.type=s.type,i.module=t("filter")(e.modules,{name:i.type},!0)[0],i.picklistsModule=null,i.customLeaveFields={},i.record={},i.record.hesaplanan_alinacak_toplam_izin=0,i.submitted=!1;var h=null;m.getPicklists(i.module).then(function(e){if(i.picklistsModule=e,i.module&&"izinler"===i.module.name){var a=t("filter")(i.module.fields,{name:"to_entry_type"},!0)[0],r=t("filter")(i.module.fields,{name:"from_entry_type"},!0)[0];i.customLeaveFields.to_entry_type=a,i.customLeaveFields.from_entry_type=r,i.record.to_entry_type||i.record.from_entry_type||!a||(i.record.to_entry_type=e[a.picklist_id][0],i.record.from_entry_type=e[a.picklist_id][0])}}),m.findRecords("izin_turleri",{filters:[{field:"yillik_izin",operator:"equals",value:!0,no:1}],limit:999999,offset:0}).then(function(e){i.record.izin_turu_data=e.data[0],i.izinTuruData=e.data[0]});var y={};y.limit=99999,y.filters=null,y.fields=["e_posta","ad_soyad","dogum_tarihi","ise_baslama_tarihi","kalan_izin_hakki","yoneticisi"];var v=t("filter")(e.modules,{name:"calisanlar"},!0);0===v.length?(v=t("filter")(e.modules,{name:"human_resources"},!0)[0],y.fields.push("yoneticisi.human_resources.e_mail1"),h="yoneticisi.human_resources.e_mail1"):(v=v[0],y.fields.push("yoneticisi.calisanlar.e_posta"),h="yoneticisi.calisanlar.e_posta"),m.findRecords(v.name,y).then(function(e){i.calisanlar=e.data,i.loadingModal=!1}),i.fieldValueChange=function(){i.record.bitis_tarihi&&i.record.baslangic_tarihi&&m.setCustomCalculations(i.module,i.record,i.picklistsModule,i)},i.submitCollectiveLeave=function(){if(i.submittingModal=!0,i.submitted=!0,0===i.calisanlar.length)return a.create({content:t("translate")("Leave.NotFoundUser"),className:"warning"}),void(i.submittingModal=!1);i.notValidUser=[];for(var r=[],l=0;l<i.calisanlar.length;l++){var n=i.calisanlar[l];i.record.goreve_baslama_tarihi=n.ise_baslama_tarihi,i.record.mevcut_kullanilabilir_izin=n.kalan_izin_hakki;var s=angular.copy(i.record),o=m.customValidations(i.module,s);if(""!==o||void 0!==n["process.process_requests.process_id"]&&!n[h])i.notValidUser.push(n);else{var d=t("filter")(e.users,{Email:n.e_posta},!0)[0];if(d){var c={baslangic_tarihi:i.record.baslangic_tarihi,bitis_tarihi:i.record.bitis_tarihi,calisan:n.id,custom_approver:n[h],from_entry_type:i.record.from_entry_type.id,hesaplanan_alinacak_toplam_izin:i.record.hesaplanan_alinacak_toplam_izin,izin_turu:i.izinTuruData.id,mevcut_kullanilabilir_izin:n.kalan_izin_hakki,owner:d.id,shared_user_groups:null,shared_user_groups_edit:null,shared_users:null,shared_users_edit:null,to_entry_type:i.record.to_entry_type.id};m.insertRecord("izinler",c).then(function(e){if(r.push(e.data.id),i.calisanlar.length-i.notValidUser.length===r.length&&void 0!==n["process.process_requests.process_id"]){var a=function(){m.approveMultipleProcessRequest(r,"izinler").then(function(){i.submittingModal=!1})};f(a,5e3)}})}else i.notValidUser.push(n)}}}}]);