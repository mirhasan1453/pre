"use strict";angular.module("primeapps").controller("ModuleDetailController",["$rootScope","$scope","ngToast","$filter","helper","sipHelper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","entityTypes","operations","config","guidEmpty","$popover","$timeout","$modal","$sce","yesNo","activityTypes","transactionTypes","$anchorScroll","FileUploader","DocumentService","ModuleService","$http","components",function(e,t,o,r,a,n,i,s,l,d,u,c,p,m,f,_,h,v,g,y,M,w,P,F,k,b,S,T,A,D){if(t.type=l.type,t.id=i.search().id,t.parentType=i.search().ptype,t.parentId=i.search().pid,t.returnParentType=i.search().rptype,t.returnTab=i.search().rtab,t.previousParentType=i.search().pptype,t.previousParentId=i.search().ppid,t.previousReturnTab=i.search().prtab,t.returnPreviousParentType=i.search().rpptype,t.returnPreviousParentId=i.search().rppid,t.returnPreviousReturnTab=i.search().rprtab,t.back=i.search().back,t.module=r("filter")(e.modules,{name:t.type},!0)[0],t.operations=f,t.hasPermission=a.hasPermission,t.hasDocumentsPermission=a.hasDocumentsPermission,t.hasFieldDisplayPermission=T.hasFieldDisplayPermission,t.hasFieldFullPermission=T.hasFieldFullPermission,t.hasSectionDisplayPermission=T.hasSectionDisplayPermission,t.hasSectionFullPermission=T.hasSectionFullPermission,t.hasActionButtonDisplayPermission=T.hasActionButtonDisplayPermission,t.loading=!0,t.pdfUrl="",t.isDetail=!0,t.refreshSubModules={},t.editLookup={},t.tab="general",t.activityTypes=P,t.transactionTypes=F,t.lookupUser=a.lookupUser,t.isActive={},t.waitingForApproval=!1,t.isProcessRecord=!1,t.isApproved=!1,t.isRejectedRequest=!1,t.appId=e.user.appId,t.hasManuelProcess=!1,t.manuelApproveRequest=!1,t.freeze=i.search().freeze,t.currentModuleProcess=null,t.customHide=!1,t.googleMapsApiKey=googleMapsApiKey,t.currentSectionComponentsTemplate=currentSectionComponentsTemplate,t.scriptRunning={},!t.module)return o.create({content:r("translate")("Common.NotFound"),className:"warning"}),void s.go("app.dashboard");if(!t.id)return o.create({content:r("translate")("Common.NotFound"),className:"warning"}),void s.go("app.dashboard");D.run("BeforeDetailLoaded","script",t),t.setDropdownData=function(e){if(e.filters&&e.filters.length>0)t.dropdownFieldDatas[e.name]=null;else if(t.dropdownFieldDatas[e.name]&&t.dropdownFieldDatas[e.name].length>0)return;t.currentLookupField=e,t.lookup().then(function(o){t.dropdownFieldDatas[e.name]=o})},t.trustAsHtml=function(e){return M.trustAsHtml(e)},t.dropdownFields=r("filter")(t.module.fields,{data_type:"lookup",show_as_dropdown:!0},!0),t.dropdownFieldDatas={};for(var R=0;R<t.dropdownFields.length;R++)t.dropdownFieldDatas[t.dropdownFields[R].name]=[];t.tabconfig=t.module.detail_view_type?"flat"!=t.module.detail_view_type?!0:!1:"flat"!=e.detailViewType?!0:!1,t.returnPreviousParentType&&t.returnPreviousParentId!=t.id&&(t.parentType=angular.copy(t.returnPreviousParentType),t.parentId=angular.copy(t.returnPreviousParentId),t.returnTab=angular.copy(t.returnPreviousReturnTab));var z=function(){t.tabconfig?t.scrollHeightTab={height:u.innerHeight-255+"px"}:t.scrollHeight={height:u.innerHeight-165+"px"}};z(),angular.element(u).on("resize",function(){g(function(){z()})}),t.primaryField=r("filter")(t.module.fields,{primary:!0})[0],t.currentUser=T.processUser(e.user),t.currentDayMin=a.getCurrentDateMin().toISOString(),t.currentDayMax=a.getCurrentDateMax().toISOString(),t.currentHour=a.floorMinutes(new Date),t.entityTypes=m,t.guidEmpty=h,t.relatedToField=r("filter")(t.module.fields,{name:"related_to"},!0)[0],t.record={},t.allFields=[],t.showEditor=!1,t.isAdmin=e.user.profile.has_admin_rights;var L=r("filter")(t.modules,{name:"sales_invoices"},!0);t.salesInvoiceModule=L.length<1?!1:!0,angular.forEach(t.module.fields,function(e){T.hasFieldDisplayPermission(e)&&t.allFields.push(angular.copy(e))});for(var U=0;U<e.approvalProcesses.length;U++){var C=e.approvalProcesses[U];C.module_id===t.module.id&&(t.currentModuleProcess=C)}if(t.currentModuleProcess){var E=t.currentModuleProcess.profiles.split(",");t.hasProcessEditPermission=!1;for(var R=0;R<E.length;R++)E[R]===e.user.profile.id.toString()&&(t.hasProcessEditPermission=!0)}if(t.module.relations&&angular.forEach(t.module.relations,function(o){if(!o.deleted){var a=r("filter")(e.modules,{name:o.related_module},!0)[0],n={};if("activities"!==o.related_module&&"mails"!==o.related_module||"many_to_many"===o.relation_type)if("many_to_many"===o.relation_type){if(!a)return;var i=r("filter")(a.fields,{primary:!0},!0)[0],l=o.related_module+"_id."+o.related_module+"."+i.name;n={fields:["total_count()",l],filters:[{field:t.module.name+"_id",operator:"equals",value:t.id,no:1}],limit:1,offset:0,many_to_many:t.module.name}}else n={fields:["total_count()"],filters:[{field:o.relation_field,operator:"equals",value:t.id,no:1}],limit:1,offset:0};else n={fields:["total_count()"],filters:[{field:o.relation_field,operator:"equals",value:t.id,no:1},{field:"related_module",operator:"is",value:t.module["label_"+e.user.tenant_language+"_singular"],no:1}],limit:1,offset:0};T.findRecords(o.related_module,n).then(function(e){var r=e.data;r[0]&&r[0].total_count?o.total=r[0].total_count:delete o.total,"flat"===o.detail_view_type&&(t.changeTab(o),t.returnParentType==o.id&&(t.activeType="tab",t.tab="general"))}).then(function(){t.isActive[s.params.rptype]=!0})}}),t.parentType){if("activities"===t.type||"mails"===t.type||t.many)t.parentModule=t.parentType;else{var I=r("filter")(t.module.fields,{name:t.parentType},!0)[0];I?t.parentModule=I.lookup_type:(t.parentModule=t.parentType,t.returnType="general")}t.previousParentType||(t.previousParentType=angular.copy(t.parentType),t.previousParentId=angular.copy(t.parentId),!t.previousReturnTab&&t.returnTab&&(t.previousReturnTab=angular.copy(t.returnTab)))}t.module.default_tab&&(t.tab=t.module.default_tab),t.returnParentType&&(t.tab=t.returnParentType,t.tabconfig||(t.isActive[t.returnParentType]=!0,i.hash("relation"+t.returnParentType),k()));var N=function(){if("izinler"===t.module.name&&(t.hasManuelProcess&&(t.record.owner.id===t.currentUser.id||t.hasProcessRights)&&!t.record.process_id||3===t.record.process_status&&t.record.owner.id===t.currentUser.id&&!t.waitingForApproval)&&t.record.izin_turu){var e=moment().date(1).month(1).year(moment().year()).format("YYYY-MM-DD");if(t.record.goreve_baslama_tarihi=t.record.calisan.ise_baslama_tarihi,t.record.izin_turu_data=t.record.izin_turu,t.record.dogum_tarihi=t.record.calisan.dogum_tarihi,t.record.calisan_data=t.record.calisan,t.record.izin_turu_data.yillik_izin){var o=moment(t.record.calisan_data.ise_baslama_tarihi),r=o.get("date"),a=o.get("month"),n=moment().get("year"),i=moment().date(r).month(a).year(n).format("YYYY-MM-DD");moment(i).isAfter(moment().format("YYYY-MM-DD"))&&(n-=1),e=moment().date(r).month(a).year(n).format("YYYY-MM-DD")}t.record.izin_turu_data.her_ay_yenilenir&&(e=moment().date(1).month(moment().month()).year(moment().year()).format("YYYY-MM-DD"));var s={fields:["hesaplanan_alinacak_toplam_izin","baslangic_tarihi","bitis_tarihi","izin_turu","process.process_requests.process_status","system_code"],filters:[{field:"calisan",operator:"equals",value:t.record.calisan.id,no:1},{field:"baslangic_tarihi",operator:"greater_equal",value:e,no:2},{field:"deleted",operator:"equals",value:!1,no:3},{field:"process.process_requests.process_status",operator:"not_equal",value:3,no:4}],limit:999999};T.findRecords("izinler",s).then(function(e){e.data.length>0&&(t.record.alinan_izinler=e.data)})}};t.picklistFilter=function(){return function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,D.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result}},T.getPicklists(t.module).then(function(a){t.picklistsModule=a,T.getRecord(t.module.name,t.id).then(function(a){0===Object.keys(a.data).length&&(o.create({content:r("translate")("Common.Forbidden"),className:"warning"}),s.go("app.dashboard")),"activities"!=t.module.name&&angular.forEach(t.module.fields,function(e){T.setDependency(e,t.module,t.record,t.picklistsModule),e.default_value&&"picklist"==e.data_type&&(t.record[e.name]=r("filter")(t.picklistsModule[e.picklist_id],{id:e.default_value})[0],t.fieldValueChange(e))});for(var n=T.processRecordSingle(a.data,t.module,t.picklistsModule),i=0;i<e.approvalProcesses.length;i++){var l=e.approvalProcesses[i];l.module_id===t.module.id&&"manuel"===l.trigger_time&&(t.hasManuelProcess=!0),l.module_id===t.module.id&&(t.currentModuleProcess=l)}for(var d=0;d<t.module.fields.length;d++){var u=t.module.fields[d],c=!1;if(u.encrypted&&u.encryption_authorized_users_list.length>0&&n[u.name])for(var p=0;p<u.encryption_authorized_users_list.length;p++){var m=u.encryption_authorized_users_list[p];e.user.id==parseInt(m)&&(c=!0)}u.show_lock=u.encrypted&&!c?!0:!1}if(n.process_status&&(2===n.process_status&&(t.isApproved=!0),(1===n.process_status||2===n.process_status||3===n.process_status&&n.updated_by.id!=t.currentUser.id)&&(n.freeze=!0),T.getProcess(n.process_id).then(function(o){var a=o.data.approvers;if(a.length>0){var i=r("filter")(a,{id:t.currentUser.id},!0)[0];i||3===n.process_status||(t.waitingForApproval=!0),i&&(i.order===n.process_status_order?t.isApprovalRecord=!0:3!==n.process_status&&(t.waitingForApproval=!0))}else if(1===n.process_status_order){var s=n.custom_approver;s===e.user.email?t.isApprovalRecord=!0:s!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(2===n.process_status_order){var l=n.custom_approver_2;l===e.user.email?t.isApprovalRecord=!0:l!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(3===n.process_status_order){var d=n.custom_approver_3;d===e.user.email?t.isApprovalRecord=!0:d!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(4===n.process_status_order){var u=n.custom_approver_4;u===e.user.email?t.isApprovalRecord=!0:u!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(5===n.process_status_order){var c=n.custom_approver_5;c===e.user.email?t.isApprovalRecord=!0:c!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}if(0===n.operation_type&&2===n.process_status)for(var p=0;p<o.data.operations_array.length;p++){var m=o.data.operations_array[p];"update"===m&&(n.freeze=!1)}1===n.operation_type&&2===n.process_status&&(n.freeze=!1),"izinler"===t.module.name&&N()})),t.module.dependencies.length>0){var f=r("filter")(t.module.dependencies,{dependency_type:"freeze"},!0);angular.forEach(f,function(e){var o=r("filter")(t.module.fields,{name:e.parent_field},!0);angular.forEach(o,function(t){angular.forEach(e.values_array,function(e){!n[t.name]||e!=n[t.name]&&e!=n[t.name].id||(n.freeze=!0)})})})}if(t.freeze&&(n.freeze=!0),null!==t.currentModuleProcess){if(t.currentModuleProcess.profile_list&&t.currentModuleProcess.profile_list.length>0)for(var _=0;_<t.currentModuleProcess.profile_list.length;_++){var h=t.currentModuleProcess.profile_list[_];parseInt(h)===e.user.profile.id&&(n.freeze=!1)}e.user.profile.has_admin_rights&&(n.freeze=!1)}T.formatRecordFieldValues(angular.copy(a.data),t.module,t.picklistsModule),t.title=t.primaryField.valueFormatted;var v=function(o){t.record=o,t.recordState=angular.copy(t.record),T.setDisplayDependency(t.module,t.record),t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol),D.run("AfterRecordLoaded","Script",t,t.record),t.currentModuleProcess&&t.currentModuleProcess.profile_list&&(t.hasProcessRights=t.currentModuleProcess.profile_list.indexOf(e.user.profile.ID.toString())>-1?!0:!1),"izinler"===t.module.name&&N()};if(T.getActionButtons(t.module.id).then(function(e){t.actionButtons=r("filter")(e,function(e){return"List"!==e.trigger&&"Form"!==e.trigger&&"Relation"!==e.trigger},!0),angular.forEach(t.actionButtons,function(e){e.isShown=!1,e.dependent_field?n[e.dependent_field]&&n[e.dependent_field].labelStr==e.dependent&&(e.isShown=!0):e.isShown=!0})}),t.relatedToField&&n.related_to&&n[t.relatedToField.lookup_relation]){var g=r("filter")(e.modules,{id:n[t.relatedToField.lookup_relation].id-9e5},!0)[0],y=r("filter")(g.fields,{primary:!0},!0)[0];T.getRecord(g.name,n.related_to,!0).then(function(e){e=e.data,e.primary_value=e[y.name],n.related_to=e,v(n),t.loading=!1})["catch"](function(e){404===e.status&&(n.related_to=null,v(n)),t.loading=!1})}else v(n),t.loading=!1})["catch"](function(){t.loading=!1}),t.yesNo=T.getYesNo(w)}),t.changeTab=function(e){"flat"!=e.detail_view_type?(t.tab=e.id.toString(),t.activeType="flat"):t.activeType="tab",t.isActive=[],t.isActive[e.id]=!0},t.lookup=function(o){if("users"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="full_name",t.currentLookupField.lookupModulePrimaryField=a}if("profiles"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="name",t.currentLookupField.lookupModulePrimaryField=a}if("roles"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="label_"+e.user.tenantLanguage,t.currentLookupField.lookupModulePrimaryField=a}if("relation"===t.currentLookupField.lookup_type){if(!t.record.related_module)return t.$broadcast("angucomplete-alt:clearInput",t.currentLookupField.name),d.defer().promise;var n=r("filter")(e.modules,{name:t.record.related_module.value},!0)[0];if(!n)return t.$broadcast("angucomplete-alt:clearInput",t.currentLookupField.name),d.defer().promise;t.currentLookupField.lookupModulePrimaryField=r("filter")(n.fields,{primary:!0},!0)[0]}return"number"!==t.currentLookupField.lookupModulePrimaryField.data_type&&"number_auto"!==t.currentLookupField.lookupModulePrimaryField.data_type||!isNaN(parseFloat(o))?T.lookup(o,t.currentLookupField,t.record):(t.$broadcast("angucomplete-alt:clearInput",t.currentLookupField.name),d.defer().promise)},t.multiselect=function(e,o){var r=[];return angular.forEach(t.picklistsModule[o.picklist_id],function(t){t.inactive||t.hidden||(t.labelStr.toLowerCase().indexOf(e.toLowerCase())>-1||t.labelStr.toUpperCase().indexOf(e.toUpperCase())>-1||t.labelStr.toLowerCaseTurkish().indexOf(e.toLowerCaseTurkish())>-1||t.labelStr.toUpperCaseTurkish().indexOf(e.toUpperCaseTurkish())>-1)&&r.push(t)}),r},t.setCurrentLookupField=function(e){t.currentLookupField=e},t.validate=function(e,t,o){if(o){if(o.required&&!e)return r("translate")("Module.Required");if("lookup"===t&&e&&"object"!=typeof e)return r("translate")("Module.RequiredAutoCompleteError");if("email"===t&&e){var a=/^[a-z0-9!#$%&'*+\/=?^_`{|}~.-]+@[a-z0-9]([a-z0-9-]*[a-z0-9])?(\.[a-z0-9]([a-z0-9-]*[a-z0-9])?)*$/i;if(!a.test(e))return r("translate")("Module.EmailInvalid")}if("url"===t&&e){var n=/(http|https|file|ftp):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;if(!n.test(e))return r("translate")("Module.UrlInvalid")}if("checkbox"===t&&void 0===e&&(e=!1),o.min&&e){var i=parseFloat(e),s=parseFloat(o.min);if(s>i)return r("translate")("Module.MinError")}if(o.min&&e){var l=parseFloat(e),d=parseFloat(o.max);if(d>l)return r("translate")("Module.MaxError")}return o.min_length&&e&&e.length<o.min_length?r("translate")("Module.MinLengthError"):!0}},t.update=function(){t.updating=!0;var a=T.prepareRecord(t.record,t.module,t.recordState);a.activity_type_system&&delete a.activity_type_system,a.transaction_type_system&&delete a.transaction_type_system,T.updateRecord(t.module.name,a).then(function(o){var a=function(){t.recordState=angular.copy(t.record),B(),angular.forEach(t.actionButtons,function(e){e.isShown=!1,e.dependent_field?o[e.dependent_field]&&o[e.dependent_field]==e.dependent&&(e.isShown=!0):e.isShown=!0})},n=r("filter")(e.approvalProcesses,{module_id:t.module.id},!0);if(n){for(var i=!1,s=0;s<n.length;s++)(0===n[s].user_id||n[s].user_id===t.currentUser.id)&&n[s].operations.indexOf("update")>-1&&(i=!0);i&&3!==t.record.process_status?(t.record.freeze=!0,setTimeout(function(){T.getRecord(t.module.name,t.record.id).then(function(a){var n=T.processRecordSingle(a.data,t.module,t.picklistsModule);if(n.process_status&&(2===n.process_status?t.isApproved=!0:1===n.process_status&&(t.isApproved=!1),(1===n.process_status||2===n.process_status||3===n.process_status&&n.created_by.id!=t.currentUser.id)&&(n.freeze=!0),T.getProcess(n.process_id).then(function(o){var a=o.data.approvers;if(a.length>0){var i=r("filter")(a,{id:t.currentUser.id},!0)[0];i||3===n.process_status||(t.waitingForApproval=!0),i&&(i.order===n.process_status_order?t.isApprovalRecord=!0:3!==n.process_status&&(t.waitingForApproval=!0))}else if(1===n.process_status_order){var s=n.custom_approver;s===e.user.email?t.isApprovalRecord=!0:s!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(2===n.process_status_order){var l=n.custom_approver_2;l===e.user.email?t.isApprovalRecord=!0:l!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(3===n.process_status_order){var d=n.custom_approver_3;d===e.user.email?t.isApprovalRecord=!0:d!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(4===n.process_status_order){var u=n.custom_approver_4;u===e.user.email?t.isApprovalRecord=!0:u!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(5===n.process_status_order){var c=n.custom_approver_5;c===e.user.email?t.isApprovalRecord=!0:c!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}if(0===n.operation_type&&2===n.process_status)for(var p=0;p<o.data.operations_array.length;p++){var m=o.data.operations_array[p];"update"===m&&(n.freeze=!1)}1===n.operation_type&&2===n.process_status&&(n.freeze=!1)})),t.module.dependencies.length>0){var i=r("filter")(t.module.dependencies,{dependency_type:"freeze"},!0);angular.forEach(i,function(e){var o=r("filter")(t.module.fields,{name:e.parent_field},!0);angular.forEach(o,function(t){angular.forEach(e.values_array,function(e){!n[t.name]||e!=n[t.name]&&e!=n[t.name].id||(n.freeze=!0)})})})}if(null!==t.currentModuleProcess&&t.currentModuleProcess.profile_list&&t.currentModuleProcess.profile_list.length>0)for(var s=0;s<t.currentModuleProcess.profile_list.length;s++){var l=t.currentModuleProcess.profile_list[s];parseInt(l)===e.user.profile.id&&(n.freeze=!1)}T.formatRecordFieldValues(angular.copy(a.data),t.module,t.picklistsModule),t.title=t.primaryField.valueFormatted;var d=function(o){t.record=o,t.recordState=angular.copy(t.record),T.setDisplayDependency(t.module,t.record),t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol),getProducts(t.type)};if(angular.forEach(t.actionButtons,function(e){e.isShown=!1,e.dependent_field?o[e.dependent_field]&&o[e.dependent_field]==e.dependent&&(e.isShown=!0):e.isShown=!0}),t.relatedToField&&n.related_to){var u=r("filter")(e.modules,{id:n[t.relatedToField.lookup_relation].id-9e5},!0)[0],c=r("filter")(u.fields,{primary:!0},!0)[0];T.getRecord(u.name,n.related_to,!0).then(function(e){e=e.data,e.primary_value=e[c.name],n.related_to=e,d(n),t.updating=!1})["catch"](function(e){404===e.status&&(n.related_to=null,d(n)),t.updating=!1})}else d(n),t.updating=!1})["catch"](function(){t.updating=!1})},2e3)):a()}else a()})["catch"](function(e,a){409===a&&(o.create({content:r("translate")("Module.UniqueError"),className:"danger"}),t.record[e.field]=t.recordState[e.field])})},t["delete"]=function(){t.executeCode=!1,D.run("BeforeDelete","Script",t,t.record),t.executeCode||T.deleteRecord(t.module.name,t.record.id).then(function(){return D.run("AfterDelete","Script",t,t.record),B(),t.parentId?void s.go("app.moduleDetail",{type:t.parentModule,id:t.parentId}):void s.go("app.moduleList",{type:t.type})})};var B=function(){var o=t.module.name+"_"+t.module.name;if(t.parentId){o=(t.relatedToField?"related_to":t.parentType)+t.parentId+"_"+t.module.name;var r=t.parentType+"_"+t.parentType;p.remove(o),p.remove(r)}else p.remove(o),"opportunities"===t.module.name&&p.remove("opportunity"+t.id+"_stage_history");e.activePages&&e.activePages[t.module.name]&&(e.activePages[t.module.name]=null),(t.module.display_calendar||"activities"===t.module.name)&&p.remove("calendar_events")};if(t.calculate=function(e){T.calculate(e,t.module,t.record)},t.fieldValueChange=function(o){T.setDependency(o,t.module,t.record,t.picklistsModule),t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol)},t.reformatFieldValues=function(){T.formatRecordFieldValues(t.record,t.module,t.picklistsModule)},t.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"!==e.lookup_type||t.record.related_module?!1:!0},t.openFormModal=function(e){t.primaryValueModal=e,t.formModalShown=!0,t.formModal=t.formModal||y({scope:t,templateUrl:"view/app/module/moduleFormModal.html",animation:"",backdrop:"static",show:!1,tag:"formModal"}),t.formModal.$promise.then(t.formModal.show)},t.$on("modal.hide",function(e,o){"formModal"==o.$options.tag&&(t.formModalShown=!1,"object"!=typeof t.record[t.currentLookupField.name]?t.lookupFocusOut():(delete t.editLookup[t.currentLookupField.name],t.update())),"relatedModuleInModal"==o.$options.tag&&(t.selectedRelatedModule.relatedModuleInModal=!1)}),t.lookupFocusOut=function(){g(function(){t.formModalShown||t.updating||(t.record[t.currentLookupField.name]=t.recordState[t.currentLookupField.name],t.$broadcast("angucomplete-alt:changeInput",t.currentLookupField.name,t.recordState[t.currentLookupField.name]),delete t.editLookup[t.currentLookupField.name])},200)},t.getAttachments=function(){a.hasDocumentsPermission(t.operations.read)&&S.getEntityDocuments(e.workgroup.tenant_id,t.id,t.module.id).then(function(o){t.documentsResultSet=S.processDocuments(o.data,e.users),t.documents=t.documentsResultSet.documentList,t.loadingDocuments=!1})},t.showActivityButtons=function(){t.activityButtonsPopover=t.activityButtonsPopover||v(angular.element(document.getElementById("activityButtons")),{templateUrl:"view/common/newactivity.html",placement:"bottom",autoClose:!0,scope:t,show:!0})},t.showTransactionButtons=function(){t.transactionButtonsPopover=t.transactionButtonsPopover||v(angular.element(document.getElementById("transactionButtons")),{templateUrl:"view/common/newtransaction.html",placement:"bottom",autoClose:!0,scope:t,show:!0})},t.getCurrentTime=function(){var e=new Date;return e.getTime()},t.openExportDialog=function(){t.pdfCreating=!0;var a=function(){t.PdfModal=t.PdfModal||y({scope:t,templateUrl:"view/app/module/modulePdfModal.html",animation:"",backdrop:"static",show:!1}),t.PdfModal.$promise.then(t.PdfModal.show)};t.quoteTemplates&&(a(),t.quoteTemplate=t.quoteTemplates[0]),T.getTemplates(t.module.name,"module").then(function(n){if(0==n.data.length)o.create(e.preview?{content:r("translate")("Setup.Templates.TemplateDefined"),className:"warning"}:{content:r("translate")("Setup.Templates.TemplateNotFound"),className:"warning"}),t.pdfCreating=!1;else{var i=n.data;t.quoteTemplates=r("filter")(i,{active:!0},!0),t.isShownWarning=!0;for(var s=0;s<t.quoteTemplates.length;s++){var l=t.quoteTemplates[s];if(l.permissions.length>0){var d=r("filter")(l.permissions,{profile_id:e.user.profile.id},!0)[0];l.isShown="none"===d.type?!1:!0,1==l.isShown&&(t.isShownWarning=!1)}else l.isShown=!0,t.isShownWarning=!1}t.quoteTemplate=t.quoteTemplates[0],t.PdfModal=t.PdfModal||y({scope:t,templateUrl:"view/app/module/modulePdfModal.html",animation:"",backdrop:"static",show:!1}),a()}})["catch"](function(){t.pdfCreating=!1})},t.getDownloadUrl=function(a){u.open("/attach/export?module="+t.type+"&id="+t.id+"&templateId="+t.quoteTemplate.id+"&access_token="+c.read("access_token")+"&format="+a+"&locale="+e.locale+"&timezoneOffset="+-1*(new Date).getTimezoneOffset(),"_blank"),o.create({content:r("translate")("Module.ExcelDesktop"),className:"success"})},t.openAddModal=function(e){t.selectedRelatedModule=e,t.selectedRelatedModule.relatedModuleInModal=!0,t.addModal=t.addModal||y({scope:t,templateUrl:"view/app/module/moduleAddModal.html",animation:"",backdrop:"static",show:!1,tag:"relatedModuleInModal"}),t.addModal.$promise.then(t.addModal.show)},t.showEMailModal=function(o,r){if(!e.system.messaging.SystemEMail&&!e.system.messaging.PersonalEMail){var a="mailto:"+r,n=u.open(a,"_blank");return void(n.document.title="Ofisim.com")}t.mailModal=t.mailModal||y({scope:t,templateUrl:"view/app/email/singleEmailModal.html",backdrop:"static",show:!1}),o||t.mailModal.$promise.then(t.mailModal.show)},t.showQuoteEMailModal=function(a){return e.system.messaging.SystemEMail||e.system.messaging.PersonalEMail?(t.mailModal=t.mailModal||y({scope:t,templateUrl:"view/app/email/singleEmailModal.html",backdrop:"static",show:!1}),void(a||t.mailModal.$promise.then(t.mailModal.show))):void o.create({content:r("translate")("EMail.NoProvider"),className:"warning"})},t.showSingleSMSModal=function(){return e.system.messaging.SMS?(t.smsModal=t.smsModal||y({scope:t,templateUrl:"view/app/sms/singleSMSModal.html",backdrop:"static",show:!1}),void t.smsModal.$promise.then(t.smsModal.show)):void o.create({content:r("translate")("SMS.NoProvider"),className:"warning"})},t.showModuleFrameModal=function(e){if(new RegExp("https:").test(e)){var o,r,a;o="myPop1",r=document.body.offsetWidth-200,a=document.body.offsetHeight-200;var n=screen.width/2-r/2,i=screen.height/2-a/2;window.open(e,o,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+r+", height="+a+", top="+i+", left="+n)}else t.frameUrl=e,t.frameModal=t.frameModal||y({scope:t,controller:"ActionButtonFrameController",templateUrl:"view/app/actionbutton/actionButtonFrameModal.html",backdrop:"static",show:!1}),t.frameModal.$promise.then(t.frameModal.show)},t.dropdownHide=function(){angular.element(document.getElementsByClassName("dropdown-menu"))[0].click(),angular.element(document.getElementsByClassName("dropdown-menu"))[1].click()},t.documentDownload=function(e){u.location="/storage/record_file_download?fileName="+e},t.showTransactionButtons=function(){t.transactionButtonsPopover=t.transactionButtonsPopover||v(angular.element(document.getElementById("transactionButtons")),{templateUrl:"view/common/newtransaction.html",placement:"bottom",autoClose:!0,scope:t,show:!0})},t.getmoduledownloadurl=function(e,o){return e?_.apiUrl+"Document/download_module_document?module="+t.module.name+"&fileNameExt="+a.getFileExtension(e)+"&fileName="+e+"&fieldName="+o+"&recordId="+t.record.id+"&access_token="+c.read("access_token"):void 0},t.showHideSipPhone=function(t){function a(t){var a=e.sipUser.session;a?o.create({content:r("translate")("Phone.AlreadyInCall"),className:"warning"}):(e.sipUser.numberToDial=t,e.sipUser.numberToDial.length>2?(e.sipUser.lineInfo.PhoneStatus=r("translate")("Setup.Phone.Dialing"),e.sipUser.lineInfo.State="Dialing",e.sipUser.lineInfo.TalkingNumber=e.sipUser.numberToDial,n.dial(e.sipUser.lineInfo.TalkingNumber,!1),e.sipUser.activePhoneScreen="connectingScreen"):o.create({content:r("translate")("Phone.NoNumber"),className:"warning"}))}e.sipUser&&e.sipPhone&&e.sipPhone[e.app]?(e.sipUser.lineInfo.State="Dialing",a(t),e.sipPhone.crm.show()):g(function(){e.sipPhone?e.sipPhone.crm.show():e.showSipPhone("call"),a(t)},1e3)},t.showLightBox=function(e){t.lightBox=!0,t.ImageUrl=e},t.closeLightBox=function(){t.lightBox=!1},t.openLocationModal=function(e){t.filedName=e,t.locationModal=t.frameModal||y({scope:t,controller:"locationFormModalController",templateUrl:"view/app/location/locationFormModal.html",backdrop:"static",show:!1}),t.locationModal.$promise.then(t.locationModal.show)},t.webhookRequest=function(e){var e=angular.copy(e),a=new XMLHttpRequest;a.onreadystatechange=function(){4==this.readyState&&(g(function(){t.webhookRequesting[e.id]=!1}),o.create(200==this.status?{content:r("translate")("Module.ActionButtonWebhookSuccess"),className:"success"}:{content:r("translate")("Module.ActionButtonWebhookFail"),className:"warning"}))};var n={},i=e.parameters.split(",");if(t.webhookRequesting={},t.webhookRequesting[e.id]=!0,angular.forEach(i,function(e){var o=e.split("|"),r=o[0],a=o[1],i=o[2];n[r]=a!=t.module.name?t.record[a]?t.record[a][i]:null:t.record[i]?t.record[i]:null}),"post"===e.method_type)a.open("POST",e.url,!0),e.url.indexOf(window.location.host)>-1&&a.setRequestHeader("Authorization","Bearer "+c.read("access_token")),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify(n));else if("get"===e.method_type){var s="";for(var l in n)s+=l+"="+n[l]+"&";s.length>0&&(s=s.substring(0,s.length-1)),e.url+=e.url.indexOf("?")<0?"?":"&",a.open("GET",e.url+s,!0),e.url.indexOf(window.location.host)>-1&&a.setRequestHeader("Authorization","Bearer "+c.read("access_token")),a.send()}},t.approveProcess=function(){t.executeCode=!1,D.run("BeforeApproveProcess","Script",t),t.executeCode||(t.approving=!0,T.approveProcessRequest(t.record.operation_type,t.module.name,t.record.id).then(function(e){"approved"===e.data.status?(t.isApproved=!0,t.record.freeze=!0,D.run("AfterApproveProcess","Script",t)):t.record.process_status_order++,t.approving=!1,t.waitingForApproval=!0})["catch"](function(){t.approving=!1}))},t.rejectProcess=function(e){t.executeCode=!1,D.run("BeforeRejectProcess","Script",t),t.executeCode||(t.rejecting=!0,T.rejectProcessRequest(t.record.operation_type,t.module.name,e,t.record.id).then(function(){t.isRejectedRequest=!0,t.rejecting=!1,t.record.process_status=3,t.rejectModal.hide()})["catch"](function(){t.rejecting=!1}))},t.reApproveProcess=function(){t.reapproving=!0,T.send_approval(t.record.operation_type,t.module.name,t.record.id).then(function(){t.waitingForApproval=!0,t.record.freeze=!0,t.reapproving=!1,t.record.process_status=1,t.record.process_status_order++})["catch"](function(){t.reapproving=!1})},t.openRejectApprovalModal=function(){t.rejectModal=t.rejectModal||y({scope:t,templateUrl:"view/app/module/rejectProcessModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.rejectModal.$promise.then(t.rejectModal.show)},t.sendToProcessApproval=function(){if(t.executeCode=!1,D.run("BeforeSendToProcessApproval","Script",t,t.record),!t.executeCode){if("izinler"===t.module.name){var e="";if(t.skipValidation||(e=T.customValidations(t.module,t.record)),""!=e)return void o.create({content:e,className:"warning",timeout:8e3})}t.manuelApproveRequest=!0;var a={record_id:t.record.id,module_id:t.module.id};T.sendApprovalManuel(a).then(function(){D.run("AfterSendToProcessApproval","Script",t,t.record),t.hasManuelProcess=!1,t.waitingForApproval=!0,t.record.freeze=!0,t.manuelApproveRequest=!1,t.record.process_status=1,t.record.process_status_order++})["catch"](function(e){t.manuelApproveRequest=!1,400===e.status&&(e.data.model_state&&e.data.model_state.filters_not_match&&o.create({content:r("translate")("Common.FiltersNotMatched"),className:"warning"}),e.data.model_state&&e.data.model_state.approver_not_found&&o.create({content:r("translate")("Common.ApproverNotFound"),className:"warning"}))})}},t.convertSalesOrder=function(){var a={};a.sales_order_id=t.id,a.deleted=!1,T.convertSalesInvoice(a).then(function(a){t.converted=a.data,t.convertDisable=!0,o.create({content:r("translate")("Convert.Success",{type:t.module["label_"+e.language+"_singular"]}),className:"success"}),u.location.href="#/app/module/sales_invoices?id="+a.data.sales_invoice_id+"&back=sales_orders"})["catch"](function(e){409===e.status&&t.moduleForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){t.loading=!1})},t.convertPurchaseOrder=function(){var a={};a.purchase_order_id=t.id,a.deleted=!1,T.convertPurchaseInvoice(a).then(function(a){t.converted=a.data,t.convertDisable=!0,o.create({content:r("translate")("Convert.Success",{type:t.module["label_"+e.language+"_singular"]}),className:"success"}),u.location.href="#/app/module/purchase_invoices?id="+a.data.purchase_invoice_id+"&back=purchase_orders"})["catch"](function(e){409===e.status&&t.moduleForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){t.loading=!1})},t.module.relations.length>0){t.relationActionButtons=[];
var q=r("filter")(t.module.relations,{deleted:!1},!0),x=function(e){e.isShown=!1,e.dependent_field?record[e.dependent_field]&&record[e.dependent_field].labelStr==e.dependent&&(e.isShown=!0):e.isShown=!0};if(q.length>0)for(var R=0;R<q.length;R++){var $=r("filter")(e.modules,{name:q[R].related_module},!0)[0];T.getActionButtons($.id).then(function(e){if(e.length>0){var o=r("filter")(e,function(e){return"Detail"!==e.trigger&&"Form"!==e.trigger&&"List"!==e.trigger},!0);if(o)for(var a=0;a<o.length;a++){var n=o[a];n.module_name=$.name,t.relationActionButtons.push(n),x(n)}}})}}D.run("AfterDetailLoaded","script",t)}]);