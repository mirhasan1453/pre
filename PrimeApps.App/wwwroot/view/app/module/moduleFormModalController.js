"use strict";angular.module("primeapps").controller("ModuleFormModalController",["$rootScope","$scope","ngToast","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","operations","activityTypes","ModuleService",function(e,o,r,a,l,d,t,i,n,u,c,p,s,m,M){o.operations=s,o.hasPermission=l.hasPermission,o.hasFieldFullPermission=M.hasFieldFullPermission,o.loadingModal=!0;var f=o.$parent.currentLookupField.lookup_type;if("relation"===f&&(f=o.$parent.record.related_module.value),null!=f){if(o.moduleModal=a("filter")(e.modules,{name:f},!0)[0],!o.moduleModal)return o.formModal.hide(),r.create({content:a("translate")("Common.NotFound"),className:"warning"}),void t.go("app.dashboard");o.dropdownFields=a("filter")(o.moduleModal.fields,{data_type:"lookup",show_as_dropdown:!0},!0),o.dropdownFieldDatas={};for(var F=0;F<o.dropdownFields.length;F++)o.dropdownFieldDatas[o.dropdownFields[F].name]=[];if(o.setDropdownData=function(e){if(e.filters&&e.filters.length>0)o.dropdownFieldDatas[e.name]=null;else if(o.dropdownFieldDatas[e.name]&&o.dropdownFieldDatas[e.name].length>0)return;o.currentLookupFieldModal=e,o.lookupModal().then(function(r){o.dropdownFieldDatas[e.name]=r})},!o.hasPermission(f,o.operations.modify))return o.forbidden=!0,void(o.loadingModal=!1);if(o.primaryFieldModal=a("filter")(o.moduleModal.fields,{primary_lookup:!0})[0],o.primaryFieldModal||(o.primaryFieldModal=a("filter")(o.moduleModal.fields,{primary:!0})[0]),o.currentUser=M.processUser(e.user),o.currentDayMin=l.getCurrentDateMin().toISOString(),o.currentDayMax=l.getCurrentDateMax().toISOString(),o.currentHour=l.floorMinutes(new Date),o.recordModal={},o.recordModal.owner=o.currentUser,o.$parent.primaryValueModal)if(o.primaryFieldModal.combination){var y=o.$parent.primaryValueModal.split(" ");if(1===y.length)o.recordModal[o.primaryFieldModal.combination.field_1]=y[0];else if(2===y.length)o.recordModal[o.primaryFieldModal.combination.field_1]=y[0],o.recordModal[o.primaryFieldModal.combination.field_2]=y[1];else{o.recordModal[o.primaryFieldModal.combination.field_1]="";for(var F=0;F<y.length;F++)F<y.length-1&&(o.recordModal[o.primaryFieldModal.combination.field_1]=o.recordModal[o.primaryFieldModal.combination.field_1]+y[F]+" ");o.recordModal[o.primaryFieldModal.combination.field_1]=o.recordModal[o.primaryFieldModal.combination.field_1].slice(0,-1),o.recordModal[o.primaryFieldModal.combination.field_2]=y[y.length-1]}}else o.recordModal[o.primaryFieldModal.name]=o.$parent.primaryValueModal;if(o.$parent.calendarDate){var k=a("filter")(o.moduleModal.fields,{calendar_date_type:"start_date"},!0)[0],_=a("filter")(o.moduleModal.fields,{calendar_date_type:"end_date"},!0)[0];if(!k||!_){if("activities"!=o.moduleModal.name)return;k=a("filter")(o.moduleModal.fields,{name:"event_start_date"},!0)[0],_=a("filter")(o.moduleModal.fields,{name:"event_end_date"},!0)[0],o.recordModal.activity_type=a("filter")(m,{system_code:"event"},!0)[0]}var $=angular.copy(o.$parent.calendarDate),g=angular.copy(o.$parent.calendarDate);o.recordModal[k.name]=$.hour(8).toDate(),o.recordModal[_.name]=g.hour(9).toDate()}M.getPicklists(o.moduleModal).then(function(e){if(o.picklistsModuleModal=angular.copy(e),M.setDefaultValues(o.moduleModal,o.recordModal,e),"activities"===o.moduleModal.name){var r=a("filter")(o.moduleModal.fields,{name:"activity_type"},!0)[0];o.picklistsModuleModal[r.picklist_id]&&r&&angular.forEach(o.picklistsModuleModal[r.picklist_id],function(e){"event"!=e.value&&"event"!=e.system_code&&(e.hidden=!0)})}o.loadingModal=!1}),o.lookupModal=function(r){if("users"===o.currentLookupFieldModal.lookup_type&&!o.currentLookupFieldModal.lookupModulePrimaryField){var l={};l.data_type="text_single",l.name="full_name",o.currentLookupFieldModal.lookupModulePrimaryField=l}if("relation"===o.currentLookupField.lookup_type||"activities"===o.currentLookupField.lookup_type){if(!o.recordModal.related_module)return o.$broadcast("angucomplete-alt:clearInput",o.currentLookupField.name),n.defer().promise;var d=a("filter")(e.modules,{name:o.recordModal.related_module.value},!0)[0];if(!d)return o.$broadcast("angucomplete-alt:clearInput",o.currentLookupField.name),n.defer().promise;o.currentLookupFieldModal.lookupModulePrimaryField=a("filter")(d.fields,{primary:!0},!0)[0]}return"number"!==o.currentLookupFieldModal.lookupModulePrimaryField.data_type&&"number_auto"!==o.currentLookupFieldModal.lookupModulePrimaryField.data_type||!isNaN(parseFloat(r))?M.lookup(r,o.currentLookupFieldModal,o.recordModal):(o.$broadcast("angucomplete-alt:clearInput",o.currentLookupFieldModal.name),n.defer().promise)},o.multiselectModal=function(e,r){var a=[];return angular.forEach(o.picklistsModuleModal[r.picklist_id],function(o){o.inactive||(o.labelStr.toLowerCase().indexOf(e.toLowerCase())>-1||o.labelStr.toUpperCase().indexOf(e.toUpperCase())>-1||o.labelStr.toLowerCaseTurkish().indexOf(e.toLowerCaseTurkish())>-1||o.labelStr.toUpperCaseTurkish().indexOf(e.toUpperCaseTurkish())>-1)&&a.push(o)}),a},o.setCurrentLookupFieldModal=function(e){o.currentLookupFieldModal=e},o.submitModal=function(a){function l(){var e=!0;return angular.forEach(o.moduleModal.fields,function(r){a[r.name]&&"lookup"===r.data_type&&"object"!=typeof a[r.name]&&(o.moduleModalForm[r.name].$setValidity("object",!1),e=!1)}),e}o.moduleModalForm.$valid&&l()&&(o.submittingModal=!0,a=M.prepareRecord(a,o.moduleModal),M.insertRecord(o.moduleModal.name,a).then(function(a){o.$parent.isNewsfeed&&r.create({content:"Etkinlik Eklendi",className:"success"});var l=o.moduleModal.name+"_"+o.moduleModal.name;p.remove(l),e.activePages&&e.activePages[o.moduleModal.name]&&(e.activePages[o.moduleModal.name]=null);var d={};d.id=a.data.id,d.primary_value=o.$parent.primaryValueModal,o.$parent.record&&(o.$parent.record[o.$parent.currentLookupField.name]=d),o.$parent.formModalSuccess&&o.$parent.formModalSuccess(),"quate_products"==o.$parent.currentLookupField.special_type&&M.getPicklists(o.moduleModal).then(function(e){var r=a.data,l=M.processRecordSingle(r,o.moduleModal,e),d=o.$parent.currentLookupField.currentproduct;d.product=l,d.product.primary_value=l.name,o.$parent.currentLookupField.currentproduct=d,o.$parent.currentLookupField.selectProduct(o.$parent.currentLookupField.currentproduct),delete o.$parent.record.product}),"order_products"==o.$parent.currentLookupField.special_type&&M.getPicklists(o.moduleModal).then(function(e){var r=a.data,l=M.processRecordSingle(r,o.moduleModal,e),d=o.$parent.currentLookupField.currentproduct;d.product=l,d.product.primary_value=l.name,o.$parent.currentLookupField.currentproduct=d,o.$parent.currentLookupField.selectProduct(o.$parent.currentLookupField.currentproduct),delete o.$parent.record.product}),"purchase_products"==o.$parent.currentLookupField.special_type&&M.getPicklists(o.moduleModal).then(function(e){var r=a.data,l=M.processRecordSingle(r,o.moduleModal,e),d=o.$parent.currentLookupField.currentproduct;d.product=l,d.product.primary_value=l.name,o.$parent.currentLookupField.currentproduct=d,o.$parent.currentLookupField.selectProduct(o.$parent.currentLookupField.currentproduct),delete o.$parent.record.product}),o.submittingModal=!1,o.formModal.hide()})["catch"](function(e){409===e.status&&o.moduleModalForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){o.submittingModal=!1}))},o.calculate=function(e){M.calculate(e,o.moduleModal,o.recordModal)},o.fieldValueChange=function(e){M.setDependency(e,o.moduleModal,o.recordModal,o.picklistsModuleModal),M.setDisplayDependency(o.moduleModal,o.recordModal),o.moduleModalForm[e.name].$error.unique&&o.moduleModalForm[e.name].$setValidity("unique",!0)},o.isModalField=function(e){return"products"!=o.moduleModal.name?e.validation.required&&e.display_form&&!e.deleted?!0:!1:e.display_form&&!e.deleted?!0:!1}}}]);