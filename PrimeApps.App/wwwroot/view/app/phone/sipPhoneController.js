angular.module("primeapps").controller("SipPhoneController",["$rootScope","$scope","ngToast","$filter","$timeout","helper","sipHelper","$popover","$location","$state","$stateParams","$q","$window","$interval","$localStorage","$cache","config",function(e,n,t,a,o,i,s,r,l,c,u,d,m){n.isInbound=!1,n.transferNumber="",e.phoneSettings.sipUsers&&angular.forEach(e.phoneSettings.sipUsers,function(n){if(!n.name){var t=a("filter")(e.users,{id:parseInt(n.userId)},!0)[0];n.name=t.full_name}}),n.registerUnregister=function(){e.sipUser.userAgent&&e.sipUser.userAgent.isRegistered()?s.unRegister():s.register()},n.setToInCall=function(){n.callAccepting=!0;var o=e.sipUser.session;if(o){if(n.isInbound=s.isOutGoingRequest(o),s.isOutGoingRequest(o)===!1&&!o.hasAnswer){var i={media:{constraints:{audio:!0,video:!1}}};o.accept(i);var r=e.sipUser.lineInfo.ModuleName,l=e.sipUser.lineInfo.RecordId;r&&l&&s.goRecordDetail(r,l),n.callAccepting=!1}}else e.sipUser.numberToDial.length>2?(e.sipUser.lineInfo.PhoneStatus=a("translate")("Setup.Phone.Dialing"),e.sipUser.lineInfo.State="Dialing",e.sipUser.lineInfo.TalkingNumber=e.sipUser.numberToDial,s.dial(e.sipUser.lineInfo.TalkingNumber,!1),n.changePhoneScreen("connectingScreen")):t.create({content:a("translate")("Setup.Phone.NoNumber"),className:"warning"}),n.callAccepting=!1},n.dialOrAnswer=function(){o(n.setToInCall,500)},n.hangup=function(){var t=document.getElementById("IncomingSound");t.pause();var i=e.sipUser.session;i?(s.isOutGoingRequest(i)===!0?i.hasAnswer?(e.sipUser.lineInfo.PhoneStatus=a("translate")("Setup.Phone.EndedCall"),i.bye()):("Ringing"===e.sipUser.lineInfo.State&&i.cancel(),i.close(),i=null,e.sipUser.session=null,e.sipUser.lineInfo.PhoneStatus=a("translate")("Setup.Phone.Canceling"),o(function(){e.sipUser.lineInfo.PhoneStatus=a("translate")("Setup.Phone.Ready"),e.sipUser.lineInfo.State="Ready",n.changePhoneScreen("readyScreen")},2e3)):s.isOutGoingRequest(i)===!1&&(i.hasAnswer?(e.sipUser.lineInfo.PhoneStatus=a("translate")("Setup.Phone.EndedCall"),i.bye()):(e.sipUser.lineInfo.PhoneStatus=a("translate")("Setup.Phone.RejectedCall"),i.reject())),e.sipUser.session=null):(e.sipUser.lineInfo.PhoneStatus=a("translate")("Setup.Phone.Canceling"),o(function(){e.sipUser.lineInfo.PhoneStatus=a("translate")("Setup.Phone.Ready"),e.sipUser.lineInfo.State="Ready",n.changePhoneScreen("readyScreen")},2e3))},n.changePhoneScreen=function(n){e.sipUser.activePhoneScreen=n},n.clearPhoneInput=function(t){e.sipUser.numberToDial=e.sipUser.numberToDial.substring(0,e.sipUser.numberToDial.length-1),o(n.addAnimationToButton(t),200),e.sipUser.lineInfo.TalkingRecordInfo=null,n.sipUser.numberToDial.length>10&&s.findRecordGoDetail(e.sipUser.RecordDetailModuleName,e.sipUser.RecordDetailPhoneFieldName,n.sipUser.numberToDial)};var g=m.AudioContext||m.webkitAudioContext||m.mozAudioContext||m.oAudioContext||m.msAudioContext;g&&!e.context&&(e.context=new g),n.addAnimationToButton=function(e){angular.element(e).removeClass("clicked"),o(function(){angular.element(e).addClass("clicked")},100)},n.dialTone=function(t,a){n.stopDialNumber(),n.oscillator1=e.context.createOscillator(),n.oscillator1.type=0,n.oscillator1.frequency.value=t;var i=e.context.createGain?e.context.createGain():e.context.createGainNode();n.oscillator1.connect(i,0,0),i.connect(e.context.destination),i.gain.value=.1,n.oscillator1.start?n.oscillator1.start(0):n.oscillator1.noteOn(0),n.oscillator2=e.context.createOscillator(),n.oscillator2.type=0,n.oscillator2.frequency.value=a,i=e.context.createGain?e.context.createGain():e.context.createGainNode(),n.oscillator2.connect(i),i.connect(e.context.destination),i.gain.value=.1,n.oscillator2.start?n.oscillator2.start(0):n.oscillator2.noteOn(0),o(function(){n.stopDialNumber()},200)},n.putDialNumber=function(t,a,o,i){e.sipUser.numberToDial+=t.toString(),n.addAnimationToButton(i.currentTarget),n.dialTone(a,o),n.findRecord()},n.findRecord=function(t,a){if(e.sipUser.lineInfo.TalkingRecordInfo=null,t&&(n.sipUser.numberToDial=t),n.sipUser.numberToDial.length>10&&s.findRecordGoDetail(e.sipUser.RecordDetailModuleName,e.sipUser.RecordDetailPhoneFieldName,n.sipUser.numberToDial),a)switch(a.keyCode){case 97:var o=document.getElementsByClassName("number-dig")[0];n.addAnimationToButton(o),n.dialTone(697,1209);break;case 98:var o=document.getElementsByClassName("number-dig")[1];n.addAnimationToButton(o),n.dialTone(697,1336);break;case 99:var o=document.getElementsByClassName("number-dig")[2];n.addAnimationToButton(o),n.dialTone(697,1477);break;case 100:var o=document.getElementsByClassName("number-dig")[3];n.addAnimationToButton(o),n.dialTone(770,1209);break;case 101:var o=document.getElementsByClassName("number-dig")[4];n.addAnimationToButton(o),n.dialTone(770,1336);break;case 102:var o=document.getElementsByClassName("number-dig")[5];n.addAnimationToButton(o),n.dialTone(770,1477);break;case 103:var o=document.getElementsByClassName("number-dig")[6];n.addAnimationToButton(o),n.dialTone(852,1209);break;case 104:var o=document.getElementsByClassName("number-dig")[7];n.addAnimationToButton(o),n.dialTone(770,1477);break;case 105:var o=document.getElementsByClassName("number-dig")[8];n.addAnimationToButton(o),n.dialTone(770,1477);break;case 106:var o=document.getElementsByClassName("number-dig")[9];n.addAnimationToButton(o);break;case 96:var o=document.getElementsByClassName("number-dig")[10];n.addAnimationToButton(o),n.dialTone(770,1477);break;case 96:var o=document.getElementsByClassName("number-dig")[10];n.addAnimationToButton(o),n.dialTone(770,1477);break;case 18:var o=document.getElementsByClassName("number-dig")[11];n.addAnimationToButton(o),n.dialTone(770,1477);break;case 13:var o=document.getElementsByClassName("action-dig");n.dialOrAnswer(o),n.dialTone(770,1477)}},n.stopDialNumber=function(){n.oscillator1&&n.oscillator2&&(n.oscillator1.disconnect(),n.oscillator2.disconnect())},n.mute=function(){s.mute()},n.unmute=function(){s.unmute()},n.hold=function(){s.hold()},n.unhold=function(){s.unhold()},n.transfer=function(e){s.transfer(e)},n.isTransferChange=function(e){n.isTransfer=e}}]);