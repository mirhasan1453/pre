"use strict";angular.module("primeapps").controller("PurchaseInvoiceProductsController",["$rootScope","$scope","$state","config","ngToast","$localStorage","$filter","ngTableParams","$stateParams","helper","QuoteProductsService","ModuleService","$popover",function(r,e,t,c,n,a,u,o,p,d,i,s){if("purchase_invoices"==e.$parent.$parent.type){if(e.isMobile=!1,("undefined"!=typeof window.orientation||window.innerWidth<=500)&&(e.isMobile=!0),e.purchaseInvoiceProductModule=u("filter")(r.modules,{name:"purchase_invoices_products"},!0)[0],!e.purchaseInvoiceProductModule)return n.create({content:u("translate")("Common.NotFound"),className:"warning"}),void t.go("app.dashboard");e.fields=[],e.purchaseInvoiceProductModule.fields.forEach(function(r){e.fields[r.name]=r}),e.purchaseInvoiceFields=[],e.purchaseInvoiceModule=u("filter")(r.modules,{name:"purchase_invoices"},!0)[0],e.purchaseInvoiceModule.fields.forEach(function(r){e.purchaseInvoiceFields[r.name]=r}),e.productField=u("filter")(e.purchaseInvoiceProductModule.fields,{name:"product"},!0)[0],e.productModule=u("filter")(r.modules,{name:"products"},!0)[0],e.productField.lookupModulePrimaryField=u("filter")(e.productModule.fields,{name:"name"},!0)[0],e.productFields=[],angular.forEach(e.productModule.fields,function(r){e.productFields[r.name]=r}),s.getPicklists(e.purchaseInvoiceProductModule).then(function(t){e.picklistsModule=t,e.usageUnitList=e.picklistsModule[e.fields.usage_unit.picklist_id],e.currencyList=e.picklistsModule[e.fields.currency.picklist_id],e.defaultCurrency=u("filter")(e.currencyList,{value:r.currencySymbol})[0]}),s.getPicklists(e.productModule).then(function(r){e.productModulePicklists=r}),e.setCurrentLookupProduct=function(r,t){e.currentLookupProduct=r,e.productSelected=!0,t.special_type="quate_products",t.currentproduct=r,t.selectProduct=e.selectProduct,(t.currentproduct.defaultCurrency||t.currentproduct.currencyConvertList)&&(delete t.currentproduct.defaultCurrency,delete t.currentproduct.currencyConvertList),e.$parent.setCurrentLookupField(t)};var l=["unit_price","usage_unit","vat_percent"];e.fields.purchase_price&&l.push("purchase_price"),e.fields.currency&&l.push("currency"),e.lookup=function(r){return s.lookup(r,e.productField,e.currentLookupProduct,l)},e.addPurchaseInvoiceProduct=function(r){var t={};t.id=0,t.discount_type="percent",r&&(t.separator="",t.product={});var c=[];angular.forEach(e.$parent.$parent.purchaseInvoiceProducts,function(r){c.push(r.order)}),t.order=Math.max.apply(null,c)+1,(!t.order||t.order<1)&&(t.order=1),e.$parent.$parent.purchaseInvoiceProducts.push(t)},e.currencyConvert=function(r,t){var c=[];switch(r.defaultCurrency){case"₺":c.$=t*e.$parent.$parent.record.exchange_rate_usd_try,c["€"]=t*e.$parent.$parent.record.exchange_rate_eur_try,c["₺"]=t;break;case"$":c["₺"]=t*e.$parent.$parent.record.exchange_rate_try_usd,c["€"]=t*e.$parent.$parent.record.exchange_rate_eur_usd,c.$=t;break;case"€":c["₺"]=t*e.$parent.$parent.record.exchange_rate_try_eur,c.$=t*e.$parent.$parent.record.exchange_rate_usd_eur,c["€"]=t}return c},e.setVat=function(r){void 0!=r.product.vat_percent&&(r.vat_percent=r.product.vat_percent)},e.selectProduct=function(t){if(t.product){t.defaultCurrency?(t.product.purchase_price=t.currencyConvertList[t.product.currency.value],t.product.purchase_price=t.currencyConvertList[t.product.currency?t.product.currency.value:r.currencySymbol]):(t.defaultCurrency=t.product.currency?t.product.currency.value:r.currencySymbol,t.currencyConvertList=e.currencyConvert(t,t.product.purchase_price));var c=parseFloat(t.product.purchase_price);t.quantity||(t.quantity=1),t.purchase_price=c,t.amount=c,t.product.usage_unit&&(angular.isObject(t.product.usage_unit)?t.usage_unit=t.product.usage_unit:e.usageUnitList.forEach(function(r){t.product.usage_unit===r.labelStr&&(t.product.usage_unit=r)})),t.product.currency?t.currency=t.product.currency:(t.currency=e.defaultCurrency,t.product.currency=e.defaultCurrency),e.calculate(t)}},e.$parent.$parent.id||(e.$parent.$parent.record.total=0,e.$parent.$parent.record.vat_total=0,e.$parent.$parent.record.grand_total=0,e.$parent.$parent.record.discount_type="percent"),e.$parent.$parent.isDetail&&(e.readonly=!0),e.calculate=function(r){var t=0,c=0;switch(isNaN(r.quantity)||(t=angular.copy(r.quantity)),isNaN(r.purchase_price)||(c=angular.copy(r.purchase_price)),e.fields.no&&(r.no=0),r.amount=t*c,r.discount_type){case"percent":e.$parent.$parent.record.contact&&e.$parent.$parent.record.contact.discount&&void 0===r.discount_percent&&null!==r.discount_percent&&(r.discount_percent=angular.isObject(e.$parent.$parent.record.contact.discount)?e.$parent.$parent.record.contact.discount.value:e.$parent.$parent.record.contact.discount),e.$parent.$parent.record.account&&e.$parent.$parent.record.account.discount&&void 0===r.discount_percent&&null!==r.discount_percent&&(r.discount_percent=angular.isObject(e.$parent.$parent.record.account.discount)?e.$parent.$parent.record.account.discount.value:e.$parent.$parent.record.account.discount),void 0==r.discount_percent||null==r.discount_percent||isNaN(r.discount_percent)||(r.discount_percent<0&&(r.discount_percent=0),r.discount_percent>100&&(r.discount_percent=100),r.amount-=r.amount*r.discount_percent/100),r.discount_amount=c*t*r.discount_percent/100,e.fields.unit_amount&&(r.unit_amount=r.amount/t);break;case"amount":void 0==r.discount_amount||null==r.discount_amount||isNaN(r.discount_amount)||(r.discount_amount>r.unit_price,r.amount-=r.discount_amount,r.discount_percent=100/(c*t)*r.discount_amount),e.fields.unit_amount&&(r.unit_amount=r.amount/t)}e.fields.purchase_price&&r.product.purchase_price&&(void 0===r.purchase_price||null===r.purchase_price),(void 0!=r.purchase_price||null!=r.purchase_price)&&(r.profit_amount=r.amount-r.purchase_price*t,r.profit_percent=(r.amount-t*r.purchase_price)/(t*r.purchase_price)*100);var n=parseFloat(r.product.vat_percent||0);r.vat=r.amount*n/100,e.calculateAll()},e.calculateAll=function(){var r=0,t=0,c=0,n=[];e.$parent.$parent.currencyField&&e.$parent.$parent.record.currency&&(e.$parent.$parent.currencyField.validation.readonly=!0);var a=0;if(angular.forEach(e.$parent.$parent.purchaseInvoiceProducts,function(c){if(c.amount&&!c.deleted){a++,c.quantity<0&&(c.quantity=0),c.purchase_price<0&&(c.purchase_price=0),c.purchase_price>1e12&&(c.purchase_price=1e12);var o=angular.copy(c.amount),p=angular.copy(c.vat)||0;if(c.product.currency&&e.$parent.$parent.record.currency&&c.product.currency.value&&e.$parent.$parent.record.currency.value&&c.product.currency.value!=e.$parent.$parent.record.currency.value)switch(e.$parent.$parent.record.currency.value){case"₺":"$"===c.product.currency.value?(o*=e.$parent.$parent.record.exchange_rate_try_usd,p*=e.$parent.$parent.record.exchange_rate_try_usd):"€"===c.product.currency.value&&(o*=e.$parent.$parent.record.exchange_rate_try_eur,p*=e.$parent.$parent.record.exchange_rate_try_eur);break;case"$":"₺"===c.product.currency.value?(o*=e.$parent.$parent.record.exchange_rate_usd_try,p*=e.$parent.$parent.record.exchange_rate_usd_try):"€"===c.product.currency.value&&(o*=e.$parent.$parent.record.exchange_rate_usd_eur,p*=e.$parent.$parent.record.exchange_rate_usd_eur);break;case"€":"₺"===c.product.currency.value?(o*=e.$parent.$parent.record.exchange_rate_eur_try,p*=e.$parent.$parent.record.exchange_rate_eur_try):"$"===c.product.currency.value&&(o*=e.$parent.$parent.record.exchange_rate_eur_usd,p*=e.$parent.$parent.record.exchange_rate_eur_usd)}r+=o,t+=p;var d=u("filter")(n,{percent:c.product.vat_percent},!0)[0];d?d.total+=p||0:(d={},d.percent=parseFloat(c.product.vat_percent||0),d.total=p,p&&n.push(d))}}),e.$parent.$parent.currencyField&&e.$parent.$parent.record.currency&&1>a&&(e.$parent.$parent.currencyField.validation.readonly=!1),e.$parent.$parent.record.discount_percent||e.$parent.$parent.record.discount_amount)switch(e.$parent.$parent.record.discount_type){case"percent":void 0==e.$parent.$parent.record.discount_percent||null==e.$parent.$parent.record.discount_percent||isNaN(e.$parent.$parent.record.discount_percent)||(e.$parent.$parent.record.discount_percent>100&&(e.$parent.$parent.record.discount_percent=100),c=r*e.$parent.$parent.record.discount_percent/100,t-=t*e.$parent.$parent.record.discount_percent/100,angular.forEach(n,function(r){r.total-=r.total*e.$parent.$parent.record.discount_percent/100})),e.$parent.$parent.record.discount_amount=null;break;case"amount":if(void 0!=e.$parent.$parent.record.discount_amount&&null!=e.$parent.$parent.record.discount_amount&&!isNaN(e.$parent.$parent.record.discount_amount)){c=e.$parent.$parent.record.discount_amount;var o=100*e.$parent.$parent.record.discount_amount/r;t-=t*o/100,angular.forEach(n,function(r){r.total-=r.total*o/100})}e.$parent.$parent.record.discount_percent=null}e.$parent.$parent.record.total=r,e.$parent.$parent.record.discounted_total=c?r-c:void 0,e.$parent.$parent.record.vat_total=t,e.$parent.$parent.record.grand_total=r-c+t,e.$parent.$parent.record.vat_list=e.prepareVatList(n),e.$parent.$parent.vatList=n},e["delete"]=function(r){r.deleted=!0,e.calculateAll()},e.prepareVatList=function(r){if(r){var e="";return angular.forEach(r,function(r){e+=r.percent+";"+r.total+"|"}),e.slice(0,-1)}},e.up=function(r,t){var c=u("filter")(e.$parent.$parent.purchaseInvoiceProducts,{deleted:!1});c=u("orderBy")(e.$parent.$parent.purchaseInvoiceProducts,"order");var n=angular.copy(c[r-1]);c[r].order=n.order,c[r-1].order=angular.copy(t)},e.down=function(r,t){var c=u("filter")(e.$parent.$parent.purchaseInvoiceProducts,{deleted:!1});c=u("orderBy")(e.$parent.$parent.purchaseInvoiceProducts,"order");var n=angular.copy(c[r+1]);c[r].order=n.order,c[r+1].order=angular.copy(t)},e.productInfo=function(r){e.currentProduct=r}}}]);