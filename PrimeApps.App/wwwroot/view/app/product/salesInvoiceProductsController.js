"use strict";angular.module("primeapps").controller("SalesInvoiceProductsController",["$rootScope","$scope","$state","config","ngToast","$localStorage","$filter","ngTableParams","$stateParams","helper","QuoteProductsService","ModuleService","$popover",function(e,r,t,n,c,a,u,o,p,d,i,s){if("sales_invoices"==r.$parent.$parent.type){if(r.isMobile=!1,("undefined"!=typeof window.orientation||window.innerWidth<=500)&&(r.isMobile=!0),r.salesInvoiceProductModule=u("filter")(e.modules,{name:"sales_invoices_products"},!0)[0],!r.salesInvoiceProductModule)return c.create({content:u("translate")("Common.NotFound"),className:"warning"}),void t.go("app.dashboard");r.fields=[],r.salesInvoiceProductModule.fields.forEach(function(e){r.fields[e.name]=e}),r.salesInvoiceFields=[],r.salesInvoiceModule=u("filter")(e.modules,{name:"sales_invoices"},!0)[0],r.salesInvoiceModule.fields.forEach(function(e){r.salesInvoiceFields[e.name]=e}),r.productField=u("filter")(r.salesInvoiceProductModule.fields,{name:"product"},!0)[0],r.productModule=u("filter")(e.modules,{name:"products"},!0)[0],r.productField.lookupModulePrimaryField=u("filter")(r.productModule.fields,{name:"name"},!0)[0],r.productFields=[],angular.forEach(r.productModule.fields,function(e){r.productFields[e.name]=e}),s.getPicklists(r.salesInvoiceProductModule).then(function(t){r.picklistsModule=t,r.usageUnitList=r.picklistsModule[r.fields.usage_unit.picklist_id],r.currencyList=r.picklistsModule[r.fields.currency.picklist_id],r.defaultCurrency=u("filter")(r.currencyList,{value:e.currencySymbol})[0]}),s.getPicklists(r.productModule).then(function(e){r.productModulePicklists=e}),r.setCurrentLookupProduct=function(e,t){r.currentLookupProduct=e,r.productSelected=!0,t.special_type="quate_products",t.currentproduct=e,t.selectProduct=r.selectProduct,(t.currentproduct.defaultCurrency||t.currentproduct.currencyConvertList)&&(delete t.currentproduct.defaultCurrency,delete t.currentproduct.currencyConvertList),r.$parent.setCurrentLookupField(t)};var l=["unit_price","usage_unit","vat_percent"];r.fields.purchase_price&&l.push("purchase_price"),r.fields.currency&&l.push("currency"),r.lookup=function(e){return s.lookup(e,r.productField,r.currentLookupProduct,l)},r.addSalesInvoiceProduct=function(e){var t={};t.id=0,t.discount_type="percent",e&&(t.separator="",t.product={});var n=[];angular.forEach(r.$parent.$parent.salesInvoiceProducts,function(e){n.push(e.order)}),t.order=Math.max.apply(null,n)+1,(!t.order||t.order<1)&&(t.order=1),r.$parent.$parent.salesInvoiceProducts.push(t)},r.currencyConvert=function(e,t){var n=[];switch(e.defaultCurrency){case"₺":n.$=t*r.$parent.$parent.record.exchange_rate_usd_try,n["€"]=t*r.$parent.$parent.record.exchange_rate_eur_try,n["₺"]=t;break;case"$":n["₺"]=t*r.$parent.$parent.record.exchange_rate_try_usd,n["€"]=t*r.$parent.$parent.record.exchange_rate_eur_usd,n.$=t;break;case"€":n["₺"]=t*r.$parent.$parent.record.exchange_rate_try_eur,n.$=t*r.$parent.$parent.record.exchange_rate_usd_eur,n["€"]=t}return n},r.setVat=function(e){void 0!=e.product.vat_percent&&(e.vat_percent=e.product.vat_percent)},r.selectProduct=function(t){if(t.product){t.defaultCurrency?t.product.unit_price=t.currencyConvertList[t.product.currency?t.product.currency.value:e.currencySymbol]:(t.defaultCurrency=t.product.currency?t.product.currency.value:e.currencySymbol,t.currencyConvertList=r.currencyConvert(t,t.product.unit_price));var n=parseFloat(t.product.unit_price);t.quantity||(t.quantity=1),t.unit_price=n,t.amount=n,t.product.usage_unit&&(angular.isObject(t.product.usage_unit)?t.usage_unit=t.product.usage_unit:r.usageUnitList.forEach(function(e){t.product.usage_unit===e.labelStr&&(t.product.usage_unit=e)})),t.product.currency?t.currency=t.product.currency:(t.currency=r.defaultCurrency,t.product.currency=r.defaultCurrency),r.calculate(t)}},r.$parent.$parent.id||(r.$parent.$parent.record.total=0,r.$parent.$parent.record.vat_total=0,r.$parent.$parent.record.grand_total=0,r.$parent.$parent.record.discount_type="percent"),r.$parent.$parent.isDetail&&(r.readonly=!0),r.calculate=function(e){var t=0,n=0;switch(isNaN(e.quantity)||(t=angular.copy(e.quantity)),isNaN(e.unit_price)||(n=angular.copy(e.unit_price)),r.fields.no&&(e.no=0),e.amount=t*n,e.discount_type){case"percent":r.$parent.$parent.record.contact&&r.$parent.$parent.record.contact.discount&&void 0===e.discount_percent&&null!==e.discount_percent&&(e.discount_percent=angular.isObject(r.$parent.$parent.record.contact.discount)?r.$parent.$parent.record.contact.discount.value:r.$parent.$parent.record.contact.discount),r.$parent.$parent.record.account&&r.$parent.$parent.record.account.discount&&void 0===e.discount_percent&&null!==e.discount_percent&&(e.discount_percent=angular.isObject(r.$parent.$parent.record.account.discount)?r.$parent.$parent.record.account.discount.value:r.$parent.$parent.record.account.discount),void 0==e.discount_percent||null==e.discount_percent||isNaN(e.discount_percent)||(e.discount_percent<0&&(e.discount_percent=0),e.discount_percent>100&&(e.discount_percent=100),e.amount-=e.amount*e.discount_percent/100),e.discount_amount=n*t*e.discount_percent/100,r.fields.unit_amount&&(e.unit_amount=e.amount/t);break;case"amount":void 0==e.discount_amount||null==e.discount_amount||isNaN(e.discount_amount)||(e.discount_amount>e.unit_price,e.amount-=e.discount_amount,e.discount_percent=100/(n*t)*e.discount_amount),r.fields.unit_amount&&(e.unit_amount=e.amount/t)}r.fields.purchase_price&&(e.purchase_price=!e.product.purchase_price||void 0!==e.purchase_price&&null!==e.purchase_price?r.currencyConvert(e,e.product.purchase_price)[e.product.currency.value]:r.currencyConvert(e,e.product.purchase_price)[e.product.currency.value]),(void 0!=e.purchase_price||null!=e.purchase_price)&&(e.profit_amount=e.amount-e.purchase_price*t,e.profit_percent=(e.amount-t*e.purchase_price)/(t*e.purchase_price)*100);var c=parseFloat(e.product.vat_percent||0);e.vat=e.amount*c/100,r.calculateAll()},r.calculateAll=function(){var e=0,t=0,n=0,c=[];r.$parent.$parent.currencyField&&r.$parent.$parent.record.currency&&(r.$parent.$parent.currencyField.validation.readonly=!0);var a=0;if(angular.forEach(r.$parent.$parent.salesInvoiceProducts,function(n){if(n.amount&&!n.deleted){a++,n.quantity<0&&(n.quantity=0),n.unit_price<0&&(n.unit_price=0),n.unit_price>1e12&&(n.unit_price=1e12);var o=angular.copy(n.amount),p=angular.copy(n.vat)||0;if(n.product.currency&&r.$parent.$parent.record.currency&&n.product.currency.value&&r.$parent.$parent.record.currency.value&&n.product.currency.value!=r.$parent.$parent.record.currency.value)switch(r.$parent.$parent.record.currency.value){case"₺":"$"===n.product.currency.value?(o*=r.$parent.$parent.record.exchange_rate_try_usd,p*=r.$parent.$parent.record.exchange_rate_try_usd):"€"===n.product.currency.value&&(o*=r.$parent.$parent.record.exchange_rate_try_eur,p*=r.$parent.$parent.record.exchange_rate_try_eur);break;case"$":"₺"===n.product.currency.value?(o*=r.$parent.$parent.record.exchange_rate_usd_try,p*=r.$parent.$parent.record.exchange_rate_usd_try):"€"===n.product.currency.value&&(o*=r.$parent.$parent.record.exchange_rate_usd_eur,p*=r.$parent.$parent.record.exchange_rate_usd_eur);break;case"€":"₺"===n.product.currency.value?(o*=r.$parent.$parent.record.exchange_rate_eur_try,p*=r.$parent.$parent.record.exchange_rate_eur_try):"$"===n.product.currency.value&&(o*=r.$parent.$parent.record.exchange_rate_eur_usd,p*=r.$parent.$parent.record.exchange_rate_eur_usd)}e+=o,t+=p;var d=u("filter")(c,{percent:n.product.vat_percent},!0)[0];d?d.total+=p||0:(d={},d.percent=parseFloat(n.product.vat_percent||0),d.total=p,p&&c.push(d))}}),r.$parent.$parent.currencyField&&r.$parent.$parent.record.currency&&1>a&&(r.$parent.$parent.currencyField.validation.readonly=!1),r.$parent.$parent.record.discount_percent||r.$parent.$parent.record.discount_amount)switch(r.$parent.$parent.record.discount_type){case"percent":void 0==r.$parent.$parent.record.discount_percent||null==r.$parent.$parent.record.discount_percent||isNaN(r.$parent.$parent.record.discount_percent)||(r.$parent.$parent.record.discount_percent>100&&(r.$parent.$parent.record.discount_percent=100),n=e*r.$parent.$parent.record.discount_percent/100,t-=t*r.$parent.$parent.record.discount_percent/100,angular.forEach(c,function(e){e.total-=e.total*r.$parent.$parent.record.discount_percent/100})),r.$parent.$parent.record.discount_amount=null;break;case"amount":if(void 0!=r.$parent.$parent.record.discount_amount&&null!=r.$parent.$parent.record.discount_amount&&!isNaN(r.$parent.$parent.record.discount_amount)){n=r.$parent.$parent.record.discount_amount;var o=100*r.$parent.$parent.record.discount_amount/e;t-=t*o/100,angular.forEach(c,function(e){e.total-=e.total*o/100})}r.$parent.$parent.record.discount_percent=null}r.$parent.$parent.record.total=e,r.$parent.$parent.record.discounted_total=n?e-n:void 0,r.$parent.$parent.record.vat_total=t,r.$parent.$parent.record.grand_total=e-n+t,r.$parent.$parent.record.vat_list=r.prepareVatList(c),r.$parent.$parent.vatList=c},r["delete"]=function(e){e.deleted=!0,r.calculateAll()},r.prepareVatList=function(e){if(e){var r="";return angular.forEach(e,function(e){r+=e.percent+";"+e.total+"|"}),r.slice(0,-1)}},r.up=function(e,t){var n=u("filter")(r.$parent.$parent.salesInvoiceProducts,{deleted:!1});n=u("orderBy")(r.$parent.$parent.salesInvoiceProducts,"order");var c=angular.copy(n[e-1]);n[e].order=c.order,n[e-1].order=angular.copy(t)},r.down=function(e,t){var n=u("filter")(r.$parent.$parent.salesInvoiceProducts,{deleted:!1});n=u("orderBy")(r.$parent.$parent.salesInvoiceProducts,"order");var c=angular.copy(n[e+1]);n[e].order=c.order,n[e+1].order=angular.copy(t)},r.productInfo=function(e){r.currentProduct=e}}}]);