"use strict";angular.module("primeapps").controller("CreateReportController",["$rootScope","$scope","$location","$filter","$timeout","$state","ngToast","helper","ModuleService","dragularService","ReportsService","operators",function(e,t,r,a,o,l,i,n,s,d,u,p){t.reportModel={},t.reportModel.category_id=parseInt(r.search().categoryId),t.ReportId=parseInt(r.search().Id),t.isEdit=t.ReportId>0,t.clone=r.search().clone,t.icons=s.getIcons(),t.reportModel.chart={},t.chartTypes=[{label:a("translate")("Report.Chart.ColumnChart2d"),name:"column2d"},{label:a("translate")("Report.Chart.ColumnChart3d"),name:"column3d"},{label:a("translate")("Report.Chart.LineChart"),name:"line"},{label:a("translate")("Report.Chart.AreaChart"),name:"area2d"},{label:a("translate")("Report.Chart.BarChart2d"),name:"bar2d"},{label:a("translate")("Report.Chart.BarChart3d"),name:"bar3d"},{label:a("translate")("Report.Chart.PieChart"),name:"pie3d"},{label:a("translate")("Report.Chart.DoughnutChart2d"),name:"doughnut2d"},{label:a("translate")("Report.Chart.DoughnutChart3d"),name:"doughnut3d"},{label:a("translate")("Report.Chart.ScrollColumnChart"),name:"scrollcolumn2d"},{label:a("translate")("Report.Chart.ScrollLineChart"),name:"scrollline2d"},{label:a("translate")("Report.Chart.ScrollAreaChart"),name:"scrollarea2d"},{label:a("translate")("Report.Chart.FunnelChart"),name:"funnel"},{label:a("translate")("Report.Chart.PyramidChart"),name:"pyramid"}],u.getAllCategory().then(function(e){t.reportCategory=e.data}),t.wizardStep=0,t.lookupUser=n.lookupUser,t.costumeDate="this_day()",t.dateFormat=[{label:a("translate")("View.Second"),value:"s"},{label:a("translate")("View.Minute"),value:"m"},{label:a("translate")("View.Hour"),value:"h"},{label:a("translate")("View.Day"),value:"D"},{label:a("translate")("View.Week"),value:"W"},{label:a("translate")("View.Month"),value:"M"},{label:a("translate")("View.Year"),value:"Y"}],t.costumeDateFilter=[{name:"thisNow",label:a("translate")("View.Now"),value:"now()"},{name:"thisToday",label:a("translate")("View.StartOfTheDay"),value:"today()"},{name:"thisWeek",label:a("translate")("View.StartOfThisWeek"),value:"this_week()"},{name:"thisMonth",label:a("translate")("View.StartOfThisMonth"),value:"this_month()"},{name:"thisYear",label:a("translate")("View.StartOfThisYear"),value:"this_year()"},{name:"costume",label:a("translate")("View.CustomDate"),value:"costume"},{name:"todayNextPrev",label:a("translate")("View.FromTheBeginningOfTheDay"),value:"costumeN",nextprevdatetype:"D"},{name:"weekNextPrev",label:a("translate")("View.FromTheBeginningOfTheWeek"),value:"costumeW",nextprevdatetype:"M"},{name:"monthNextPrev",label:a("translate")("View.FromTheBeginningOfTheMonth"),value:"costumeM",nextprevdatetype:"M"},{name:"yearNextPrev",label:a("translate")("View.FromTheBeginningOfTheYear"),value:"costumeY",nextprevdatetype:"Y"}],t.setEdit=function(e){u.getReport(e).then(function(e){t.currentReport=e.data,t.setStep1()})},t.dateChange=function(e){"costume"!=e.costumeDate&&"costumeN"!=e.costumeDate&&"costumeW"!=e.costumeDate&&"costumeM"!=e.costumeDate&&"costumeY"!=e.costumeDate&&(e.value=e.costumeDate),("costumeN"===e.costumeDate||"costumeW"===e.costumeDate||"costumeM"===e.costumeDate||"costumeY"===e.costumeDate)&&(e.value="",e.valueX="",e.nextprevdatetype="")},t.nextPrevDateChange=function(e){t.setCostumDate(e)},t.nextPrevDateTypeChange=function(e){t.setCostumDate(e)},t.setCostumDate=function(e){if(null===e.valueX||""===e.valueX||void 0===e.valueX)return e.value="",!1;switch(void 0===e.nextprevdatetype&&(e.nextprevdatetype=t.dateFormat[0].value),e.costumeDate){case"costumeN":e.value="today("+e.valueX+e.nextprevdatetype+")";break;case"costumeM":e.value="this_month("+e.valueX+e.nextprevdatetype+")";break;case"costumeW":e.value="this_week("+e.valueX+e.nextprevdatetype+")";break;case"costumeY":e.value="this_year("+e.valueX+e.nextprevdatetype+")"}},t.selectModule=function(){t.loadingFilter=!0,t.numberField=[],t.reportModel.aggregations=[],t.module=angular.copy(a("filter")(e.modules,{id:t.reportModel.module_id},!0)[0]),t.fields={availableFields:[],selectedFields:[]},t.ReportId||(angular.forEach(t.module.fields,function(e){e.deleted||!s.hasFieldDisplayPermission(e)&&"large"!=e.multiline_type||("lookup"===e.data_type&&"users"!=e.lookup_type&&e.lookupModulePrimaryField&&(e.name=e.name+"."+e.lookup_type+"."+e.lookupModulePrimaryField.name),t.fields.availableFields.push(e))}),t.fields.availableFields=a("orderBy")(t.fields.availableFields,"order")),s.getPicklists(t.module,!0).then(function(r){t.modulePicklists=r,t.reportModel.filterList=[];for(var o=0;10>o;o++){var l={};l.field=null,l.operator=null,l.value=null,l.no=o+1,t.reportModel.filterList.push(l)}if(t.reportModel.filters){t.reportModel.filters=a("orderBy")(t.reportModel.filters,"no");for(var i=0;i<t.reportModel.filters.length;i++){var n=t.reportModel.filters[i].field,s=t.reportModel.filters[i].value;n.indexOf(".")>-1&&(n=n.split(".")[0],t.reportModel.filters[i].field=n);var d=a("filter")(t.module.fields,{name:n},!0)[0],u=null;if(!d)return;switch(d.data_type){case"picklist":u=a("filter")(t.modulePicklists[d.picklist_id],{labelStr:s},!0)[0];break;case"multiselect":u=[];var c=s.split("|");angular.forEach(c,function(e){var r=a("filter")(t.modulePicklists[d.picklist_id],{labelStr:e},!0)[0];r&&u.push(r)});break;case"lookup":if("users"===d.lookup_type){var m={};if("0"===s||"[me]"===s)m.id=0,m.email="[me]",m.full_name=a("translate")("Common.LoggedInUser");else if("-"!=s){var g=a("filter")(e.users,{id:parseInt(s)},!0)[0];m.id=g.id,m.email=g.email,m.full_name=g.full_name}u=[m]}else u=s;break;case"date":case"date_time":case"time":t.isCostumeDate(t.reportModel.filters[i])?(u=t.reportModel.filters[i].value,t.reportModel.filterList[i].costumeDate=t.reportModel.filters[i].costumeDate,t.reportModel.filterList[i].valueX=t.reportModel.filters[i].valueX,t.reportModel.filterList[i].nextprevdatetype=t.reportModel.filters[i].nextprevdatetype):(u=new Date(s),t.reportModel.filterList[i].costumeDate="costume",t.reportModel.filters[i].costumeDate="costume");break;case"checkbox":u=a("filter")(t.modulePicklists.yes_no,{system_code:s},!0)[0];break;default:u=s}t.reportModel.filterList[i].field=d,t.reportModel.filterList[i].operator=p[t.reportModel.filters[i].operator],t.reportModel.filterList[i].value=u,("empty"===t.reportModel.filters[i].operator||"not_empty"===t.reportModel.filters[i].operator)&&(t.reportModel.filterList[i].value=null,t.reportModel.filterList[i].disabled=!0)}}t.loadingFilter=!1}),t.multiselect=function(e,r){var a=[];return angular.forEach(t.modulePicklists[r.picklist_id],function(t){t.inactive||t.labelStr.toLowerCase().indexOf(e)>-1&&a.push(t)}),a},t.lookupUser=n.lookupUser;var r=function(e){if(e.operator){var t=new Date(e.value);switch(e.operator.name){case"greater":t.setHours(23),t.setMinutes(59),t.setSeconds(59),t.setMilliseconds(99);break;case"less":t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0)}e.value=t}};t.dateTimeChanged=function(e){r(e)},t.isCostumeDate=function(e){return e.value.indexOf("now(")>-1?(e.costumeDate="now()",!0):e.value.indexOf("today(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeN",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="today()",!0):e.value.indexOf("this_week(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeW",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="this_week()",!0):e.value.indexOf("this_month(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeM",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="this_month()",!0):e.value.indexOf("this_year(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeY",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="this_year()",!0):!1},t.operatorChanged=function(e,a){var o=t.reportModel.filterList[a];o&&o.operator&&("date_time"===e.data_type&&o.value&&"costume"===o.costumeDate&&r(o),"empty"===o.operator.name||"not_empty"===o.operator.name?(o.value=null,o.disabled=!0):o.disabled=!1)},angular.forEach(t.module.fields,function(e){("numeric"===e.data_type||"number"===e.data_type||"number_auto"===e.data_type||"currency"===e.data_type||"number_decimal"===e.data_type)&&t.numberField.push(angular.copy(e))})},t.setFields=function(){function e(e,t,r){return r!=t?!0:void 0}var r=document.querySelector("#availableFields"),a=document.querySelector("#selectedFields");d([r],{scope:t,containersModel:[t.fields.availableFields],classes:{mirror:"gu-mirror-view",transit:"gu-transit-view"},accepts:e,moves:function(e,t,r){return r.classList.contains("dragable")}}),d([a],{scope:t,classes:{mirror:"gu-mirror-view",transit:"gu-transit-view"},containersModel:[t.fields.selectedFields]}),t.$on("dragulardrop",function(){t.reportForm.$setValidity("field",!0)})},t.aggregationChange=function(r,o){if("count"===r.aggregation_type&&("summary"===t.reportModel.report_type||"single"===t.reportModel.report_type))return t.reportModel.aggregations=[{field:"created_by",aggregation_type:"count"}],t.reportModel.chart.yaxis_name=a("translate")("Report.count"),!0;if(t.reportModel.chart.yaxis_name=o["label_"+e.language],"summary"===t.reportModel.report_type||"single"===t.reportModel.report_type)t.reportModel.aggregations=[];else{var l=a("filter")(t.reportModel.aggregations,{field:r.field},!0)[0];if(l)return l.aggregation_type=r.aggregation_type,!0}t.reportModel.aggregations.push(r)},t.removeSelectAggregation=function(e){e.Aggregation=null;var r=t.reportModel.aggregations.indexOf(e);t.reportModel.aggregations.splice(r,1)},t.validate=function(){return t.reportForm.$submitted=!0,t.reportForm.$valid?!0:!1},t.getFilterModel=function(){var r=[],a=angular.copy(t.reportModel.filterList);return angular.forEach(a,function(t){if(t.field&&t.operator&&("empty"===t.operator.name||"not_empty"===t.operator.name||null!=t.value&&void 0!=t.value)){var a=t.field,o=a.name,l={};if(l.field=o,l.operator=t.operator.name,l.value=t.value,l.no=t.no,a=t.field.lookupModulePrimaryField&&"users"!==t.field.lookup_type?t.field.lookupModulePrimaryField:t.field,"empty"!==t.operator.name&&"not_empty"!==t.operator.name){if("picklist"===a.data_type&&(l.value=l.value.label[e.user.tenant_language]),"multiselect"===a.data_type){var i="";angular.forEach(l.value,function(t){i+=t.label[e.user.tenant_language]+"|"}),l.value=i.slice(0,-1)}"lookup"===a.data_type&&"users"===a.lookup_type&&(l.value=0===l.value[0].id?"[me]":l.value[0].id),"checkbox"===a.data_type&&(l.value=l.value.system_code)}else l.value="-";r.push(l)}}),r},t.getFieldModel=function(){var e=[],r=1,o=angular.copy(t.reportModel.aggregations);return angular.forEach(t.fields.selectedFields,function(t){e.push({field:t.name,order:r++})}),"tabular"===t.reportModel.report_type&&angular.forEach(o,function(o){var l=a("filter")(t.fields.selectedFields,{name:o.field},!0)[0];l||e.push({field:o.field,order:r++})}),e},t.save=function(){if(!t.reportForm.$valid)return!1;t.saving=!0;var e={};e.category_id=t.reportModel.category_id,e.module_id=t.reportModel.module_id,e.filters=t.getFilterModel(),e.name=t.reportModel.name,e.report_type=t.reportModel.report_type,e.aggregations=t.reportModel.aggregations,"summary"===e.report_type&&(e.chart=t.reportModel.chart,e.chart.caption=e.name,e.group_field=t.reportModel.group_field,e.sort_field=t.reportModel.sort_field,e.sort_direction="asc",e.aggregations.length<1&&(e.aggregations=[{field:"created_by",aggregation_type:"count"}])),"single"===e.report_type&&(e.aggregations.length<1&&(e.aggregations=[{field:"created_by",aggregation_type:"count"}]),e.widget={name:e.name,color:t.reportModel.widget?t.reportModel.widget.color:null,icon:t.reportModel.widget?t.reportModel.widget.icon:null}),"tabular"===e.report_type&&(e.fields=t.getFieldModel()),"custom"===t.reportModel.sharing_type?(e.shares=[],e.sharing_type="custom",angular.forEach(t.reportModel.shares,function(t){e.shares.push(t.id)})):e.sharing_type=t.reportModel.sharing_type,t.ReportId&&!t.clone?(e.id=t.ReportId,u.updateReport(e).then(function(e){t.saving=!1,window.location="#/app/reports?id="+e.data.id})):u.createReport(e).then(function(e){t.saving=!1,window.location="#/app/reports?id="+e.data.id})},t.step1=function(){return t.reportForm.$submitted=!0,t.reportForm.$valid?(t.wizardStep=1,!0):!1},t.step2=function(){return t.reportForm.$submitted=!0,t.reportForm.$valid?(t.wizardStep=2,!0):!1},t.step3=function(){t.reportForm.$submitted=!0,t.reportForm.$valid&&(t.wizardStep=3)},t.stepBack=function(e){t.wizardStep=e},t.setValideStep3=function(){switch(t.reportModel.report_type){case"tabular":break;case"summary":t.setValide("group_field"),t.setValide("chartTypes"),t.setValide("yaxis_name"),t.setValide("xaxis_name");break;case"single":}},t.setValide=function(){},t.changeGroupField=function(){var r=a("filter")(t.fields.availableFields,{name:t.reportModel.group_field},!0)[0];r&&(t.reportModel.chart.xaxis_name=r["label_"+e.language])},t.setStep1=function(){t.reportModel.report_type=t.currentReport.report_type,t.reportModel.module_id=t.currentReport.module_id,t.reportModel.sharing_type=t.currentReport.sharing_type,t.reportModel.shares=t.currentReport.shares,t.reportModel.name=t.currentReport.name,t.reportModel.filters=t.currentReport.filters,t.selectModule(),t.currentReport.fields&&(t.fields.availableFields=[],t.fields.selectedFields=[],angular.forEach(t.module.fields,function(e){if(!e.deleted&&(s.hasFieldDisplayPermission(e)||"large"==e.multiline_type)){var r=a("filter")(t.currentReport.fields,{field:e.name},!0)[0];r?t.fields.selectedFields.push(e):t.fields.availableFields.push(e)}}),t.fields.availableFields=a("orderBy")(t.fields.availableFields,"order")),t.currentReport.group_field&&(t.reportModel.group_field=t.currentReport.group_field,t.reportModel.sort_field=t.currentReport.sort_field,u.getChart(t.currentReport.id).then(function(e){var r=e.data.chart;t.reportModel.chart={type:r.chart_type,yaxis_name:r.yaxisname,xaxis_name:r.xaxisname}})),"single"===t.currentReport.report_type&&u.getWidget(t.currentReport.id).then(function(e){var r=e.data[0];t.reportModel.widget={color:r.color,icon:r.icon}}),t.reportModel.aggregations=t.currentReport.aggregations,angular.forEach(t.numberField,function(e){var r=a("filter")(t.currentReport.aggregations,{field:e.name},!0)[0];r&&(e.Aggregation=r.aggregation_type+"-"+r.field)}),("single"===t.currentReport.report_type||"summary"===t.currentReport.report_type)&&("count"===t.reportModel.aggregations[0].aggregation_type?t.countField={Aggregation:"count-created_by"}:"")},(t.ReportId||t.clone)&&t.setEdit(t.ReportId)}]);