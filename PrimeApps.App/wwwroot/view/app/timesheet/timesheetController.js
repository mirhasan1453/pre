"use strict";angular.module("primeapps").controller("TimesheetController",["$rootScope","$scope","$state","$location","$filter","$templateCache","$modal","$timeout","$cache","$modal","$q","$http","config","ngToast","calendarConfig","ModuleService",function(e,t,a,r,n,s,l,i,o,p,d,c,m,u,f,v){var h=window.localStorage.NG_TRANSLATE_LANG_KEY||"tr",b=window.localStorage.locale_key||h;if(f.dateFormatter="angular",f.allDateFormats.angular.title.month="MMMM yyyy",f.allDateFormats.angular.title.year="yyyy","tr"===h?(f.allDateFormats.angular.title.week="{week}. Hafta {year}",f.i18nStrings.weekNumber="{week}. Hafta"):(f.allDateFormats.angular.title.week="Week {week} of {year}",f.i18nStrings.weekNumber="Week {week}"),"tr"===b?(f.allDateFormats.angular.date.hour="HH:mm",f.allDateFormats.angular.date.datetime="dd.MM.yyyy HH:mm"):(f.allDateFormats.angular.date.hour="ha",f.allDateFormats.angular.date.datetime="MMM d, h:mm a"),t.timesheetModule=n("filter")(e.modules,{name:"timesheet"},!0)[0],t.timesheetItemModule=n("filter")(e.modules,{name:"timesheet_item"},!0)[0],t.approverModule=n("filter")(e.modules,{name:"approval_workflow"},!0)[0],t.owner=n("filter")(e.users,{id:r.search().user?parseInt(r.search().user):e.user.id},!0)[0],t.projectId=r.search().project,t.month=r.search().month,t.loading=!0,r.search().ctype)switch(r.search().ctype){case"0":t.chargeType="billable";break;case"1":t.chargeType="nonbillable";break;case"2":t.chargeType="business"}if(t.calendarView=t.owner.id===e.user.id?"month":"day",t.calendarDay=new Date,t.loadingCalendar=!0,t.events=[],t.month&&t.calendarDay.setMonth(parseInt(t.month)),!t.owner)return u.create({content:n("translate")("Common.NotFound"),className:"warning"}),void a.go("app.dashboard");t.timesheetTitle=t.owner.id!=e.user.id?t.owner.full_name+"'s Timesheet":"",s.put("views/app/timesheet/templates/calendarMonthCell.html",'<div mwl-droppable on-drop="vm.handleEventDrop(dropData.event, day.date, dropData.draggedFromDate)" mwl-drag-select="!!vm.onDateRangeSelect" on-drag-select-start="vm.onDragSelectStart(day)" on-drag-select-move="vm.onDragSelectMove(day)" on-drag-select-end="vm.onDragSelectEnd(day)" class="cal-month-day {{ day.cssClass }}" ng-class="{ \'cal-day-outmonth\': !day.inMonth, \'cal-day-inmonth\': day.inMonth, \'cal-day-weekend\': day.isWeekend, \'cal-day-past\': day.isPast, \'cal-day-today\': day.isToday, \'cal-day-future\': day.isFuture, \'cal-day-selected\': vm.dateRangeSelect && vm.dateRangeSelect.startDate <= day.date && day.date <= vm.dateRangeSelect.endDate, \'cal-day-open\': dayIndex === vm.openDayIndex }">  <span class="pull-right" data-cal-date ng-click="vm.calendarCtrl.dateClicked(day.date)" ng-bind="day.label"> </span>  <div class="add-button" style=\'z-index: 999\'  ng-if="!day.isWeekend"> <a href class="btn btn-xs btn-default" ng-click="vm.templateScope.openCreateModal($event, day, \'timesheet_item\', null)" ng-if="(!$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet || $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue===\'draft\') && $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.owner.Id == $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.user.ID">+</a> </div>   <div class="add-button" style=\'z-index: 999\'  ng-if="day.isWeekend"> <a href class="btn btn-xs btn-default" confirm-click action="vm.templateScope.openCreateModal($event, day, \'timesheet_item\', null)" placement="left" confirm-message="Weekend, are you sure?" confirm-yes="Yes" confirm-no="No" title="Sil" ng-if="(!$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet || $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue===\'draft\') && $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.owner.Id == $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.user.ID">+</a> </div><span ng-repeat="(type, group) in day.groups track by type" data-trigger="hover" data-placement="top" bs-tooltip> <div class=\'text-center\'> <span ng-if="group.events[0].daysWorked==\'0.5\'" ng-style="{\'background-color\': group.events[0].colorCode}" class=\'morning-box\'></span><span ng-if="group.events[0].daysWorked==\'1\'" ng-style="{\'background-color\': group.events[0].colorCode}" class=\'full-day-box\'></span><span ng-if=\'group.events[1].type\' ng-style="{\'background-color\': group.events[1].colorCode}" class=\'afternoon-box\'></span>&nbsp; </span> </div>  <div class="cal-day-tick" ng-show="dayIndex === vm.openDayIndex && (vm.cellAutoOpenDisabled || vm.view[vm.openDayIndex].events.length > 0) && !vm.slideBoxDisabled"> <i class="glyphicon glyphicon-chevron-up"></i> <i class="fa fa-chevron-up"></i> </div>  <ng-include src="vm.customTemplateUrls.calendarMonthCellEvents || vm.calendarConfig.templates.calendarMonthCellEvents"></ng-include></div>'),s.put("views/app/timesheet/templates/calendarSlideBox.html",'<div class="cal-slide-box" uib-collapse="vm.isCollapsed" mwl-collapse-fallback="vm.isCollapsed"> <div class="cal-slide-content cal-event-list"> <table class="table table-striped"> <thead> <tr> <th>Days Worked</th><th>Entry Type</th> <th>Place of Performance</th> <th>Comments</th> <th>Status</th><th style=\'width: 60px;\'></th></tr></thead> <tbody> <tr ng-style="{\'background-color\': event.colorCode}" ng-repeat="event in vm.events | orderBy:\'startsAt\' track by event.calendarEventId" class="event-line" ng-class="event.cssClass" mwl-draggable="event.draggable===true" drop-data="{event: event}"><td>{{event.daysWorked}} <span ng-if="event.per_diem">( Per Diem )</span></td><td>{{event.entry_type}}</td><td ng-if="event.place_of_performance"><span>{{event.place_of_performance}}</span></td><td ng-if="!event.place_of_performance"><span>{{event.please_specify_country}} - {{event.please_specify}}</span></td><td> <b>{{event.selectedAction}} (Activity Code: {{event.selectedActivityCode}}):</b> {{event.comment}}</td> <td>{{event.status}}</td> <td><span class=\'action-buttons\' ng-if="(!$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet || $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue===\'draft\' || $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue.indexOf(\'rejected\')>-1) && $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.owner.Id == $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.user.ID"> <a ng-click="vm.templateScope.openEditModal($event, vm.cell, \'timesheet_item\', event)" class="action-icon" title="{{\'Common.Edit\' | translate}}"><i class="flaticon-pencil124" ng-if="event.statusValue === \'draft\' || event.statusValue.indexOf(\'rejected\') > -1 "></i></a>&nbsp; <i style=\'cursor: pointer\' class="action-icon flaticon-bin9" confirm-click action="vm.templateScope.delete(event)" placement="left" confirm-message="{{\'Common.AreYouSure\' | translate}}" confirm-yes="{{\'Common.Yes\' | translate}}" confirm-no="{{\'Common.No\' | translate}}" title="{{\'Common.Delete\' | translate}}" ng-if="$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue===\'draft\' && event.statusValue === \'draft\' "></i> </span></td></tr></tbody> </table></div></div>'),s.put("views/app/timesheet/templates/calendarYearView.html",'<div class="cal-year-box"> <div ng-repeat="rowOffset in [0, 4, 8] track by rowOffset"> <div class="row cal-before-eventlist"> <div class="span3 col-md-3 col-xs-6 cal-cell {{ day.cssClass }}" ng-repeat="month in vm.view | calendarLimitTo:4:rowOffset track by $index" ng-init="monthIndex = vm.view.indexOf(month)" ng-click="vm.calendarCtrl.dateClicked(month.date)" ng-class="{\'cal-day-today\': month.isToday}" mwl-droppable on-drop="vm.handleEventDrop(dropData.event, month.date)">  <span class="pull-right" data-cal-date ng-click="vm.calendarCtrl.dateClicked(month.date)" ng-bind="month.label"> </span>  <div class="counts"> <span ng-repeat="(type, group) in month.groups track by type" data-title="{{group.module}}" data-trigger="hover" data-placement="top" bs-tooltip> <span class="label" ng-style="{\'background-color\': group.color}"> {{ group.events.length }} </span>&nbsp; </span> </div>  <div class="cal-day-tick" ng-show="monthIndex === vm.openMonthIndex && (vm.cellAutoOpenDisabled || vm.view[vm.openMonthIndex].events.length > 0) && !vm.slideBoxDisabled"> <i class="glyphicon glyphicon-chevron-up"></i> <i class="fa fa-chevron-up"></i> </div>  </div> </div>  </div>  </div>'),s.put("views/app/timesheet/templates/calendarDayView.html","<div class=\"cal-day-box\"><table class=\"table timesheet-table\"><thead class='thead-border'><tr><th style='text-align: center;'>DAY</th><th style='text-align: center'>DAYS WORKED</th><th>ENTRY TYPE</th><th>CHARGE TYPE</th><th>PLACE OF PERFORMANCE</th><th>COMMENTS</th><th>STATUS</th><th style='width: 60px;'></th></tr></thead><tbody class='tbody-border' ng-repeat=\"data in vm.listViewDays\" ng-init=\"listIndex=$index\" ng-if=\"vm.currentMonth==data.date\"><tr><td rowspan='2' class='text-center month-days'>{{data.label}}</td><td ng-style=\"{'vertical-align': data.events[0].paddingTop, 'background-color': data.events[0].colorCode}\" class='text-center'>&nbsp;{{data.events[0].daysWorked}} <span ng-if=\"data.events[0].per_diem\">&nbsp;( Per Diem )</span></td><td ng-style=\"{'vertical-align': data.events[0].paddingTop, 'background-color': data.events[0].colorCode}\">{{data.events[0].entry_type}}</td><td ng-style=\"{'vertical-align': data.events[0].paddingTop, 'background-color': data.events[0].colorCode}\">{{data.events[0].chargeType}}</td><td ng-if=\"data.events[0].place_of_performance\" ng-style=\"{'vertical-align': data.events[0].paddingTop, 'background-color': data.events[0].colorCode}\">{{data.events[0].place_of_performance}}</td><td ng-if=\"!data.events[0].place_of_performance\" ng-style=\"{'vertical-align': data.events[0].paddingTop, 'background-color': data.events[0].colorCode}\">{{data.events[0].please_specify_country}} <span ng-if=\"data.events[0].please_specify\">-</span> {{data.events[0].please_specify}}</td><td ng-style=\"{'vertical-align': data.events[0].paddingTop, 'background-color': data.events[0].colorCode}\"><span class='selected-action'>{{data.events[0].selectedAction}}</span><span ng-if=\"data.events[0].selectedActivityCode\">(Activity Code: {{data.events[0].selectedActivityCode}})</span><span ng-if=\"data.events[0].type\">:</span>  {{data.events[0].comment}}</td><td ng-style=\"{'vertical-align': data.events[0].paddingTop, 'background-color': data.events[0].colorCode}\">{{data.events[0].status}}</td><td ng-style=\"{'vertical-align': data.events[0].paddingTop, 'background-color': data.events[0].colorCode}\"><span ng-if=\"data.events[0].code && (!$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet || $parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue==='draft' || $parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue.indexOf('rejected')>-1) && $parent.$parent.$parent.$parent.$parent.$parent.$parent.owner.Id == $parent.$parent.$parent.$parent.$parent.$parent.$parent.user.ID\"  class='action-buttons'> <a ng-click=\"vm.templateScope.openEditModal($event, data, 'timesheet_item', data.events[0])\" class=\"action-icon\" title=\"{{'Common.Edit' | translate}}\"><i class=\"flaticon-pencil124\" ng-if=\"data.events[0].statusValue === 'draft' || data.events[0].statusValue.indexOf('rejected') > -1 \"></i></a>&nbsp; <i style='cursor: pointer' class=\"action-icon flaticon-bin9\" confirm-click action=\"vm.templateScope.delete(data.events[0])\" placement=\"left\" confirm-message=\"{{'Common.AreYouSure' | translate}}\" confirm-yes=\"{{'Common.Yes' | translate}}\" confirm-no=\"{{'Common.No' | translate}}\" title=\"{{'Common.Delete' | translate}}\" ng-if=\"$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue==='draft' && data.events[0].statusValue === 'draft' < 0\"></i> </span><span class=\"action-buttons\" style='z-index: 999; padding-right: 15px'  ng-if=\"!data.isWeekend && data.events[0].code != 'morning_only' && data.events[0].code != 'full_day' && data.events[0].code != 'per_diem_only'\"> <a href ng-if=\"(!$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet || $parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue==='draft') && $parent.$parent.$parent.$parent.$parent.$parent.$parent.owner.Id == $parent.$parent.$parent.$parent.$parent.$parent.$parent.user.ID\" ng-click=\"vm.templateScope.openCreateModal($event, data, 'timesheet_item', '1')\"><i class=\"fa fa-plus\"></i></a> </span>   <span class=\"action-buttons\" style='z-index: 999; padding-right: 15px' ng-if=\"data.isWeekend && data.events[0].code != 'morning_only' && data.events[0].code != 'full_day' && data.events[0].code != 'per_diem_only'\"> <a href class=\"action-button\" ng-if=\"(!$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet || $parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue==='draft') && $parent.$parent.$parent.$parent.$parent.$parent.$parent.owner.Id == $parent.$parent.$parent.$parent.$parent.$parent.$parent.user.ID\" confirm-click action=\"vm.templateScope.openCreateModal($event, data, 'timesheet_item', '1')\" placement=\"left\" confirm-message=\"Weekend, are you sure?\" confirm-yes=\"Yes\" confirm-no=\"No\" title=\"Ekle\" ><i class=\"fa fa-plus\"></i></a> </span></td></tr><tr ng-if='data.events[0].daysWorked==1' ng-style=\"{'background-color':  data.events[0].colorCode, 'height': '50%'}\"><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr ng-if='data.events[0].daysWorked!=1' ng-style=\"{'background-color': data.events[1].colorCode, 'height': '50%'}\"><td class='text-center'>&nbsp;{{data.events[1].daysWorked}} <span ng-if=\"data.events[1].per_diem\">( Per Diem )</span></td><td>{{data.events[1].entry_type}}</td><td>{{data.events[1].chargeType}}</td><td ng-if=\"data.events[1].place_of_performance\">{{data.events[1].place_of_performance}}</td><td ng-if=\"!data.events[1].place_of_performance\">{{data.events[1].please_specify_country}} <span ng-if=\"data.events[1].please_specify\">-</span> {{data.events[1].please_specify}}</td><td><span class='selected-action'>{{data.events[1].selectedAction}}</span><span ng-if=\"data.events[1].selectedActivityCode\">(Activity Code: {{data.events[0].selectedActivityCode}})</span><span ng-if=\"data.events[1]\">:</span> {{data.events[1].comment}}</td><td>{{data.events[1].status}}</td><td><span ng-if=\"data.events[1] && (!$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet || $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue==='draft' || $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue.indexOf('rejected')>-1) && $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.owner.Id == $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.user.ID\" class='action-buttons'> <a ng-click=\"vm.templateScope.openEditModal($event, data, 'timesheet_item', data.events[1])\" class=\"action-icon\" title=\"{{'Common.Edit' | translate}}\"><i class=\"flaticon-pencil124\" ng-if=\"data.events[1].statusValue === 'draft' || data.events[1].statusValue.indexOf('rejected') > -1 \"></i></a>&nbsp; <i style='cursor: pointer' class=\"action-icon flaticon-bin9\" confirm-click action=\"vm.templateScope.delete(data.events[1])\" placement=\"left\" confirm-message=\"{{'Common.AreYouSure' | translate}}\" confirm-yes=\"{{'Common.Yes' | translate}}\" confirm-no=\"{{'Common.No' | translate}}\" title=\"{{'Common.Delete' | translate}}\" ng-if=\"$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue==='draft' && data.events[1].statusValue === 'draft' < 0\"></i> </span>  <span class=\"action-buttons\" style='z-index: 999; padding-right: 15px' ng-if=\"!data.isWeekend && data.events[1].code != 'afternoon_only' && data.events[0].code != 'full_day' && data.events[0].code != 'per_diem_only'\"> <a href class=\"action-button\" ng-if=\"(!$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet || $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue==='draft') && $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.owner.Id == $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.user.ID\" ng-click=\"vm.templateScope.openCreateModal($event, data, 'timesheet_item', '2')\"><i class=\"fa fa-plus\"></i></a> </span>   <span class=\"action-buttons\" style='z-index: 999; padding-right: 15px' ng-if=\"data.isWeekend && data.events[1].code != 'afternoon_only' && data.events[0].code != 'full_day' && data.events[0].code != 'per_diem_only'\"> <a href class=\"button-action\" ng-if=\"(!$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet || $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.currentTimesheet.statusValue==='draft') && $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.owner.Id == $parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.$parent.user.ID\" confirm-click action=\"vm.templateScope.openCreateModal($event, data, 'timesheet_item', '2')\" placement=\"left\" confirm-message=\"Weekend, are you sure?\" confirm-yes=\"Yes\" confirm-no=\"No\" title=\"Sil\" ><i class=\"fa fa-plus\"></i></a> </span></td></tr></tbody></table></div>"),s.put("views/app/timesheet/templates/calendarWeekView.html",'<div class="cal-week-box" ng-class="{\'cal-day-box\': vm.showTimes}"> <div class="cal-row-fluid cal-row-head">  <div class="cal-cell1" ng-repeat="day in vm.view.days track by $index" ng-class="{ \'cal-day-weekend\': day.isWeekend, \'cal-day-past\': day.isPast, \'cal-day-today\': day.isToday, \'cal-day-future\': day.isFuture}" mwl-element-dimensions="vm.dayColumnDimensions" mwl-droppable on-drop="vm.eventDropped(dropData.event, day.date)">  <span ng-bind="day.weekDayLabel"></span> <br> <small> <span data-cal-date ng-click="vm.calendarCtrl.dateClicked(day.date)" class="pointer" ng-bind="day.dayLabel"> </span> </small>  </div>  </div>  <div class="cal-day-panel clearfix" ng-style="{height: vm.showTimes ? (vm.dayViewHeight + \'px\') : \'auto\'}">  <mwl-calendar-hour-list day-view-start="vm.dayViewStart" day-view-end="vm.dayViewEnd" day-view-split="vm.dayViewSplit" day-width="vm.dayColumnDimensions.width" view-date="vm.viewDate" on-timespan-click="vm.onTimespanClick" on-date-range-select="vm.onDateRangeSelect" custom-template-urls="vm.customTemplateUrls" cell-modifier="vm.cellModifier" template-scope="vm.templateScope" ng-if="vm.showTimes"> </mwl-calendar-hour-list>  <div class="row" ng-repeat="row in vm.view.eventRows track by $index"> <div class="col-xs-12"> <div class="cal-row-fluid"> <div ng-repeat="eventRow in row.row track by eventRow.event.calendarEventId" ng-class="\'cal-cell\' + (vm.showTimes ? 1 : eventRow.span) + (vm.showTimes ? \'\' : \' cal-offset\' + eventRow.offset)" ng-style="{ top: vm.showTimes ? ((eventRow.top) + \'px\') : \'auto\', position: vm.showTimes ? \'absolute\' : \'inherit\', width: vm.showTimes ? (vm.dayColumnDimensions.width + \'px\') : \'\', left: vm.showTimes ? (vm.dayColumnDimensions.width * eventRow.offset) + 15 + \'px\' : \'\' }"> <div class="day-highlight" ng-class="[eventRow.event.cssClass, !vm.showTimes && eventRow.startsBeforeWeek ? \'\' : \'border-left-rounded\', !vm.showTimes && eventRow.endsAfterWeek ? \'\' : \'border-right-rounded\']" ng-style="{backgroundColor: eventRow.event.color.secondary}" data-event-class mwl-draggable="eventRow.event.draggable === true" axis="vm.showTimes ? \'xy\' : \'x\'" snap-grid="vm.showTimes ? {x: vm.dayColumnDimensions.width, y: vm.dayViewEventChunkSize || 30} : {x: vm.dayColumnDimensions.width}" on-drag="vm.tempTimeChanged(eventRow.event, y / 30)" on-drag-end="vm.weekDragged(eventRow.event, x / vm.dayColumnDimensions.width, y / 30)" mwl-resizable="eventRow.event.resizable === true && eventRow.event.endsAt && !vm.showTimes" resize-edges="{left: true, right: true}" on-resize-end="vm.weekResized(eventRow.event, edge, x / vm.dayColumnDimensions.width)"> <strong ng-bind="(eventRow.event.tempStartsAt || eventRow.event.startsAt) | calendarDate:\'time\':true" ng-show="vm.showTimes"></strong> <a href="#/app/module/{{eventRow.event.type}}{{\'?id=\' + eventRow.event.id + \'&back=calendar\'}}" ng-click="vm.onEventClick({calendarEvent: eventRow.event})" class="event-item" ng-bind-html="vm.calendarEventTitle.weekView(eventRow.event) | calendarTrustAsHtml" uib-tooltip-html="vm.calendarEventTitle.weekViewTooltip(eventRow.event) | calendarTrustAsHtml" tooltip-placement="left" tooltip-append-to-body="true"> </a> </div> </div> </div> </div>  </div>  </div> </div>'),t.calendarCurrentMonth=parseInt(moment(t.calendarDay).month())+1,t.calendarChosenMonth=parseInt(moment(t.calendarDay).month())+1,t.previousMonth=function(){t.calendarChosenMonth--,w(),_()},t.nextMonth=function(){t.calendarChosenMonth++,w(),_()};var y={filters:[{field:"country",operator:"equals",value:"Turkey",no:1}]};y.limit=999,v.findRecords("holidays",y).then(function(e){e.data.length>0&&(t.turkeyHolidays=e.data)});var g=function(a){v.getPicklists(t.approverModule).then(function(r){var s=n("filter")(t.approverModule.fields,{name:"approval_type"},!0)[0],l={fields:["approval_id","first_approver","first_approver_expert","second_approver"],filters:[],limit:1,offset:0};if(t.projectId){l.filters.push({field:"related_project",operator:"equals",value:t.projectId,no:1});var i=n("filter")(r[s.picklist_id],{system_code:"billable"},!0)[0],o=n("filter")(r[s.picklist_id],{system_code:"nonbillable"},!0)[0],p=n("filter")(r[s.picklist_id],{system_code:"business"},!0)[0];"billable"===t.chargeType?l.filters.push({field:"approval_type",operator:"is",value:i["label_"+e.user.tenant_language],no:2}):"nonbillable"===t.chargeType?l.filters.push({field:"approval_type",operator:"is",value:o["label_"+e.user.tenant_language],no:2}):"business"===t.chargeType&&l.filters.push({field:"approval_type",operator:"is",value:p["label_"+e.user.tenant_language],no:2})}else{var f=n("filter")(r[s.picklist_id],{system_code:"management"},!0)[0];l.filters.push({field:"staff",operator:"equals",value:t.currentStaff.id,no:1}),l.filters.push({field:"approval_type",operator:"is",value:f["label_"+e.user.tenant_language],no:2})}v.findRecords("approval_workflow",l).then(function(r){if(!r||!r.data[0])return void u.create({content:n("translate")("Common.Error"),className:"danger"});t.approvers=r.data[0];var s=r.data[0],l={};l.filters=[{field:"e_mail1",operator:"is",value:e.user.email,no:1}];var i={};i.filters=[{field:"e_mail1",operator:"is",value:e.user.email,no:1}];var o=[];o.push(c.post(m.apiUrl+"record/find/human_resources",l)),o.push(c.post(m.apiUrl+"record/find/experts",i)),d.all(o).then(function(e){for(var r=e[0].data[0],l=e[1].data[0],i=n("filter")(a,{related_timesheet:t.currentTimesheet.id},!0),o=0;o<i.length;o++){var p=i[o];if("waiting_first"!==p.statusValue&&"waiting_second"!==p.statusValue){t.alreadyProcessed=!0;break}if("billable"===t.chargeType){if(l&&"waiting_first"===p.statusValue&&s.first_approver_expert!==l.id){t.alreadyProcessed=!0;break}if(r&&"waiting_second"===p.statusValue&&s.second_approver!==r.id){t.alreadyProcessed=!0;break}}else if(r&&("waiting_first"===p.statusValue&&s.first_approver!==r.id||"waiting_second"===p.statusValue&&s.second_approver!==r.id)){t.alreadyProcessed=!0;break}if(!r&&"waiting_first"!==p.statusValue){t.alreadyProcessed=!0;break}}})["finally"](function(){t.loadingCalendar=!1,t.loading=!1})})})},_=function(){var a=n("filter")(t.timesheetItemModule.fields,{name:"entry_type"},!0)[0];t.events=[];var r={};r.filters=[{field:"term",operator:"is",value:t.termPrevious,no:1},{field:"year",operator:"is",value:t.yearPrevious,no:2},{field:"owner",operator:"equals",value:t.owner.id,no:3}],r.limit=1,v.findRecords("timesheet",r).then(function(r){var s=0;r&&r.data.length&&t.owner.id===e.user.id&&(s=r.data[0]);var l={};l.fields=[],angular.forEach(t.timesheetItemModule.fields,function(e){e.deleted||l.fields.push(e.name)}),l.fields.push("selected_project.projects.project_code"),l.fields.push("activity_code2.project_indicators.indicator"),l.filters=[{field:"owner",operator:"equals",value:t.owner.id,no:1}],l.sort_field="created_at",l.sort_direction="desc",l.limit=2e3,s&&l.filters.push({field:"related_timesheet",operator:"equals",value:s.id,no:2}),t.currentTimesheet&&l.filters.push({field:"related_timesheet",operator:"equals",value:t.currentTimesheet.id,no:s?3:2}),t.projectId?(l.filters.push({field:"selected_project",operator:"equals",value:t.projectId,no:s?4:3}),"billable"===t.chargeType?l.filters.push({field:"approval_type",operator:"is",value:"billable",no:s?5:4}):"nonbillable"===t.chargeType?l.filters.push({field:"approval_type",operator:"is",value:"nonbillable",no:s?5:4}):"business"===t.chargeType&&l.filters.push({field:"approval_type",operator:"is",value:"business",no:s?5:4})):t.owner.id!=e.user.id&&l.filters.push({field:"selected_project",operator:"empty",value:"-",no:s?4:3}),s&&t.currentTimesheet&&(l.filter_logic="(1 and (2 or 3))",t.projectId&&(l.filter_logic="(1 and (2 or 3) and 4)"),t.chargeType&&(l.filter_logic="((1 and (2 or 3) and 4) and 5)")),v.getPicklists(t.timesheetItemModule).then(function(r){t.picklistsTimesheetItems=r,t.workedTimeItems=r[a.picklist_id];var s=n("filter")(t.timesheetItemModule.fields,{name:"place_of_performance"},!0)[0],i=n("filter")(t.picklistsTimesheetItems[s.picklist_id],{system_code:"other"},!0)[0];v.findRecords("timesheet_item",l).then(function(a){var r=a.data,s=n("filter")(t.timesheetItemModule.fields,{name:"status"},!0)[0];angular.forEach(r,function(a){var r=moment.utc(a.selected_date).toDate(),l=moment.utc(a.selected_date).toDate(),o={};o.id=a.id,o.title=a.subject?a.subject+' - <span class="event-user">'+a["owner.users.full_name"]+"</span>":a["owner.users.full_name"],o.color={primary:"#fbb903",secondary:"#fdf1ba"},o.module=("tr"===e.language,"Timesheet"),o.type="timesheet_item",o.startsAt=r,o.endsAt=l,o.comment=a.comment2,o.status=a.status,o.per_diem=a.per_diem,o.chargeType=a.charge_type,o.currentListMonth=parseInt(moment(r).month())+1,a.selected_company?o.selectedAction=a.selected_company:(o.selectedAction=a["selected_project.projects.project_code"],o.selectedActivityCode=a["activity_code2.project_indicators.indicator"]),o.place_of_performance=a.place_of_performance==i.labelStr?null:a.place_of_performance,o.please_specify=a.please_specify,o.please_specify_country=a.please_specify_country,o.entry_type=a.entry_type;var p=n("filter")(t.workedTimeItems,{labelStr:o.entry_type},!0)[0].system_code;o.eventEntryType=p,"billable"===a.approval_type?(o.colorCode="rgba(238, 109, 26, 0.14)",o.paddingTop="middle",o.code=p):"nonbillable"===a.approval_type?(o.colorCode="rgba(1, 160, 228, 0.14)",o.paddingTop="middle",o.code=p):"management"===a.approval_type?(o.colorCode="rgba(184, 193, 16, 0.14)",o.code=p):"business"===a.approval_type?(o.colorCode="rgba(157, 0, 255, 0.08)",o.code=p):(o.colorCode="rgba(157, 0, 255, 0.08)",o.code=p),o.daysWorked="full_day"===p||"per_diem_only"===p?"1":"0.5",t.events.push(o);var d=n("filter")(t.picklistsTimesheetItems[s.picklist_id],{labelStr:a.status},!0)[0];a.statusValue=d.value,o.statusValue=a.statusValue}),t.timesheetItems=r,t.owner.id!==e.user.id?g(r):(t.loadingCalendar=!1,t.loading=!1)})}),i(function(){o.put("timesheet_events",t.events)},5e3)})},$=function(){var a=d.defer(),r={};return r.fields=[],angular.forEach(t.timesheetItemModule.fields,function(e){e.deleted||r.fields.push(e.name)}),r.fields.push("selected_project.projects.project_code"),r.fields.push("activity_code2.project_indicators.indicator"),r.filters=[{field:"owner",operator:"equals",value:t.owner.id,no:1}],r.sort_field="created_at",r.sort_direction="desc",r.limit=2e3,t.currentTimesheet&&r.filters.push({field:"related_timesheet",operator:"equals",value:t.currentTimesheet.id,no:2}),t.projectId?r.filters.push({field:"selected_project",operator:"equals",value:t.projectId,no:t.currentTimesheet?3:4}):t.owner.id!=e.user.id&&r.filters.push({field:"selected_project",operator:"empty",value:"-",no:t.currentTimesheet?3:4}),v.getPicklists(t.timesheetItemModule).then(function(e){t.picklistsTimesheetItems=e,v.findRecords("timesheet_item",r).then(function(e){a.resolve(e.data)})}),a.promise},w=function(){var e=d.defer();return t.currentTimesheet=null,t.currentTimesheetItems=null,v.getPicklists(t.timesheetModule).then(function(a){t.picklistsTimesheet=a;var s=n("filter")(t.timesheetModule.fields,{name:"term"},!0)[0],l=n("filter")(t.timesheetModule.fields,{name:"year"},!0)[0],i=parseInt(moment(t.calendarDay).month())+1,o=parseInt(moment(t.calendarDay).month()),p=new Date;11===o&&0===p.getMonth()&&r.search().month&&(t.calendarDay.setYear(moment(t.calendarDay).year()-1),o=12);var d=moment(t.calendarDay).year(),c=moment(t.calendarDay).year();0===o&&(o=12),t.termCurrent=n("filter")(a[s.picklist_id],{value:i.toString()},!0)[0].labelStr,t.yearCurrent=n("filter")(a[l.picklist_id],{value:d.toString()},!0)[0].labelStr,t.termPrevious=n("filter")(a[s.picklist_id],{value:o.toString()},!0)[0].labelStr,t.yearPrevious=n("filter")(a[l.picklist_id],{value:c.toString()},!0)[0].labelStr;var m={};m.filters=[{field:"term",operator:"is",value:t.termCurrent,no:1},{field:"year",operator:"is",value:t.yearCurrent,no:2},{field:"owner",operator:"equals",value:t.owner.id,no:3}],m.limit=1,v.findRecords("timesheet",m).then(function(a){if(!a||!a.data.length)return e.resolve({}),e.promise;t.currentTimesheet=a.data[0];var r=n("filter")(t.timesheetModule.fields,{name:"status"},!0)[0],s=n("filter")(t.picklistsTimesheet[r.picklist_id],{labelStr:t.currentTimesheet.status},!0)[0];t.currentTimesheet.statusValue=s.value,$().then(function(a){return a&&a.length?(t.projectIds=[],angular.forEach(a,function(e){var a=n("filter")(t.timesheetItemModule.fields,{name:"charge_type"},!0)[0],r=n("filter")(t.picklistsTimesheetItems[a.picklist_id],{labelStr:e.charge_type},!0)[0];e.approverType=r.value;var s=n("filter")(t.timesheetItemModule.fields,{name:"status"},!0)[0],l=angular.isObject(e.status)?e.status:n("filter")(t.picklistsTimesheetItems[s.picklist_id],{labelStr:e.status},!0)[0];e.statusValue=l.value;var i=e.selected_project?parseInt(e.selected_project):0;i>0&&t.projectIds.indexOf(i)<0&&t.projectIds.push(i)}),t.currentTimesheetItems=a,void e.resolve({})):(e.resolve({}),e.promise)})})}),e.promise},T=function(){var e={};e.filters=[{field:"e_mail1",operator:"is",value:t.owner.email,no:1}],v.findRecords("human_resources",e).then(function(e){t.currentStaff=e.data[0],t.currentStaff||(t.isExpert=!0)})};w().then(function(){_(),T()}),t.groupEvents=function(e){e.events&&e.events.length&&(e.groups={},e.events.forEach(function(t){e.groups[t.type]=e.groups[t.type]||{},e.groups[t.type].module=t.module,e.groups[t.type].color=t.color.primary,e.groups[t.type].events=e.groups[t.type].events||[],e.groups[t.type].events.push(t)}),angular.forEach(e.groups,function(e){var t=angular.copy(e.events);angular.forEach(t,function(a){"morning_only"==a.code?e.events[0]=a:"afternoon_only"==a.code&&(t.length>1?e.events[1]=a:e.events[0]=[],e.events[1]=a)})}))},t["delete"]=function(e){v.deleteRecord(e.type,e.id).then(function(){_(),o.remove(e.type+"_"+e.type)})},t.openCreateModal=function(e,a,r,n){a&&("month"===t.calendarView?t.calendarDate=a.date:(t.calendarDate=a.fullDate,t.selectedDayTime=n)),t.editModuleLoading=!1,t.day=a,t.requestType="create",t.currentLookupField={lookup_type:r},t.formModal=t.formModal||l({scope:t,templateUrl:"view/app/timesheet/timesheetModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.formModal.$promise.then(t.formModal.show)
},t.openEditModal=function(e,a,r,n){a&&(t.calendarDate=a.fullDate?a.fullDate:a.date),t.editModuleLoading=!0,t.day=a,t.requestType="edit",t.editData=n,t.currentLookupField={lookup_type:r},t.formModal=t.formModal||l({scope:t,templateUrl:"view/app/timesheet/timesheetModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.formModal.$promise.then(t.formModal.show)},t.formModalSuccess=function(){w().then(function(){_()})};var x=function(){var e=d.defer();return v.getPicklists(t.approverModule).then(function(a){var r={};t.picklistsApprover=a;var s=n("filter")(t.approverModule.fields,{name:"approval_type"},!0)[0],l=n("filter")(a[s.picklist_id],{system_code:"management"},!0)[0],i=["approval_id","approval_type","related_project","related_project.projects.project_code.primary","staff","staff.human_resources.name_surname.primary","staff.human_resources.e_mail1","first_approver","first_approver.human_resources.name_surname.primary","first_approver.human_resources.e_mail1","first_approver_expert","first_approver_expert.experts.name_surname.primary","first_approver_expert.experts.e_mail1","second_approver","second_approver.human_resources.name_surname.primary","second_approver.human_resources.e_mail1"],o=function(){var l={fields:i,filters:[],logic_type:"or",limit:2e3,offset:0};if(t.projectIds)for(var o=0;o<t.projectIds.length;o++){var p={field:"related_project.projects.id",operator:"equals",value:t.projectIds[o],no:o+1};l.filters.push(p)}v.findRecords("approval_workflow",l).then(function(t){var l=t.data;l&&l.length>0&&angular.forEach(l,function(e){var t=n("filter")(a[s.picklist_id],{labelStr:e.approval_type},!0)[0];e.approvalType=t.system_code}),r.project=l,e.resolve(r)})},p=function(){var e={fields:i,filters:[{field:"staff",operator:"equals",value:t.currentStaff.id,no:1},{field:"approval_type",operator:"is",value:l.labelStr,no:2}],limit:2e3,offset:0};v.findRecords("approval_workflow",e).then(function(e){var t=e.data;t&&t.length>0&&angular.forEach(t,function(e){var t=n("filter")(a[s.picklist_id],{labelStr:e.approval_type},!0)[0];e.approvalType=t.system_code}),r.management=t[0],o()})};t.isExpert?o():p()}),e.promise};t.submitApproval=function(a,r,s){t.submitting=!0;var l=null;l=a?a:n("filter")(e.users,{id:e.user.id},!0)[0],x().then(function(i){if(!i)return u.create({content:"Approvers not found. Please contact your system administrator.",className:"warning"}),void(t.submitting=!1);for(var o=[],p=!1,f=n("filter")(t.timesheetItemModule.fields,{name:"status"},!0)[0],v=n("filter")(t.picklistsTimesheetItems[f.picklist_id],{value:"waiting_first"},!0)[0],h=n("filter")(t.picklistsTimesheetItems[f.picklist_id],{value:"waiting_second"},!0)[0],b=n("filter")(t.picklistsTimesheetItems[f.picklist_id],{value:"approved_second"},!0)[0],y=0;y<t.currentTimesheetItems.length;y++){var g=t.currentTimesheetItems[y];if(!p&&"waiting_second"!==g.statusValue&&"approved_second"!==g.statusValue){var _;if(_="management"===g.approverType?i.management:n("filter")(i.project,{approvalType:g.approverType},!0)[0],("waiting_first"!==g.statusValue&&"approved_first"!==g.statusValue||_.second_approver)&&(!r||"rejected_first"===g.statusValue||"rejected_second"===g.statusValue)){var $={};$.timesheetItemId=g.id,$.chargeType=g.approval_type;var T=null;switch(g.approverType){case"billable":if($.projectId=g.selected_project,T=n("filter")(i.project,{"related_project.projects.id":$.projectId,approvalType:"billable"},!0)[0],!T){p=!0;break}"draft"===g.statusValue||"rejected_first"===g.statusValue?($.full_name=T["first_approver_expert.experts.name_surname.primary"],$.email=T["first_approver_expert.experts.e_mail1"],$.timesheetItemStatus=v.id,$["1_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id):("approved_first"===g.statusValue||"rejected_second"===g.statusValue)&&($.full_name=T["second_approver.human_resources.name_surname.primary"],$.email=T["second_approver.human_resources.e_mail1"],$.timesheetItemStatus=h.id,$["2_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id);break;case"nonbillable":if($.projectId=g.selected_project,T=n("filter")(i.project,{"related_project.projects.id":$.projectId,approvalType:"nonbillable"},!0)[0],!T){p=!0;break}"draft"!==g.statusValue&&"rejected_first"!==g.statusValue||t.owner.email!=T["first_approver.human_resources.e_mail1"]?"draft"===g.statusValue||"rejected_first"===g.statusValue?($.full_name=T["first_approver.human_resources.name_surname.primary"],$.email=T["first_approver.human_resources.e_mail1"],$.timesheetItemStatus=v.id,$["1_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id):"approved_first"!==g.statusValue&&"rejected_second"!==g.statusValue||t.owner.email===T["first_approver.human_resources.e_mail1"]?("approved_first"===g.statusValue||"rejected_second"===g.statusValue)&&($.full_name=T["second_approver.human_resources.name_surname.primary"],$.email=T["second_approver.human_resources.e_mail1"],$.timesheetItemStatus=h.id,$["2_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id):($.full_name=T["second_approver.human_resources.name_surname.primary"],$.email=T["second_approver.human_resources.e_mail1"],$.timesheetItemStatus=b.id,$["2_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id):($.full_name=T["second_approver.human_resources.name_surname.primary"],$.email=T["second_approver.human_resources.e_mail1"],$.timesheetItemStatus=h.id,$["2_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id);break;case"business":if($.projectId=g.selected_project,T=n("filter")(i.project,{"related_project.projects.id":$.projectId,approvalType:"business"},!0)[0],!T){p=!0;break}"draft"!==g.statusValue&&"rejected_first"!==g.statusValue||t.owner.email!=T["first_approver.human_resources.e_mail1"]?"draft"===g.statusValue||"rejected_first"===g.statusValue?($.full_name=T["first_approver.human_resources.name_surname.primary"],$.email=T["first_approver.human_resources.e_mail1"],$.timesheetItemStatus=v.id,$["1_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id):"approved_first"!==g.statusValue&&"rejected_second"!==g.statusValue||t.owner.email===T["first_approver.human_resources.e_mail1"]?("approved_first"===g.statusValue||"rejected_second"===g.statusValue)&&($.full_name=T["second_approver.human_resources.name_surname.primary"],$.email=T["second_approver.human_resources.e_mail1"],$.timesheetItemStatus=h.id,$["2_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id):($.full_name=T["second_approver.human_resources.name_surname.primary"],$.email=T["second_approver.human_resources.e_mail1"],$.timesheetItemStatus=b.id,$["2_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id):($.fullfull_nameName=T["second_approver.human_resources.name_surname.primary"],$.email=T["second_approver.human_resources.e_mail1"],$.timesheetItemStatus=h.id,$["2_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id);break;case"management":if(T=i.management,!T){p=!0;break}"draft"===g.statusValue||"rejected_first"===g.statusValue?($.full_name=T["first_approver.human_resources.name_surname.primary"],$.email=T["first_approver.human_resources.e_mail1"],$.timesheetItemStatus=v.id,$["1_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id):("approved_first"===g.statusValue||"rejected_second"===g.statusValue)&&($.full_name=T["second_approver.human_resources.name_surname.primary"],$.email=T["second_approver.human_resources.e_mail1"],$.timesheetItemStatus=h.id,$["2_approver"]=n("filter")(e.users,{email:$.email},!0)[0].id)}o.push($)}}}if(p)return u.create({content:"Approvers not found. Please contact your system administrator.",className:"warning"}),void(t.submitting=!1);if(!o.length&&a)return u.create({content:"Timesheet approved succesfully.",className:"success"}),t.submitting=!1,void(t.approved=!0);var x='<!DOCTYPE html> <html> <head> <meta name="viewport" content="width=device-width"> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <style type="text/css"> @media only screen and (max-width: 620px) { table[class=body] h1 { font-size: 28px !important; margin-bottom: 10px !important; } table[class=body] p, table[class=body] ul, table[class=body] ol, table[class=body] td, table[class=body] span, table[class=body] a { font-size: 16px !important; } table[class=body] .wrapper, table[class=body] .article { padding: 10px !important; } table[class=body] .content { padding: 0 !important; } table[class=body] .container { padding: 0 !important; width: 100% !important; } table[class=body] .main { border-left-width: 0 !important; border-radius: 0 !important; border-right-width: 0 !important; } table[class=body] .btn table { width: 100% !important; } table[class=body] .btn a { width: 100% !important; } table[class=body] .img-responsive { height: auto !important; max-width: 100% !important; width: auto !important; }} @media all { .ExternalClass { width: 100%; } .ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div { line-height: 100%; } .apple-link a { color: inherit !important; font-family: inherit !important; font-size: inherit !important; font-weight: inherit !important; line-height: inherit !important; text-decoration: none !important; } .btn-primary table td:hover { background-color: #34495e !important; } .btn-primary a:hover { background-color: #34495e !important; border-color: #34495e !important; } } </style> </head> <body class="" style="background-color:#f6f6f6;font-family:sans-serif;-webkit-font-smoothing:antialiased;font-size:14px;line-height:1.4;margin:0;padding:0;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;"> <table border="0" cellpadding="0" cellspacing="0" class="body" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;background-color:#f6f6f6;width:100%;"> <tr> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;">&nbsp;</td> <td class="container" style="font-family:sans-serif;font-size:14px;vertical-align:top;display:block;max-width:580px;padding:10px;width:580px;Margin:0 auto !important;"> <div class="content" style="box-sizing:border-box;display:block;Margin:0 auto;max-width:580px;padding:10px;"> <!-- START CENTERED WHITE CONTAINER --> <table class="main" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;background:#fff;border-radius:3px;width:100%;"> <!-- START MAIN CONTENT AREA --> <tr> <td class="wrapper" style="font-family:sans-serif;font-size:14px;vertical-align:top;box-sizing:border-box;padding:20px;"> <table border="0" cellpadding="0" cellspacing="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;width:100%;"> <tr> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;"> Dear {approver}, <br><br><b>{owner}</b> has requested to check the relevant Timesheet. For checking, please click on the button below. <br>{firstApprover}<br><br>Regards,<br>PGInternational<br><br><table border="0" cellpadding="0" cellspacing="0" class="btn btn-primary" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;box-sizing:border-box;width:100%;"> <tbody> <tr> <td align="left" style="font-family:sans-serif;font-size:14px;vertical-align:top;padding-bottom:15px;"> <table border="0" cellpadding="0" cellspacing="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;width:100%;width:auto;"> <tbody> <tr> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;background-color:#ffffff;border-radius:5px;text-align:center;background-color:#3498db;"> <a href="https://bee.pginternational.com/#/app/timesheet?user={user}&project={project}&month={month}{chargeType}" target="_blank" style="text-decoration:underline;background-color:#ffffff;border:solid 1px #3498db;border-radius:5px;box-sizing:border-box;color:#3498db;cursor:pointer;display:inline-block;font-size:14px;font-weight:bold;margin:0;padding:12px 25px;text-decoration:none;background-color:#3498db;border-color:#3498db;color:#ffffff;">Go to {owner}\'s Timesheet</a> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table></td> </tr> </table> </td> </tr> <!-- END MAIN CONTENT AREA --> </table> <!-- START FOOTER --> <div class="footer" style="clear:both;padding-top:10px;text-align:center;width:100%;"> <table border="0" cellpadding="0" cellspacing="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;width:100%;"> <tr> <td class="content-block" style="font-family:sans-serif;font-size:14px;vertical-align:top;color:#999999;font-size:12px;text-align:center;"> <br><span class="apple-link" style="color:#999999;font-size:12px;text-align:center;"></span> </td> </tr> </table> </div> <!-- END FOOTER --> <!-- END CENTERED WHITE CONTAINER --> </div> </td> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;">&nbsp;</td> </tr> </table> </body> </html>';x=x.replaceAll("{owner}",l.full_name),x=x.replaceAll("{month}",moment(t.calendarDay).month());for(var k=[],C=[],I=0;I<o.length;I++){var $=o[I],j=n("filter")(C,{approverEmail:$.email},!0);if(j.length&&$.projectId&&(j=n("filter")(j,{projectId:$.projectId},!0)),!j||!j.length){var E=angular.copy(x);E=E.replaceAll("{approver}",$.full_name),E=E.replaceAll("{user}",l.id),E=E.replaceAll("{project}",$.projectId||""),E="billable"===$.chargeType?E.replaceAll("{chargeType}","&ctype=0"):"nonbillable"===$.chargeType?E.replaceAll("{chargeType}","&ctype=1"):"business"===$.chargeType?E.replaceAll("{chargeType}","&ctype=2"):E.replaceAll("{chargeType}",""),E=E.replaceAll("{timesheet}",t.currentTimesheet.year+"-"+t.currentTimesheet.term),E=s?E.replaceAll("{firstApprover}","<br> It was previously approved by First Approver <b>"+s.name_surname+"</b>"):E.replaceAll("{firstApprover}","<br>");var M={};M.Subject=l.full_name+" has requested that you approve the Timesheet ("+t.currentTimesheet.year+"-"+t.currentTimesheet.term+")",M.Template_With_Body=E,M.To_Addresses=[$.email],$.timesheetItemStatus!==b.id&&k.push(c.post(m.apiUrl+"messaging/send_external_email",M));var D={};D.approverEmail=$.email,$.projectId&&(D.projectId=$.projectId),C.push(D)}var A={};A.id=$.timesheetItemId,A.status=$.timesheetItemStatus,$["1_approver"]&&(A["1_approver"]=$["1_approver"]),$["2_approver"]&&(A["2_approver"]=$["2_approver"]),k.push(c.put(m.apiUrl+"record/update/"+t.timesheetItemModule.name+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),A))}k.length?d.all(k).then(function(e){var r=!1;if(angular.forEach(e,function(e){r||200!=e.status&&(r=!0)}),r)return void u.create({content:n("translate")("Common.Error"),className:"danger"});var s={};s.id=t.currentTimesheet.id,s.status=v.id,c.put(m.apiUrl+"record/update/"+t.timesheetModule.name+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),s).then(function(){w(),a?(u.create({content:"Timesheet approved succesfully.",className:"success"}),t.approved=!0):u.create({content:"Timesheet submitted for approval succesfully.",className:"success"})})["finally"](function(){t.submitting=!1,t.approving=!1})}):t.approving=!1})},t.approveApproval=function(){t.approving=!0,v.getPicklists(t.approverModule).then(function(a){var r=n("filter")(t.approverModule.fields,{name:"approval_type"},!0)[0],s={fields:["approval_id","first_approver","first_approver_expert","second_approver"],filters:[],limit:1,offset:0};if(t.projectId){s.filters.push({field:"related_project",operator:"equals",value:t.projectId,no:1});var l=n("filter")(a[r.picklist_id],{system_code:"billable"},!0)[0],i=n("filter")(a[r.picklist_id],{system_code:"nonbillable"},!0)[0],o=n("filter")(a[r.picklist_id],{system_code:"business"},!0)[0];"billable"===t.chargeType?s.filters.push({field:"approval_type",operator:"is",value:l["label_"+e.user.tenant_language],no:2}):"nonbillable"===t.chargeType?s.filters.push({field:"approval_type",operator:"is",value:i["label_"+e.user.tenant_language],no:2}):"business"===t.chargeType&&s.filters.push({field:"approval_type",operator:"is",value:o["label_"+e.user.tenant_language],no:2})}else{var p=n("filter")(a[r.picklist_id],{system_code:"management"},!0)[0];s.filters.push({field:"staff",operator:"equals",value:t.currentStaff.id,no:1}),s.filters.push({field:"approval_type",operator:"is",value:p["label_"+e.user.tenant_language],no:2})}v.findRecords("approval_workflow",s).then(function(a){if(!a||!a.data[0])return void u.create({content:n("translate")("Common.Error"),className:"danger"});var r={};r.filters=[{field:"e_mail1",operator:"is",value:e.user.email,no:1}];var s=function(r){for(var s=r.data[0],l=a.data[0],i=n("filter")(t.timesheetItemModule.fields,{name:"status"},!0)[0],o=n("filter")(t.picklistsTimesheetItems[i.picklist_id],{value:"approved_first"},!0)[0],p=n("filter")(t.picklistsTimesheetItems[i.picklist_id],{value:"approved_second"},!0)[0],f=0,v=[],h=0;h<t.timesheetItems.length;h++){var b=t.timesheetItems[h];if("waiting_first"===b.statusValue&&l.second_approver)b.statusValue="approved_first",b.status=o;else if("waiting_first"!==b.statusValue||l.second_approver){if("waiting_second"!==b.statusValue||!s||l.second_approver!==s.id)continue;b.statusValue="approved_second",b.status=p}else b.statusValue="approved_second",b.status=p;var y=n("filter")(t.currentTimesheetItems,{id:b.id},!0)[0];y.statusValue=b.statusValue,f=b.owner;var g={};g.id=b.id,g.status=b.status.id,v.push(c.put(m.apiUrl+"record/update/"+t.timesheetItemModule.name+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),g))}return v.length?void d.all(v).then(function(a){var r=!1;if(angular.forEach(a,function(e){r||200!=e.status&&(r=!0)}),r)return void u.create({content:n("translate")("Common.Error"),className:"danger"});var l=n("filter")(e.users,{id:f},!0)[0];t.submitApproval(l,!1,s)}):(u.create({content:"You already approved or rejected this timesheet.",className:"warning"}),t.approving=!1,void(t.approved=!0))};a.data[0].first_approver_expert&&!a.data[0].first_approver?v.findRecords("experts",r).then(function(e){e.data.length?s(e):v.findRecords("human_resources",r).then(function(e){s(e)})}):v.findRecords("human_resources",r).then(function(e){s(e)})})})},t.openRejectApprovalModal=function(){t.rejectModal=t.rejectModal||l({scope:t,templateUrl:"view/app/timesheet/rejectModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.rejectModal.$promise.then(t.rejectModal.show)},t.rejectApproval=function(a){t.rejecting=!0,v.getPicklists(t.approverModule).then(function(r){var s=n("filter")(t.approverModule.fields,{name:"approval_type"},!0)[0],l={fields:["approval_id","first_approver","first_approver_expert","second_approver"],filters:[],limit:1,offset:0};if(t.projectId){l.filters.push({field:"related_project",operator:"equals",value:t.projectId,no:1});var i=n("filter")(r[s.picklist_id],{system_code:"billable"},!0)[0],o=n("filter")(r[s.picklist_id],{system_code:"nonbillable"},!0)[0],p=n("filter")(r[s.picklist_id],{system_code:"business"},!0)[0];"billable"===t.chargeType?l.filters.push({field:"approval_type",operator:"is",value:i["label_"+e.user.tenant_language],no:2}):"nonbillable"===t.chargeType?l.filters.push({field:"approval_type",operator:"is",value:o["label_"+e.user.tenant_language],no:2}):"business"===t.chargeType&&l.filters.push({field:"approval_type",operator:"is",value:p["label_"+e.user.tenant_language],no:2})}else{var f=n("filter")(r[s.picklist_id],{system_code:"management"},!0)[0];l.filters.push({field:"staff",operator:"equals",value:t.currentStaff.id,no:1}),l.filters.push({field:"approval_type",operator:"is",value:f["label_"+e.user.tenant_language],no:2})}v.findRecords("approval_workflow",l).then(function(r){if(!r||!r.data[0])return void u.create({content:n("translate")("Common.Error"),className:"danger"});var s={};s.filters=[{field:"e_mail1",operator:"is",value:e.user.email,no:1}],v.findRecords("human_resources",s).then(function(s){for(var l=s.data[0],i=r.data[0],o=n("filter")(t.timesheetItemModule.fields,{name:"status"},!0)[0],p=n("filter")(t.picklistsTimesheetItems[o.picklist_id],{value:"rejected_first"},!0)[0],f=(n("filter")(t.picklistsTimesheetItems[o.picklist_id],{value:"rejected_second"},!0)[0],0),h=0,b=[],y=0;y<t.timesheetItems.length;y++){var g=t.timesheetItems[y];if("waiting_first"===g.statusValue)f=p.id;else{if("waiting_second"!==g.statusValue||!l||i.second_approver!==l.id)continue;f=p.id}h=g.owner;var _={};_.id=g.id,_.status=f,b.push(c.put(m.apiUrl+"record/update/"+t.timesheetItemModule.name+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),_))}if(!b.length)return u.create({content:"You already rejected or approved this timesheet.",className:"warning"}),t.approving=!1,void(t.approved=!0);var $=n("filter")(e.users,{id:h},!0)[0],w={};w.id=t.currentTimesheet.id,w.status=f,b.push(c.put(m.apiUrl+"record/update/"+t.timesheetModule.name+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),w)),d.all(b).then(function(r){var s=!1;if(angular.forEach(r,function(e){s||200!=e.status&&(s=!0)}),s)return void u.create({content:n("translate")("Common.Error"),className:"danger"});var l='<!DOCTYPE html> <html> <head> <meta name="viewport" content="width=device-width"> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <title></title> <style type="text/css"> @media only screen and (max-width: 620px) { table[class=body] h1 { font-size: 28px !important; margin-bottom: 10px !important; } table[class=body] p, table[class=body] ul, table[class=body] ol, table[class=body] td, table[class=body] span, table[class=body] a { font-size: 16px !important; } table[class=body] .wrapper, table[class=body] .article { padding: 10px !important; } table[class=body] .content { padding: 0 !important; } table[class=body] .container { padding: 0 !important; width: 100% !important; } table[class=body] .main { border-left-width: 0 !important; border-radius: 0 !important; border-right-width: 0 !important; } table[class=body] .btn table { width: 100% !important; } table[class=body] .btn a { width: 100% !important; } table[class=body] .img-responsive { height: auto !important; max-width: 100% !important; width: auto !important; }} @media all { .ExternalClass { width: 100%; } .ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div { line-height: 100%; } .apple-link a { color: inherit !important; font-family: inherit !important; font-size: inherit !important; font-weight: inherit !important; line-height: inherit !important; text-decoration: none !important; } .btn-primary table td:hover { background-color: #34495e !important; } .btn-primary a:hover { background-color: #34495e !important; border-color: #34495e !important; } } </style> </head> <body class="" style="background-color:#f6f6f6;font-family:sans-serif;-webkit-font-smoothing:antialiased;font-size:14px;line-height:1.4;margin:0;padding:0;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;"> <table border="0" cellpadding="0" cellspacing="0" class="body" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;background-color:#f6f6f6;width:100%;"> <tr> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;">&nbsp;</td> <td class="container" style="font-family:sans-serif;font-size:14px;vertical-align:top;display:block;max-width:580px;padding:10px;width:580px;Margin:0 auto !important;"> <div class="content" style="box-sizing:border-box;display:block;Margin:0 auto;max-width:580px;padding:10px;"> <!-- START CENTERED WHITE CONTAINER --> <table class="main" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;background:#fff;border-radius:3px;width:100%;"> <!-- START MAIN CONTENT AREA --> <tr> <td class="wrapper" style="font-family:sans-serif;font-size:14px;vertical-align:top;box-sizing:border-box;padding:20px;"> <table border="0" cellpadding="0" cellspacing="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;width:100%;"> <tr> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;"> Dear {owner}, <br><br><b>{approver}</b> has rejected {timesheetOwner} ({timesheet}). Please see the message below and revise the Timesheet by clicking on the button below. <br><br> Message: &nbsp;{message}<br><br><br><br><table border="0" cellpadding="0" cellspacing="0" class="btn btn-primary" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;box-sizing:border-box;width:100%;"> <tbody> <tr> <td align="left" style="font-family:sans-serif;font-size:14px;vertical-align:top;padding-bottom:15px;"> <table border="0" cellpadding="0" cellspacing="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;width:100%;width:auto;"> <tbody> <tr> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;background-color:#ffffff;border-radius:5px;text-align:center;background-color:#3498db;"> <a href="https://bee.pginternational.com/#/app/timesheet?month={month}" target="_blank" style="text-decoration:underline;background-color:#ffffff;border:solid 1px #3498db;border-radius:5px;box-sizing:border-box;color:#3498db;cursor:pointer;display:inline-block;font-size:14px;font-weight:bold;margin:0;padding:12px 25px;text-decoration:none;background-color:#3498db;border-color:#3498db;color:#ffffff;">Go to {timesheetOwner}</a> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table></td> </tr> </table> </td> </tr> <!-- END MAIN CONTENT AREA --> </table> <!-- START FOOTER --> <div class="footer" style="clear:both;padding-top:10px;text-align:center;width:100%;"> <table border="0" cellpadding="0" cellspacing="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;width:100%;"> <tr> <td class="content-block" style="font-family:sans-serif;font-size:14px;vertical-align:top;color:#999999;font-size:12px;text-align:center;"> <br><span class="apple-link" style="color:#999999;font-size:12px;text-align:center;"></span> </td> </tr> </table> </div> <!-- END FOOTER --> <!-- END CENTERED WHITE CONTAINER --> </div> </td> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;">&nbsp;</td> </tr> </table> </body> </html>';l=l.replaceAll("{owner}",$.full_name),l=l.replaceAll("{approver}",e.user.full_name),l=l.replaceAll("{message}",a.replace(/(?:\r\n|\r|\n)/g,"<br>")),l=l.replaceAll("{timesheet}",t.currentTimesheet.year+"-"+t.currentTimesheet.term),l=l.replaceAll("{month}",moment(t.calendarDay).month()),l=l.replaceAll("{timesheetOwner}","Your Timesheet");var i={};i.Subject=e.user.full_name+" has rejected your Timesheet ("+t.currentTimesheet.year+"-"+t.currentTimesheet.term+")",i.Template_With_Body=l,i.To_Addresses=[$.email],c.post(m.apiUrl+"messaging/send_external_email",i).then(function(){if("waiting_second"===t.currentTimesheetItems[0].statusValue){var r,n={};r="billable"===t.currentTimesheetItems[0].approverType?t.approvers.first_approver_expert:t.approvers.first_approver,n.filters=[{field:"id",operator:"equals",value:r,no:1}];var s=function(r){var n='<!DOCTYPE html> <html> <head> <meta name="viewport" content="width=device-width"> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <title></title> <style type="text/css"> @media only screen and (max-width: 620px) { table[class=body] h1 { font-size: 28px !important; margin-bottom: 10px !important; } table[class=body] p, table[class=body] ul, table[class=body] ol, table[class=body] td, table[class=body] span, table[class=body] a { font-size: 16px !important; } table[class=body] .wrapper, table[class=body] .article { padding: 10px !important; } table[class=body] .content { padding: 0 !important; } table[class=body] .container { padding: 0 !important; width: 100% !important; } table[class=body] .main { border-left-width: 0 !important; border-radius: 0 !important; border-right-width: 0 !important; } table[class=body] .btn table { width: 100% !important; } table[class=body] .btn a { width: 100% !important; } table[class=body] .img-responsive { height: auto !important; max-width: 100% !important; width: auto !important; }} @media all { .ExternalClass { width: 100%; } .ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div { line-height: 100%; } .apple-link a { color: inherit !important; font-family: inherit !important; font-size: inherit !important; font-weight: inherit !important; line-height: inherit !important; text-decoration: none !important; } .btn-primary table td:hover { background-color: #34495e !important; } .btn-primary a:hover { background-color: #34495e !important; border-color: #34495e !important; } } </style> </head> <body class="" style="background-color:#f6f6f6;font-family:sans-serif;-webkit-font-smoothing:antialiased;font-size:14px;line-height:1.4;margin:0;padding:0;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;"> <table border="0" cellpadding="0" cellspacing="0" class="body" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;background-color:#f6f6f6;width:100%;"> <tr> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;">&nbsp;</td> <td class="container" style="font-family:sans-serif;font-size:14px;vertical-align:top;display:block;max-width:580px;padding:10px;width:580px;Margin:0 auto !important;"> <div class="content" style="box-sizing:border-box;display:block;Margin:0 auto;max-width:580px;padding:10px;"> <!-- START CENTERED WHITE CONTAINER --> <table class="main" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;background:#fff;border-radius:3px;width:100%;"> <!-- START MAIN CONTENT AREA --> <tr> <td class="wrapper" style="font-family:sans-serif;font-size:14px;vertical-align:top;box-sizing:border-box;padding:20px;"> <table border="0" cellpadding="0" cellspacing="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;width:100%;"> <tr> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;"> Dear {owner}, <br><br><b>{approver}</b> has rejected {timesheetOwner} ({timesheet}). {timesheetOwner} will be requested  that you approve the Timesheet.  <br><br> Message: &nbsp; {message}<br><br><br><br><!-- START FOOTER --> <div class="footer" style="clear:both;padding-top:10px;text-align:center;width:100%;"> <table border="0" cellpadding="0" cellspacing="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;width:100%;"> <tr> <td class="content-block" style="font-family:sans-serif;font-size:14px;vertical-align:top;color:#999999;font-size:12px;text-align:center;"> <br><span class="apple-link" style="color:#999999;font-size:12px;text-align:center;"></span> </td> </tr> </table> </div> <!-- END FOOTER --> <!-- END CENTERED WHITE CONTAINER --> </div> </td> <td style="font-family:sans-serif;font-size:14px;vertical-align:top;">&nbsp;</td> </tr> </table> </body> </html>';n=n.replaceAll("{owner}",$.full_name),n=n.replaceAll("{approver}",e.user.full_name),n=n.replaceAll("{message}",a.replace(/(?:\r\n|\r|\n)/g,"<br>")),n=n.replaceAll("{timesheet}",t.currentTimesheet.year+"-"+t.currentTimesheet.term),n=n.replaceAll("{month}",moment(t.calendarDay).month()),n=n.replaceAll("{timesheetOwner}","Your Timesheet"),n=n.replaceAll($.full_name,r.data[0].name_surname),n=n.replaceAll("Your Timesheet","<b>"+t.timesheetTitle+"</b>");var s={};s.Subject=e.user.full_name+" has rejected "+t.timesheetTitle+"("+t.currentTimesheet.year+"-"+t.currentTimesheet.term+")",s.Template_With_Body=n,s.To_Addresses=[r.data[0].e_mail1],c.post(m.apiUrl+"messaging/send_external_email",s).then(function(){u.create({content:"Timesheet rejected succesfully.",className:"success"}),t.rejecting=!1,t.rejected=!0,t.rejectModal.hide()})};"billable"===t.currentTimesheetItems[0].approverType?v.findRecords("experts",n).then(function(e){s(e)}):v.findRecords("human_resources",n).then(function(e){$.email!=e.data[0].e_mail1?s(e):(u.create({content:"Timesheet rejected succesfully.",className:"success"}),t.rejecting=!1,t.rejected=!0,t.rejectModal.hide())})}else u.create({content:"Timesheet rejected succesfully.",className:"success"}),t.rejecting=!1,t.rejected=!0,t.rejectModal.hide()})})})})})},t.showModuleFrameModal=function(){t.timesheetUrl="https://timesheet.projectgroup.com.tr/?id="+t.owner.id,t.frameModal=t.frameModal||l({scope:t,controller:"TimesheetFrameController",templateUrl:"view/app/timesheet/timesheetFrame.html",backdrop:"static",show:!1}),t.frameModal.$promise.then(t.frameModal.show)
}}]);