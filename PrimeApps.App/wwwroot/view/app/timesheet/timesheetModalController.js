"use strict";angular.module("primeapps").controller("timesheetModalController",["$rootScope","$scope","ngToast","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","operations","activityTypes","ModuleService",function(e,a,r,t,o,l,n,d,i,p,s,u,m,c,y){a.operations=m,a.hasPermission=o.hasPermission,a.hasFieldFullPermission=y.hasFieldFullPermission,a.isExpert=a.$parent.isExpert,a.loadingModal=!0;var f=a.$parent.currentLookupField.lookup_type;if("relation"===f&&(f=a.$parent.$parent.$parent.record.related_module.value),null!=f){a.moduleModal=t("filter")(e.modules,{name:f},!0)[0],a.dropdownFields=t("filter")(a.moduleModal.fields,{data_type:"lookup",show_as_dropdown:!0},!0),a.dropdownFieldDatas={};for(var $=0;$<a.dropdownFields.length;$++)a.dropdownFieldDatas[a.dropdownFields[$].name]=[];a.setDropdownData=function(e){if(e.filters&&e.filters.length>0)a.dropdownFieldDatas[e.name]=null;else if(a.dropdownFieldDatas[e.name]&&a.dropdownFieldDatas[e.name].length>0)return;a.currentLookupFieldModal=e,a.lookupModal().then(function(r){a.dropdownFieldDatas[e.name]=r})},a.timesheetArr=[];var M=["entry_type","charge_type","activity_code2","selected_project","selected_company","place_of_performance","comment2","please_specify","please_specify_country","per_diem"];if(angular.forEach(M,function(e){a.timesheetArr.push(t("filter")(a.moduleModal.fields,{name:e},!0)[0])}),!a.moduleModal)return a.formModal.hide(),r.create({content:t("translate")("Common.NotFound"),className:"warning"}),void n.go("app.dashboard");if(a.primaryFieldModal=t("filter")(a.moduleModal.fields,{primary_lookup:!0})[0],a.primaryFieldModal||(a.primaryFieldModal=t("filter")(a.moduleModal.fields,{primary:!0})[0]),a.currentUser=y.processUser(e.user),a.currentDayMin=o.getCurrentDateMin().toISOString(),a.currentDayMax=o.getCurrentDateMax().toISOString(),a.currentHour=o.floorMinutes(new Date),a.recordModal={},a.recordModal.owner=a.currentUser,a.perDiemEntryTypeId=t("filter")(a.$parent.$parent.$parent.workedTimeItems,{system_code:"per_diem_only"},!0)[0].id,a.headerTitleCase=a.$parent.requestType,"edit"==a.$parent.$parent.$parent.requestType&&(a.editChargeType=a.$parent.$parent.$parent.editData.chargeType,y.getRecord(a.moduleModal.name,a.$parent.$parent.$parent.editData.id).then(function(e){a.editModuleLoading=!1;var r=y.processRecordSingle(e.data,a.moduleModal,a.picklistsModuleModal);y.setDisplayDependency(a.moduleModal,r),angular.forEach(a.moduleModal.fields,function(e){y.setDependency(e,a.moduleModal,angular.copy(r),a.picklistsModuleModal)}),a.recordModal=r,a.recordModalState=angular.copy(r)})),a.$parent.$parent.$parent.primaryValueModal)if(a.primaryFieldModal.combination){var _=a.$parent.$parent.$parent.primaryValueModal.split(" ");if(1===_.length)a.recordModal[a.primaryFieldModal.combination.field_1]=_[0];else if(2===_.length)a.recordModal[a.primaryFieldModal.combination.field_1]=_[0],a.recordModal[a.primaryFieldModal.combination.field_2]=_[1];else{a.recordModal[a.primaryFieldModal.combination.field_1]="";for(var $=0;$<_.length;$++)$<_.length-1&&(a.recordModal[a.primaryFieldModal.combination.field_1]=a.recordModal[a.primaryFieldModal.combination.field_1]+_[$]+" ");a.recordModal[a.primaryFieldModal.combination.field_1]=a.recordModal[a.primaryFieldModal.combination.field_1].slice(0,-1),a.recordModal[a.primaryFieldModal.combination.field_2]=_[_.length-1]}}else a.recordModal[a.primaryFieldModal.name]=a.$parent.$parent.$parent.primaryValueModal;if(a.$parent.$parent.$parent.calendarDate){var h=angular.copy(a.$parent.$parent.$parent.calendarDate);a.recordModal.selected_date=h.hour(8).toDate()}y.getPicklists(a.moduleModal).then(function(e){var r=angular.copy(e);if(a.isExpert){var o=t("filter")(a.moduleModal.fields,{name:"charge_type"},!0)[0],l=r[o.picklist_id];angular.forEach(l,function(e){e.hidden="pm_billable"!==e.value2&&"pm_non_billable"!==e.value2})}else angular.forEach(l,function(e){e.hidden=!1});if("day"===a.$parent.$parent.$parent.calendarView){var n,d=t("filter")(a.moduleModal.fields,{name:"entry_type"},!0)[0],i=r[d.picklist_id];"1"===a.$parent.$parent.$parent.selectedDayTime?(n=t("filter")(i,{system_code:"morning_only"},!0)[0],a.recordModal.entry_type=n):"2"===a.$parent.$parent.$parent.selectedDayTime&&(n=t("filter")(i,{system_code:"afternoon_only"},!0)[0],a.recordModal.entry_type=n)}a.picklistsModuleModal=r,y.setDefaultValues(a.moduleModal,a.recordModal,e),y.setDisplayDependency(a.moduleModal,a.recordModal),a.loadingModal=!1}),a.lookupModal=function(r){if("users"===a.currentLookupFieldModal.lookup_type&&!a.currentLookupFieldModal.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="full_name",a.currentLookupFieldModal.lookupModulePrimaryField=o}if("relation"===a.currentLookupField.lookup_type){if(!a.record.related_module)return a.$broadcast("angucomplete-alt:clearInput",a.currentLookupField.name),i.defer().promise;var l=t("filter")(e.modules,{name:a.record.related_module.value},!0)[0];if(!l)return a.$broadcast("angucomplete-alt:clearInput",a.currentLookupField.name),i.defer().promise;a.currentLookupField.lookupModulePrimaryField=t("filter")(l.fields,{primary:!0},!0)[0]}return"number"!==a.currentLookupFieldModal.lookupModulePrimaryField.data_type&&"number_auto"!==a.currentLookupFieldModal.lookupModulePrimaryField.data_type||!isNaN(parseFloat(r))?y.lookup(r,a.currentLookupFieldModal,a.recordModal):(a.$broadcast("angucomplete-alt:clearInput",a.currentLookupFieldModal.name),i.defer().promise)},a.multiselectModal=function(e,r){var t=[];return angular.forEach(a.picklistsModule[r.picklist_id],function(a){a.inactive||(a.labelStr.toLowerCase().indexOf(e.toLowerCase())>-1||a.labelStr.toUpperCase().indexOf(e.toUpperCase())>-1||a.labelStr.toLowerCaseTurkish().indexOf(e.toLowerCaseTurkish())>-1||a.labelStr.toUpperCaseTurkish().indexOf(e.toUpperCaseTurkish())>-1)&&t.push(a)}),t},a.setCurrentLookupFieldModal=function(e){a.currentLookupFieldModal=e};var g=t("filter")(e.modules,{name:"timesheet"},!0)[0],v=t("filter")(g.fields,{name:"term"},!0)[0],F=t("filter")(g.fields,{name:"year"},!0)[0],k=t("filter")(g.fields,{name:"status"},!0)[0];y.getPicklists(g).then(function(e){a.months=e[v.picklist_id],a.years=e[F.picklist_id],a.statuses=e[k.picklist_id],a.statusDraft=t("filter")(a.statuses,{value:"draft"},!0)[0]}),a.specifyCountry=!1,a.isTurkeyHoliday=!1,a.isTurkeyHalfHoliday=!1;for(var D=parseInt(moment(a.$parent.calendarDay).month())+1,b=moment(a.$parent.calendarDay).year(),w=angular.copy(a.$parent.$parent.$parent.calendarDate),T=moment(w).date(),$=0;$<a.$parent.$parent.$parent.turkeyHolidays.length;$++){var P=a.$parent.$parent.$parent.turkeyHolidays[$];P.day===T&&P.month===D&&P.year===b&&(P.half_time?a.isTurkeyHalfHoliday=!0:a.isTurkeyHoliday=!0)}a.submitModal=function(o){function l(){var e=!0;return angular.forEach(a.moduleModal.fields,function(r){o[r.name]&&"lookup"===r.data_type&&"object"!=typeof o[r.name]&&(a.moduleModalForm[r.name].$setValidity("object",!1),e=!1)}),e}if(a.moduleModalForm.$valid&&l())if(a.submittingModal=!0,o=y.prepareRecord(o,a.moduleModal,a.recordModalState),"create"==a.$parent.$parent.$parent.requestType){var n={};n.fields=["term","year"],n.filters=[{field:"owner",operator:"equals",value:a.owner.id,no:1}],n.sort_field="created_at",n.sort_direction="desc",n.limit=2e3,y.findRecords("timesheet",n).then(function(l){l=l.data;var n={},d=!1,i=!1,p=parseInt(moment(a.$parent.calendarDay).month())+1,s=moment(a.$parent.calendarDay).year();angular.forEach(l,function(e){e.term==p&&e.year==s&&(d=!0,i=!0)});var m=!1,c="";if(d&&i){if(angular.forEach(l,function(e){e.term==p&&e.year==s&&(o.related_timesheet=e.id)}),a.$parent.$parent.$parent.day.events.length<2||2==a.$parent.$parent.$parent.day.events.length&&!a.$parent.$parent.$parent.day.events[0].code){var f=t("filter")(a.$parent.$parent.$parent.workedTimeItems,{id:o.entry_type},!0)[0].system_code;angular.forEach(a.$parent.$parent.$parent.day.events,function(e){if(e.entry_type){var r=t("filter")(a.$parent.$parent.$parent.workedTimeItems,{labelStr:e.entry_type},!0)[0].system_code;"full_day"==r||"per_diem_only"==r?(m=!0,c="Day is Full"):"full_day"==f&&f!=r?(m=!0,c="Day is Full"):"per_diem_only"==f&&f!=r?(m=!0,c="Day is Full"):f==r&&(m=!0,c="Already Exist")}})}else m=!0,c="Day is Full";m?(r.create({content:c,className:"warning"}),a.submittingModal=!1):(o.entry_type==a.perDiemEntryTypeId&&(o.per_diem=!0),y.insertRecord(a.moduleModal.name,o).then(function(r){var t=a.moduleModal.name+"_"+a.moduleModal.name;u.remove(t),e.activePages&&e.activePages[a.moduleModal.name]&&(e.activePages[a.moduleModal.name]=null);var o={};o.id=r.data.id,o.primary_value=a.$parent.$parent.$parent.primaryValueModal,a.$parent.$parent.$parent.record&&(a.$parent.$parent.$parent.record[a.$parent.currentLookupField.name]=o),a.$parent.$parent.$parent.formModalSuccess&&a.$parent.$parent.$parent.formModalSuccess(),a.submittingModal=!1,a.formModal.hide()})["catch"](function(e){409===e.status&&a.moduleModalForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){a.submittingModal=!1}))}else{if(p=10>p?"0"+p:p.toString(),n.term=t("filter")(a.months,{labelStr:p},!0)[0].id,n.year=t("filter")(a.years,{labelStr:s.toString()},!0)[0].id,n.status=a.statusDraft.id,n.owner=e.user.id,a.$parent.$parent.$parent.day.events.length<2||2==a.$parent.$parent.$parent.day.events.length&&!a.$parent.$parent.$parent.day.events[0].code){var f=t("filter")(a.$parent.$parent.$parent.workedTimeItems,{id:o.entry_type},!0)[0].system_code;angular.forEach(a.$parent.$parent.$parent.day.events,function(e){if(e.entry_type){var r=t("filter")(a.$parent.$parent.$parent.workedTimeItems,{labelStr:e.entry_type},!0)[0].system_code;"full_day"==r||"per_diem_only"==r?(m=!0,c="Day is Full"):"full_day"==f&&f!=r?(m=!0,c="Day is Full"):"per_diem_only"==f&&f!=r?(m=!0,c="Day is Full"):f==r&&(m=!0,c="Already Exist")}})}else m=!0,c="Day is Full";m?(r.create({content:c,className:"warning"}),a.submittingModal=!1):y.insertRecord("timesheet",n).then(function(r){o.related_timesheet=r.data.id,o.entry_type==a.perDiemEntryTypeId&&(o.per_diem=!0),y.insertRecord(a.moduleModal.name,o).then(function(r){var t=a.moduleModal.name+"_"+a.moduleModal.name;u.remove(t),e.activePages&&e.activePages[a.moduleModal.name]&&(e.activePages[a.moduleModal.name]=null);var o={};o.id=r.data.id,o.primary_value=a.$parent.$parent.$parent.primaryValueModal,a.$parent.$parent.$parent.record&&(a.$parent.$parent.$parent.record[a.$parent.currentLookupField.name]=o),a.$parent.$parent.$parent.formModalSuccess&&a.$parent.$parent.$parent.formModalSuccess(),a.submittingModal=!1,a.formModal.hide()})["catch"](function(e,r){409===r&&a.moduleModalForm[e.field].$setValidity("unique",!1)})["finally"](function(){a.submittingModal=!1})})}})}else{var d=!1,i="";if(a.$parent.$parent.$parent.day.events.length<2||2===a.$parent.$parent.$parent.day.events.length&&!a.$parent.$parent.$parent.day.events[0].code)d=!1;else{var p=t("filter")(a.$parent.$parent.$parent.workedTimeItems,{id:a.recordModal.entry_type.id},!0)[0].system_code,s=a.$parent.$parent.$parent.editData.code;"full_day"==p||"per_diem_only"==p?(d=!0,i="Day is Full"):p!=s&&(d=!0,i="Already Exist")}d?(r.create({content:i,className:"warning"}),a.submittingModal=!1):(o.entry_type==a.perDiemEntryTypeId&&(o.per_diem=!0),o.id=a.$parent.$parent.$parent.editData.id,y.updateRecord(a.moduleModal.name,o).then(function(r){var t=a.moduleModal.name+"_"+a.moduleModal.name;u.remove(t),e.activePages&&e.activePages[a.moduleModal.name]&&(e.activePages[a.moduleModal.name]=null);var o={};o.id=r.data.id,o.primary_value=a.$parent.$parent.$parent.primaryValueModal,a.$parent.$parent.$parent.record&&(a.$parent.$parent.$parent.record[a.$parent.$parent.$parent.currentLookupField.name]=o),a.$parent.$parent.$parent.formModalSuccess&&a.$parent.$parent.$parent.formModalSuccess(),a.submittingModal=!1,a.formModal.hide()})["catch"](function(e){409===e.status&&a.moduleModalForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){a.submittingModal=!1}))}},a.calculate=function(e){y.calculate(e,a.moduleModal,a.recordModal)},a.fieldValueChange=function(e,r){y.setDependency(e,a.moduleModal,a.recordModal,a.picklistsModuleModal),y.setDisplayDependency(a.moduleModal,a.recordModal),a.moduleModalForm&&a.moduleModalForm[e.name]&&a.moduleModalForm[e.name].$error.unique&&a.moduleModalForm[e.name].$setValidity("unique",!0);var t=parseInt(moment(a.$parent.calendarDay).month())+1,o=moment(a.$parent.calendarDay).year(),l=angular.copy(a.$parent.$parent.$parent.calendarDate),n=moment(l).date();if("charge_type"===e.name&&(a.isManagement=!1,"management"===r.value&&(a.isProjectHoliday=!1,a.isManagement=!0)),"place_of_performance"===e.name&&(a.specifyCountry=!1,a.isManagementHalfHoliday=!1,a.recordModal.please_specify_country="","other"===r.system_code&&(a.specifyCountry=!0)),"please_specify_country"===e.name){a.isManagementHoliday=!1,a.isManagementHalfHoliday=!1;var d={fields:["total_count()","day","month","year","half_time"],filters:[{field:"country",operator:"is",value:r.system_code,no:1}],limit:1,offset:0};y.findRecords("holidays",d).then(function(e){if(e.data.length>0)for(var r=0;r<e.data.length;r++)e.data[r].day===n&&e.data[r].month===t&&e.data[r].year===o&&(e.data[r].half_time?a.isManagementHalfHoliday=!0:a.isManagementHoliday=!0)})}if("selected_project"===e.name){a.recordModal.activity_code2=null,a.isProjectHoliday=!1,a.isProjectHalfHoliday=!1;var i={fields:["total_count()","holidays_id.holidays.day","holidays_id.holidays.month","holidays_id.holidays.year","holidays_id.holidays.half_time"],filters:[{field:"projects_id",operator:"equals",value:r.id,no:1}],limit:1,offset:0,many_to_many:"projects"};y.findRecords("holidays",i).then(function(e){if(e.data.length>0)for(var r=0;r<e.data.length;r++)e.data[r]["holidays_id.holidays.day"]===n&&e.data[r]["holidays_id.holidays.month"]===t&&e.data[r]["holidays_id.holidays.year"]===o&&(e.data[r]["holidays_id.holidays.half_time"]?a.isProjectHalfHoliday=!0:a.isProjectHoliday=!0)})}}}}]);