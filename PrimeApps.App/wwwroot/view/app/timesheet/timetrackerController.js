"use strict";var app=angular.module("primeapps",[]);app.controller("TimetrackerController",["$rootScope","$scope","moment","$modal","$filter","$location","ModuleService","config","$http","$state","helper","ngToast","components",function(e,t,r,a,o,n,s,i,c,l,d,u,m){t.loggedInUser=e.user.id,t.owner=o("filter")(e.users,{id:n.search().user?parseInt(n.search().user):e.user.id},!0)[0],t.userWeek=parseInt(n.search().week),t.userYear=parseInt(n.search().year),t.userMonth=parseInt(n.search().month),t.weekLength=r().isoWeek(),t.settings={},t.loading=!0,t.loadingForm=!1,t.hasManuelProcess=!1,t.waitingForApproval=!1,t.manuelApproveRequest=!1,t.isApproved=!1,t.refreshSubModules={},t.currentUser=s.processUser(e.user),t.module=o("filter")(e.modules,{name:"timetrackers"},!0)[0],t.timetrackerItemModule=o("filter")(e.modules,{name:"timetracker_items"},!0)[0],t.relationModule=o("filter")(t.module.relations,{related_module:"timetracker_items"},!0)[0],t.lookupTypes=o("filter")(t.timetrackerItemModule.fields,{data_type:"lookup"},!0),t.hasAdminRights=angular.copy(e.user.profile.has_admin_rights),t.firstConditionOfMonth=!1,t.secondConditionOfMonth=!1,t.showFullName=n.search().user?!0:!1,angular.forEach(t.menu,function(e){e.menu_items.length>0&&(t.timeTrackerBackBottomShow=o("filter")(e.menu_items,{module_id:t.module.id},!0)[0])}),t.labels=[];for(var p=0;p<t.relationModule.display_fields_array.length;p++){var f=t.relationModule.display_fields_array[p],h=o("filter")(t.timetrackerItemModule.fields,{name:f},!0)[0];h&&t.labels.push(h)}t.lookupTypeForLabel=o("filter")(t.labels,{data_type:"lookup"},!0),c.get(i.apiUrl+"settings/get_by_key/5/timetracker_settings").then(function(e){t.timetrackerSettingId=e.data.id,t.settings=angular.fromJson(e.data.value)}),t.getTimeTrackerCalendar=function(e,a,n,i){var c=r().isoWeek();t.userWeek&&(c=t.userWeek),e&&(c=e);var d=r().year();t.userYear&&(d=t.userYear);var m=r(d,"YYYY").week(c).weekday(0),p=m.month()+1;t.userMonth&&(p=t.userMonth),i&&(p=i),t.currentMonth=r(m).subtract(0,"month").startOf("month").format("MMMM");for(var f=m.day(),h=[],g=!1,k=!1,_=0;7>_;_++){var M=r(r(m).isoWeekday(f+_).format("YYYY-MM-DD")),v=r(d,"YYYY").week(c).weekday(_),y=M.day(),T={dayOrder:y,date:r(m).isoWeekday(f+_).format("DD MMMM dddd"),date_formatted:r(M).format("YYYY-MM-DD"),full_date:v,week:c,timetracker_items:[],description:o("translate")("Common.NoRecordFoundForToday"),totalHour:null,holiday:!1,notDayOfCurrentMonth:!1,month:M.month()+1};if(a||n)if("previous"===n)if(o("filter")(a,{notDayOfCurrentMonth:!0},!0).length<1){var w=r([d,T.month+1]).endOf("month").date();M.month()+1===p&&m.date()>w-7&&m.date()<=w&&(t.currentMonth=r(p+1,"MM").format("MMMM"),k=!0,T.notDayOfCurrentMonth=!0)}else o("filter")(a,{notDayOfCurrentMonth:!0},!0).length>0&&a[0].notDayOfCurrentMonth===!0&&(M.month()===p||t.firstConditionOfMonth||(g=!0));else o("filter")(a,{notDayOfCurrentMonth:!0},!0).length<1?M.month()+1!==p&&(T.notDayOfCurrentMonth=!0,g=!0):o("filter")(a,{notDayOfCurrentMonth:!0},!0).length>0&&a[0].notDayOfCurrentMonth===!1&&(M.month()===p||t.secondConditionOfMonth||(k=!0));else M.month()+1!==p&&(T.notDayOfCurrentMonth=!0);h.push(T)}if(a&&"previous"===n){if(g){t.firstConditionOfMonth=!0,c=a[0].week;for(var C=0;C<a.length;C++){var Y=a[C];Y.timetracker_items=[],Y.notDayOfCurrentMonth=Y.notDayOfCurrentMonth?!1:!0}h=a}else t.firstConditionOfMonth=!1;k&&(p+=1)}if(a&&"next"===n)if(k){t.secondConditionOfMonth=!0,c=a[0].week;for(var C=0;C<a.length;C++){var Y=a[C];Y.timetracker_items=[],Y.notDayOfCurrentMonth=Y.notDayOfCurrentMonth?!1:!0}h=a}else t.secondConditionOfMonth=!1;var D={};D.fields=[],angular.forEach(t.module.fields,function(e){e.deleted||D.fields.push(e.name)}),D.filters=[{field:"week",operator:"equals",value:c,no:1},{field:"year",operator:"equals",value:d,no:2},{field:"month",operator:"equals",value:p,no:3},{field:"owner",operator:"equals",value:t.owner.id,no:4}],D.limit=1,s.findRecords("timetrackers",D).then(function(e){if(e.data.length<1){if(t.userWeek&&t.userYear)return u.create({content:o("translate")("Common.NotFound"),className:"warning"}),void l.go("app.dashboard");var a=t.owner.email,n={};n.fields=["id"],n.filters=[{field:"e_posta",operator:"is",value:a,no:1}],n.limit=1,s.findRecords("calisanlar",n).then(function(e){if(e.data.length<1)u.create({content:o("translate")("Common.TimetrackerNotFound"),className:"warning"}),l.go("app.dashboard");else{var a={};a.week=c,a.year=d,a.month=p,a.calisan=e.data[0].id,a.owner=t.owner.id,a.date_range=h[0].date+"-"+h[6].date,a.tarih=r(h[0].full_date).format("YYYY-MM-DD[T]HH:mm:ss"),a.toplam_saat=0,s.insertRecord("timetrackers",a).then(function(e){t.currentTimetracker=e.data,t.owner.id===t.currentUser.id||null!==t.currentTimetracker.custom_approver&&t.currentTimetracker.custom_approver===t.currentUser.email||s.deleteRecord("timetrackers",e.data.id).then(function(){u.create({content:o("translate")("Common.NotFound"),className:"warning"}),l.go("app.dashboard")}),t.getItems(c,d,p,h)})}})}else{if(t.currentTimetracker=e.data[0],t.owner.id!==t.currentUser.id&&(null===t.currentTimetracker.custom_approver||t.currentTimetracker.custom_approver!==t.currentUser.email))return u.create({content:o("translate")("Common.NotFound"),className:"warning"}),void l.go("app.dashboard");t.getItems(c,d,p,h)}})},t.getItems=function(a,n,i,c){t.currentTimetracker.process_id=t.currentTimetracker["process.process_requests.process_id"],t.currentTimetracker.process_status=t.currentTimetracker["process.process_requests.process_status"],t.currentTimetracker.process_status_order=t.currentTimetracker["process.process_requests.process_status_order"],t.currentTimetracker.operation_type=t.currentTimetracker["process.process_requests.operation_type"];for(var l=0;l<e.approvalProcesses.length;l++){var d=e.approvalProcesses[l];d.module_id===t.module.id&&"manuel"===d.trigger_time&&(t.hasManuelProcess=!0)}t.currentTimetracker.process_status?(2===t.currentTimetracker.process_status&&(t.isApproved=!0),(1===t.currentTimetracker.process_status||2===t.currentTimetracker.process_status||3===t.currentTimetracker.process_status&&t.currentTimetracker.updated_by!==t.currentUser.id)&&(t.freeze=!0),s.getProcess(t.currentTimetracker.process_id).then(function(r){var a=t.currentTimetracker.custom_approver;if(a===e.user.email?(t.isApprovalRecord=!0,t.waitingForApproval=!1):a!==e.user.email&&1===t.currentTimetracker.process_status&&(t.waitingForApproval=!0,t.isApproved=!1,t.isApprovalRecord=!1),0===t.currentTimetracker.operation_type&&2===t.currentTimetracker.process_status)for(var o=0;o<r.data.operations_array.length;o++){var n=r.data.operations_array[o];"update"===n&&(t.freeze=!1)}1===t.currentTimetracker.operation_type&&2===t.currentTimetracker.process_status&&(t.freeze=!1)})):(t.isApproved=!1,t.freeze=!1);var u={};u.fields=[],angular.forEach(t.timetrackerItemModule.fields,function(e){e.deleted||u.fields.push(e.name)}),angular.forEach(t.lookupTypes,function(e){angular.forEach(t.lookupTypeForLabel,function(t){e.name===t.name&&u.fields.push(t.name+"."+t.lookup_type+"."+t.lookupModulePrimaryField.name)})}),u.filters=[{field:"owner",operator:"equals",value:t.owner.id,no:1},{field:"related_timetracker",operator:"equals",value:t.currentTimetracker.id,no:2}],u.sort_field="created_at",u.sort_direction="desc",u.limit=2e3,s.findRecords("timetracker_items",u).then(function(l){t.timetrackers=l.data;for(var d=null,u=0;u<l.data.length;u++){var m=l.data[u];angular.forEach(t.lookupTypeForLabel,function(e){m[e.name]&&null!==m[e.name]&&(m[e.name]=m[e.name+"."+e.lookup_type+"."+e.lookupModulePrimaryField.name])});for(var p=0;p<c.length;p++){var f=c[p];f.date_formatted===r.utc(m.tarih).format("YYYY-MM-DD")&&(c[p].timetracker_items.push(m),f.totalHour+=m.saat,d+=m.saat)}}for(var h=0;h<c.length;h++)for(var g=c[h],k=0;k<e.holidays.length;k++){var _=e.holidays[k];r(r(_,"DD-MM-YYYY")).format("YYYY-MM-DD")===g.date_formatted&&(g.holiday=!0,g.description=o("translate")("Common.PublicHoliday"))}t.days=c,t.week=a,t.year=n,t.month=i,t.totalWeekHour=d,t.loading=!1,t.loadingForm=!1;var M=angular.copy(t.currentTimetracker);delete M["process.process_requests.operation_type"],delete M["process.process_requests.process_id"],delete M["process.process_requests.process_status"],delete M["process.process_requests.process_status_order"],delete M["process.process_requests_updated_at"],delete M["process.process_requests_updated_by"],M.toplam_saat=d,d||(d=0);for(var v=0,y=0;y<c.length;y++){var T=c[y];T.holiday||0===T.dayOrder||6===T.dayOrder||t.settings.includeWeekend||T.notDayOfCurrentMonth||v++}var w=v*t.settings.dayStandartHour;M.tamamlanan_saat=d+"/"+w,M.hafta_toplami=w;var C=!1;d===w&&(C=!0),M.tamamlandi=C,M.tarih||(M.tarih=r(c[0].full_date).format("YYYY-MM-DD[T]HH:mm:ss")),M.date_range||(M.date_range=c[0].date+"-"+c[6].date),M.toplam_saat||(M.toplam_saat=0),M.kalan=d-w,M.ilgili_ay=o("titleCase")(t.currentMonth),s.updateRecord("timetrackers",M).then(function(){})})},t.getTimeTrackerCalendar(),t.openCreateModal=function(e){t.currentLookupField={lookup_type:"timetracker_items"},t.dayObj=e,t.calendarDate=e.date_formatted,t.editModuleLoading=!1,t.requestType="create",t.getTimetrackerItems=t.getTimeTrackerCalendar,t.timetrackerSettings=t.settings,t.formModal=t.formModal||a({scope:t,templateUrl:"view/app/timesheet/timetrackerModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.formModal.$promise.then(t.formModal.show)},t.openEditModal=function(e,r){t.currentLookupField={lookup_type:"timetracker_items"},t.dayObj=e,t.calendarDate=e.date_formatted,t.editModuleLoading=!0,t.requestType="edit",t.getTimetrackerItems=t.getTimeTrackerCalendar,t.editData=r,t.timetrackerSettings=t.settings,t.formModal=t.formModal||a({scope:t,templateUrl:"view/app/timesheet/timetrackerModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.formModal.$promise.then(t.formModal.show)},t["delete"]=function(e,r){s.deleteRecord("timetracker_items",r).then(function(){t.getTimeTrackerCalendar(e.week,null,null,e.month)})},t.settingsModal=function(){t.settingsFormModal=t.settingsFormModal||a({scope:t,templateUrl:"view/app/timesheet/timetrackerSettingsModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.settingsFormModal.$promise.then(t.settingsFormModal.show)},t.submitSettings=function(){if(t.settings.dayMaxHour&&t.settings.dayMinHour&&t.settings.weekHour&&t.settings.dayStandartHour){t.settingsApproving=!0,t.settings.includeWeekend||(t.settings.includeWeekend=!1),t.settings.includeHoliday||(t.settings.includeHoliday=!1);var e={key:"timetracker_settings",value:angular.toJson(t.settings),type:5};c.put(i.apiUrl+"settings/update/"+t.timetrackerSettingId,e).then(function(e){t.settingsApproving=!1,t.settings=angular.fromJson(e.data.value),t.getTimeTrackerCalendar(),t.settingsFormModal.hide()})}},t.sendToProcessApproval=function(){m.run("BeforeSendToProcessApproval","Script",t,null),t.manuelApproveRequest=!0;for(var e=!0,r=0;r<t.days.length;r++){var a=t.days[r];a.holiday||0===a.dayOrder||6===a.dayOrder||t.settings.includeWeekend||a.notDayOfCurrentMonth||a.totalHour<t.settings.dayMinHour&&(e=!1)}if(e){var n={record_id:t.currentTimetracker.id,module_id:t.module.id};s.sendApprovalManuel(n).then(function(){m.run("AfterSendToProcessApproval","Script",t,null),t.hasManuelProcess=!1,t.waitingForApproval=!0,t.freeze=!0,t.manuelApproveRequest=!1,t.currentTimetracker.process_status=1,t.currentTimetracker.process_status_order++})["catch"](function(){t.manuelApproveRequest=!1})}else u.create({content:o("translate")("Common.CanNotSendToProcess",{minSaat:t.settings.dayMinHour}),className:"warning"}),t.manuelApproveRequest=!1},t.approveProcess=function(){t.approving=!0,s.approveProcessRequest(t.currentTimetracker.operation_type,t.module.name,t.currentTimetracker.id).then(function(){t.isApproved=!0,t.freeze=!0,t.approving=!1,t.currentTimetracker.process_status=2,t.waitingForApproval=!0})["catch"](function(){t.approving=!1})},t.rejectProcess=function(e){t.rejecting=!0,s.rejectProcessRequest(t.currentTimetracker.operation_type,t.module.name,e,t.currentTimetracker.id).then(function(){t.isRejectedRequest=!0,t.rejecting=!1,t.currentTimetracker.process_status=3,t.rejectModal.hide()})["catch"](function(){t.rejecting=!1})},t.reApproveProcess=function(){t.reapproving=!0;for(var e=!0,r=0;r<t.days.length;r++){var a=t.days[r];a.holiday||0===a.dayOrder||6===a.dayOrder||t.settings.includeWeekend||a.notDayOfCurrentMonth||a.totalHour<t.settings.dayMinHour&&(e=!1)}e?s.send_approval(t.currentTimetracker.operation_type,t.module.name,t.currentTimetracker.id).then(function(){t.waitingForApproval=!0,t.freeze=!0,t.reapproving=!1,t.currentTimetracker.process_status=1,t.currentTimetracker.process_status_order++})["catch"](function(){t.reapproving=!1}):(u.create({content:o("translate")("Common.CanNotSendToProcess",{minSaat:t.settings.dayMinHour}),className:"warning"}),t.reapproving=!1)},t.openRejectApprovalModal=function(){t.rejectModal=t.rejectModal||a({scope:t,templateUrl:"view/app/module/rejectProcessModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.rejectModal.$promise.then(t.rejectModal.show)}}]),app.filter("makePositive",function(){return function(e){return Math.abs(e)}});