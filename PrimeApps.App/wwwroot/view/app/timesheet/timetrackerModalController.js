"use strict";angular.module("primeapps").controller("timetrackerModalController",["$rootScope","$scope","ngToast","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","operations","activityTypes","ModuleService",function(e,a,r,o,t,l,n,d,i,u,p,m,c,s,M){a.operations=c,a.hasPermission=t.hasPermission,a.hasFieldFullPermission=M.hasFieldFullPermission,a.loadingModal=!0,a.timetrackerModule=o("filter")(e.modules,{name:"timetrackers"},!0)[0],a.relationModule=o("filter")(a.timetrackerModule.relations,{related_module:"timetracker_items"},!0)[0];var $=a.$parent.currentLookupField.lookup_type;if("relation"===$&&($=a.$parent.$parent.$parent.record.related_module.value),null!=$){a.moduleModal=o("filter")(e.modules,{name:$},!0)[0],a.dropdownFields=o("filter")(a.moduleModal.fields,{data_type:"lookup",show_as_dropdown:!0},!0),a.dropdownFieldDatas={};for(var f=0;f<a.dropdownFields.length;f++)a.dropdownFieldDatas[a.dropdownFields[f].name]=[];a.setDropdownData=function(e){if(e.filters&&e.filters.length>0)a.dropdownFieldDatas[e.name]=null;else if(a.dropdownFieldDatas[e.name]&&a.dropdownFieldDatas[e.name].length>0)return;a.currentLookupFieldModal=e,a.lookupModal().then(function(r){a.dropdownFieldDatas[e.name]=r})},a.timetrackerArr=[];var y=a.relationModule.display_fields_array;if(angular.forEach(y,function(e){a.timetrackerArr.push(o("filter")(a.moduleModal.fields,{name:e},!0)[0])}),!a.moduleModal)return a.formModal.hide(),r.create({content:o("translate")("Common.NotFound"),className:"warning"}),void n.go("app.dashboard");if(a.primaryFieldModal=o("filter")(a.moduleModal.fields,{primary_lookup:!0})[0],a.primaryFieldModal||(a.primaryFieldModal=o("filter")(a.moduleModal.fields,{primary:!0})[0]),a.currentUser=M.processUser(e.user),a.currentDayMin=t.getCurrentDateMin().toISOString(),a.currentDayMax=t.getCurrentDateMax().toISOString(),a.currentHour=t.floorMinutes(new Date),a.recordModal={},a.recordModal.owner=a.currentUser,a.headerTitleCase=a.$parent.requestType,"edit"==a.$parent.$parent.$parent.requestType&&M.getRecord(a.moduleModal.name,a.$parent.$parent.$parent.editData.id).then(function(e){a.editModuleLoading=!1;var r=M.processRecordSingle(e.data,a.moduleModal,a.picklistsModuleModal);M.setDisplayDependency(a.moduleModal,r),angular.forEach(a.moduleModal.fields,function(e){M.setDependency(e,a.moduleModal,angular.copy(r),a.picklistsModuleModal)}),a.recordModal=r,a.recordModalState=angular.copy(r)}),a.$parent.$parent.$parent.primaryValueModal)if(a.primaryFieldModal.combination){var g=a.$parent.$parent.$parent.primaryValueModal.split(" ");if(1===g.length)a.recordModal[a.primaryFieldModal.combination.field_1]=g[0];else if(2===g.length)a.recordModal[a.primaryFieldModal.combination.field_1]=g[0],a.recordModal[a.primaryFieldModal.combination.field_2]=g[1];else{a.recordModal[a.primaryFieldModal.combination.field_1]="";for(var f=0;f<g.length;f++)f<g.length-1&&(a.recordModal[a.primaryFieldModal.combination.field_1]=a.recordModal[a.primaryFieldModal.combination.field_1]+g[f]+" ");a.recordModal[a.primaryFieldModal.combination.field_1]=a.recordModal[a.primaryFieldModal.combination.field_1].slice(0,-1),a.recordModal[a.primaryFieldModal.combination.field_2]=g[g.length-1]}}else a.recordModal[a.primaryFieldModal.name]=a.$parent.$parent.$parent.primaryValueModal;a.$parent.$parent.$parent.calendarDate&&(a.recordModal.tarih=a.$parent.$parent.$parent.calendarDate),M.getPicklists(a.moduleModal).then(function(e){var r=angular.copy(e);a.picklistsModuleModal=r,M.setDefaultValues(a.moduleModal,a.recordModal,e),M.setDisplayDependency(a.moduleModal,a.recordModal),a.loadingModal=!1}),a.lookupModal=function(r){if("users"===a.currentLookupFieldModal.lookup_type&&!a.currentLookupFieldModal.lookupModulePrimaryField){var t={};t.data_type="text_single",t.name="full_name",a.currentLookupFieldModal.lookupModulePrimaryField=t}if("relation"===a.currentLookupField.lookup_type){if(!a.record.related_module)return a.$broadcast("angucomplete-alt:clearInput",a.currentLookupField.name),i.defer().promise;var l=o("filter")(e.modules,{name:a.record.related_module.value},!0)[0];if(!l)return a.$broadcast("angucomplete-alt:clearInput",a.currentLookupField.name),i.defer().promise;a.currentLookupField.lookupModulePrimaryField=o("filter")(l.fields,{primary:!0},!0)[0]}return"number"!==a.currentLookupFieldModal.lookupModulePrimaryField.data_type&&"number_auto"!==a.currentLookupFieldModal.lookupModulePrimaryField.data_type||!isNaN(parseFloat(r))?M.lookup(r,a.currentLookupFieldModal,a.recordModal):(a.$broadcast("angucomplete-alt:clearInput",a.currentLookupFieldModal.name),i.defer().promise)},a.setCurrentLookupFieldModal=function(e){a.currentLookupFieldModal=e},a.submitModal=function(t){function l(){var e=!0;return angular.forEach(a.moduleModal.fields,function(r){t[r.name]&&"lookup"===r.data_type&&"object"!=typeof t[r.name]&&(a.moduleModalForm[r.name].$setValidity("object",!1),e=!1)}),e}if(a.moduleModalForm.$valid&&l()){a.submittingModal=!0,t=M.prepareRecord(t,a.moduleModal,a.recordModalState);var n=o("filter")(e.modules,{name:"timetracker_items"},!0)[0],d=o("filter")(n.fields,{name:"gorev"},!0)[0].picklist_id,i=o("filter")(a.picklistsModuleModal[d],{id:t.gorev},!0)[0];if("izindir"===i.value&&(t.izindir=!0),"create"===a.$parent.$parent.$parent.requestType){var u={};u.fields=["week","year","month"],u.filters=[{field:"owner",operator:"equals",value:a.recordModal.owner.id,no:1}],u.sort_field="created_at",u.sort_direction="desc",u.limit=2e3,M.findRecords("timetrackers",u).then(function(o){o=o.data;var l={},n=!1,d=!1,i=a.$parent.dayObj.week,u=a.$parent.dayObj.month,p=moment(a.$parent.calendarDay).year();angular.forEach(o,function(e){e.week===i&&(n=!0),e.year===p&&(d=!0)});var c=!1,s="";n&&d?(angular.forEach(o,function(e){e.week===i&&e.year===p&&e.month===u&&(t.related_timetracker=e.id)}),a.$parent.$parent.$parent.dayObj.totalHour+t.saat<=a.$parent.$parent.$parent.settings.dayMaxHour?c=!1:(c=!0,s="Günlük maksimum saat limitini aşıyor."),0===t.saat&&(c=!0,s="Lütfen geçerli bir saat giriniz."),c?(r.create({content:s,className:"warning"}),a.submittingModal=!1):M.insertRecord(a.moduleModal.name,t).then(function(r){var o=a.moduleModal.name+"_"+a.moduleModal.name;m.remove(o),e.activePages&&e.activePages[a.moduleModal.name]&&(e.activePages[a.moduleModal.name]=null);var t={};t.id=r.data.id,t.primary_value=a.$parent.$parent.$parent.primaryValueModal,a.$parent.$parent.$parent.record&&(a.$parent.$parent.$parent.record[a.$parent.currentLookupField.name]=t),a.$parent.$parent.$parent.getTimetrackerItems(i,null,null,u),a.$parent.$parent.$parent.formModalSuccess&&a.$parent.$parent.$parent.formModalSuccess(),a.submittingModal=!1,a.formModal.hide()})["catch"](function(e){409===e.status&&a.moduleModalForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){a.submittingModal=!1})):(l.week=i,l.month=u,l.year=p,l.owner=e.user.id,a.$parent.$parent.$parent.dayObj.totalHour+t.saat<=a.$parent.$parent.$parent.settings.dayMaxHour?c=!1:(c=!0,s="Günlük maksimum saat limitini aşıyor."),0===t.saat&&(c=!0,s="Lütfen geçerli bir saat giriniz."),c?(r.create({content:s,className:"warning"}),a.submittingModal=!1):M.insertRecord("timetrackers",l).then(function(r){t.related_timetracker=r.data.id,M.insertRecord(a.moduleModal.name,t).then(function(r){var o=a.moduleModal.name+"_"+a.moduleModal.name;m.remove(o),e.activePages&&e.activePages[a.moduleModal.name]&&(e.activePages[a.moduleModal.name]=null);var t={};t.id=r.data.id,t.primary_value=a.$parent.$parent.$parent.primaryValueModal,a.$parent.$parent.$parent.record&&(a.$parent.$parent.$parent.record[a.$parent.currentLookupField.name]=t),a.$parent.$parent.$parent.getTimetrackerItems(i),a.$parent.$parent.$parent.formModalSuccess&&a.$parent.$parent.$parent.formModalSuccess(),a.submittingModal=!1,a.formModal.hide()})["catch"](function(e,r){409===r&&a.moduleModalForm[e.field].$setValidity("unique",!1)})["finally"](function(){a.submittingModal=!1})}))})}else{var p=!1,c="";t.saat||(t.saat=a.$parent.$parent.$parent.editData.saat),a.$parent.$parent.$parent.dayObj.totalHour+t.saat-a.$parent.$parent.$parent.editData.saat<=a.$parent.$parent.$parent.settings.dayMaxHour?p=!1:(p=!0,c="Günlük maksimum saat limitini aşıyor."),p?(r.create({content:c,className:"warning"}),a.submittingModal=!1):(t.id=a.$parent.$parent.$parent.editData.id,M.updateRecord(a.moduleModal.name,t).then(function(r){var o=a.moduleModal.name+"_"+a.moduleModal.name;m.remove(o),e.activePages&&e.activePages[a.moduleModal.name]&&(e.activePages[a.moduleModal.name]=null);var t={};t.id=r.data.id,t.primary_value=a.$parent.$parent.$parent.primaryValueModal,a.$parent.$parent.$parent.record&&(a.$parent.$parent.$parent.record[a.$parent.$parent.$parent.currentLookupField.name]=t),a.$parent.$parent.$parent.getTimetrackerItems(a.$parent.dayObj.week),a.$parent.$parent.$parent.formModalSuccess&&a.$parent.$parent.$parent.formModalSuccess(),a.submittingModal=!1,a.formModal.hide()})["catch"](function(e){409===e.status&&a.moduleModalForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){a.submittingModal=!1}))}}},a.calculate=function(e){M.calculate(e,a.moduleModal,a.recordModal)},a.fieldValueChange=function(e){M.setDependency(e,a.moduleModal,a.recordModal,a.picklistsModuleModal),M.setDisplayDependency(a.moduleModal,a.recordModal),a.moduleModalForm&&a.moduleModalForm[e.name]&&a.moduleModalForm[e.name].$error.unique&&a.moduleModalForm[e.name].$setValidity("unique",!0)}}}]);