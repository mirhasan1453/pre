"use strict";angular.module("primeapps").controller("ViewFormController",["$rootScope","$scope","$state","$stateParams","$location","ngToast","$filter","$cache","$q","helper","dragularService","operators","ModuleService","ViewService","$http","config",function(e,t,a,l,i,r,s,o,u,n,c,v,d,m,f,p){function w(e,t,a){return a!=t?!0:void 0}var h=i.search().clone,g=i.search().id,y=s("filter")(e.modules,{name:l.type},!0)[0];if(t.costumeDate="this_day()",t.dateFormat=[{label:s("translate")("View.Second"),value:"s"},{label:s("translate")("View.Minute"),value:"m"},{label:s("translate")("View.Hour"),value:"h"},{label:s("translate")("View.Day"),value:"D"},{label:s("translate")("View.Week"),value:"W"},{label:s("translate")("View.Month"),value:"M"},{label:s("translate")("View.Year"),value:"Y"}],t.costumeDateFilter=[{name:"thisNow",label:s("translate")("View.Now"),value:"now()"},{name:"thisToday",label:s("translate")("View.StartOfTheDay"),value:"today()"},{name:"thisWeek",label:s("translate")("View.StartOfThisWeek"),value:"this_week()"},{name:"thisMonth",label:s("translate")("View.StartOfThisMonth"),value:"this_month()"},{name:"thisYear",label:s("translate")("View.StartOfThisYear"),value:"this_year()"},{name:"year",label:s("translate")("View.NowYear"),value:"year()"},{name:"month",label:s("translate")("View.NowMonth"),value:"month()"},{name:"day",label:s("translate")("View.NowDay"),value:"day()"},{name:"costume",label:s("translate")("View.CustomDate"),value:"costume"},{name:"todayNextPrev",label:s("translate")("View.FromTheBeginningOfTheDay"),value:"costumeN",nextprevdatetype:"D"},{name:"weekNextPrev",label:s("translate")("View.FromTheBeginningOfTheWeek"),value:"costumeW",nextprevdatetype:"M"},{name:"monthNextPrev",label:s("translate")("View.FromTheBeginningOfTheMonth"),value:"costumeM",nextprevdatetype:"M"},{name:"yearNextPrev",label:s("translate")("View.FromTheBeginningOfTheYear"),value:"costumeY",nextprevdatetype:"Y"}],t.dateChange=function(e){"costume"!=e.costumeDate&&"costumeN"!=e.costumeDate&&"costumeW"!=e.costumeDate&&"costumeM"!=e.costumeDate&&"costumeY"!=e.costumeDate&&(e.value=e.costumeDate),("costumeN"===e.costumeDate||"costumeW"===e.costumeDate||"costumeM"===e.costumeDate||"costumeY"===e.costumeDate)&&(e.value="",e.valueX="",e.nextprevdatetype="")},t.nextPrevDateChange=function(e){t.setCostumDate(e)},t.nextPrevDateTypeChange=function(e){t.setCostumDate(e)},t.setCostumDate=function(e){if(null===e.valueX||""===e.valueX||void 0===e.valueX)return e.value="",!1;switch(void 0===e.nextprevdatetype&&(e.nextprevdatetype=t.dateFormat[0].value),e.costumeDate){case"costumeN":e.value="today("+e.valueX+e.nextprevdatetype+")";break;case"costumeM":e.value="this_month("+e.valueX+e.nextprevdatetype+")";break;case"costumeW":e.value="this_week("+e.valueX+e.nextprevdatetype+")";break;case"costumeY":e.value="this_year("+e.valueX+e.nextprevdatetype+")"}},!y)return r.create({content:s("translate")("Common.NotFound"),className:"warning"}),void a.go("app.dashboard");t.module=y;var _=y.name+"_"+y.name,b=o.get(_);if(!b||!b.views||b.views.length<1)return void a.go("app.moduleList",{type:y.name});if(g){var k=b.views;if(t.view=angular.copy(s("filter")(k,{id:parseInt(g)},!0)[0]),t.view.label=t.view["label_"+e.language],t.isOwner=t.view.created_by===e.user.id,!t.view)return void a.go("app.moduleList",{type:y.name});t.view.filter_logic&&"tr"===e.language&&(t.view.filter_logic=t.view.filter_logic.replace(/or/g,"veya").replace(/and/g,"ve"))}else t.view={},t.view.system_type="custom",t.view.sharing_type="me";s("filter")(e.approvalProcesses,{module_id:y.id},!0)[0]&&(t.showProcessFilter=!0,t.currenProcessField={field:"process.process_requests.process_status",order:t.view.fields?t.view.fields.length:0},t.currenProcessFilter=s("filter")(t.view.filters,{field:"process.process_requests.process_status"},!0),t.currenProcessFilter=!t.currenProcessFilter||t.currenProcessFilter.length<1?{field:"process.process_requests.process_status",operator:"equals",value:"0"}:t.currenProcessFilter[0],t.currenProcessFilter.field="process.process_requests.process_status",t.processFilter=t.currenProcessFilter.value),t.fields=m.getFields(t.module,angular.copy(t.view));var D=document.querySelector("#availableFields"),F=document.querySelector("#selectedFields");c([D],{scope:t,containersModel:[t.fields.availableFields],classes:{mirror:"gu-mirror-view",transit:"gu-transit-view"},accepts:w,moves:function(e,t,a){return a.classList.contains("dragable")}}),c([F],{scope:t,classes:{mirror:"gu-mirror-view",transit:"gu-transit-view"},containersModel:[t.fields.selectedFields]}),t.$on("dragulardrop",function(){t.viewForm.$setValidity("field",!0)}),d.getPicklists(t.module,!0).then(function(a){t.modulePicklists=a,t.view.filterList=[];for(var l=0;10>l;l++){var i={};i.field=null,i.operator=null,i.value=null,i.no=l+1,t.view.filterList.push(i)}if(t.view.filters){t.view.filters=s("orderBy")(t.view.filters,"no");for(var r=0;r<t.view.filters.length;r++){"process.process_requests.process_status"===t.view.filters[r].field&&t.view.filters.splice(r,1);var o=t.view.filters[r].field,u=t.view.filters[r].value;o.indexOf(".")>-1&&(o=o.split(".")[0],t.view.filters[r].field=o);var n=s("filter")(t.module.fields,{name:o},!0)[0],c=null;if(!n)return;switch(n.data_type){case"picklist":c=s("filter")(t.modulePicklists[n.picklist_id],{labelStr:u},!0)[0];break;case"multiselect":c=[];var d=u.split("|");angular.forEach(d,function(e){var a=s("filter")(t.modulePicklists[n.picklist_id],{labelStr:e},!0)[0];a&&c.push(a)});break;case"tag":c=[];var m=u.split("|");angular.forEach(m,function(e){c.push(e)});break;case"lookup":if("users"===n.lookup_type){var f={};if("0"===u||"[me]"===u)f.id=0,f.email="[me]",f.full_name=s("translate")("Common.LoggedInUser");else if("-"!=u){var p=s("filter")(e.users,{id:parseInt(u)},!0)[0];f.id=p.id,f.email=p.Email,f.full_name=p.FullName}c=[f]}else c=u;break;case"date":case"date_time":case"time":t.isCostumeDate(t.view.filters[r])?(c=t.view.filters[r].value,t.view.filterList[r].costumeDate=t.view.filters[r].costumeDate,t.view.filterList[r].valueX=t.view.filters[r].valueX,t.view.filterList[r].nextprevdatetype=t.view.filters[r].nextprevdatetype):(c=new Date(u),t.view.filterList[r].costumeDate="costume",t.view.filters[r].costumeDate="costume");break;case"checkbox":c=s("filter")(t.modulePicklists.yes_no,{system_code:u},!0)[0];break;default:c=u}t.view.filterList[r].field=n,t.view.filterList[r].operator=v[t.view.filters[r].operator],t.view.filterList[r].value=c,("empty"===t.view.filters[r].operator||"not_empty"===t.view.filters[r].operator)&&(t.view.filterList[r].value=null,t.view.filterList[r].disabled=!0)}}}),t.multiselect=function(e,a){var l=[];return angular.forEach(t.modulePicklists[a.picklist_id],function(t){t.inactive||t.labelStr.toLowerCase().indexOf(e)>-1&&l.push(t)}),l},t.tags=function(e,t){return f.get(p.apiUrl+"tag/get_tag/"+t.id).then(function(t){var a=t.data;return a.filter(function(t){return-1!=t.text.toLowerCase().indexOf(e.toLowerCase())})})},t.lookupUser=n.lookupUser;var x=function(e){if(e.operator){var t=new Date(e.value);switch(e.operator.name){case"greater":t.setHours(23),t.setMinutes(59),t.setSeconds(59),t.setMilliseconds(99);break;case"less":t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0)}e.value=t}};t.dateTimeChanged=function(e){x(e)},t.isCostumeDate=function(e){return e.value.indexOf("now(")>-1?(e.costumeDate="now()",!0):e.value.indexOf("today(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeN",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="today()",!0):"year()"===e.value?(e.costumeDate="year()",!0):"month()"===e.value?(e.costumeDate="month()",!0):"day()"===e.value?(e.costumeDate="day()",!0):e.value.indexOf("this_week(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeW",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="this_week()",!0):e.value.indexOf("this_month(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeM",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="this_month()",!0):e.value.indexOf("this_year(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeY",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="this_year()",!0):!1},t.operatorChanged=function(e,a){var l=t.view.filterList[a];l&&l.operator&&("date_time"===e.data_type&&l.value&&"costume"===l.costumeDate&&x(l),"empty"===l.operator.name||"not_empty"===l.operator.name?(l.value=null,l.disabled=!0):l.disabled=!1)},t.save=function(){function l(){var e=!0;return h&&(g=!1),t.fields.selectedFields.length<1&&(t.viewForm.$setValidity("field",!1),e=!1),e}function i(){o.remove(_),a.go("app.moduleList",{type:y.name})}function r(e,a){400===a&&(e.model_state&&e.model_state["view._filter_logic"]&&t.viewForm.filterLogic.$setValidity("filterLogic",!1),e.model_state&&e.model_state["request._filter_logic"]&&t.viewForm.filterLogic.$setValidity("filterLogicFilters",!1))}if(t.viewForm.$valid&&l()){t.submitting=!0;var u={};u.module_id=y.id,u.label=t.view.label,u.sharing_type=t.view.sharing_type,u.fields=[],u.filters=[],t.view.filter_logic&&(u.filter_logic=t.view.filter_logic.replace(/veya/g,"or").replace(/ve/g,"and"),("("!==u.filter_logic.charAt(0)||")"!==u.filter_logic.charAt(u.filter_logic.length-1))&&(u.filter_logic="("+u.filter_logic+")"));for(var n=0;n<t.fields.selectedFields.length;n++){var c=t.fields.selectedFields[n],v={};if(v.field=c.name,v.order=n+1,u.fields.push(v),c.lookup_type&&"relation"!=c.lookup_type){var f=s("filter")(e.modules,{name:c.lookup_type},!0)[0],p=s("filter")(f.fields,{primary:!0},!0)[0],w={};w.field=c.name+"."+f.name+"."+p.name+".primary",w.order=n+1,u.fields.push(w)}}var k=angular.copy(t.view.filterList);angular.forEach(k,function(t){if(t.field&&t.operator&&("empty"===t.operator.name||"not_empty"===t.operator.name||null!=t.value&&void 0!=t.value)){var a=t.field,l=a.name;if("lookup"===a.data_type&&"users"!=a.lookup_type){var i=s("filter")(e.modules,{name:a.lookup_type},!0)[0],r=s("filter")(i.fields,{primary:!0},!0)[0];l=a.name+"."+a.lookup_type+"."+r.name;var o=l+".primary";if(!s("filter")(u.fields,{field:o},!0)[0]){var n={};n.field=a.name,n.order=u.fields.length+1,u.fields.push(n);var c={};c.field=o,c.order=u.fields.length,u.fields.push(c)}}var v={};if(v.field=l,v.operator=t.operator.name,v.value=t.value,v.no=t.no,a=t.field.lookupModulePrimaryField&&"users"!==t.field.lookup_type?t.field.lookupModulePrimaryField:t.field,"empty"!==t.operator.name&&"not_empty"!==t.operator.name){if("picklist"===a.data_type&&(v.value=v.value.label[e.user.tenant_language]),"multiselect"===a.data_type){var d="";angular.forEach(v.value,function(t){d+=t.label[e.user.tenant_language]+"|"}),v.value=d.slice(0,-1)}if("tag"===a.data_type){var d="";angular.forEach(v.value,function(e){d+=e.text+"|"}),v.value=d.slice(0,-1)}"lookup"===a.data_type&&"users"===a.lookup_type&&(v.value=0===v.value[0].id?"[me]":v.value[0].id),"checkbox"===a.data_type&&(v.value=v.value.system_code)}else v.value="-";u.filters.push(v)}}),"custom"===t.view.sharing_type&&(t.view.shares?(u.shares=[],angular.forEach(t.view.shares,function(e){u.shares.push(e.id)})):u.sharing_type="me"),t.currenProcessFilter&&"0"!=t.currenProcessFilter.value&&u.filters.push(t.currenProcessFilter),t.currenProcessField&&"0"!=t.currenProcessFilter.value&&u.fields.push(t.currenProcessField),g?m.update(u,t.view.id,t.view._rev).then(function(){i()})["catch"](function(e){r(e.data,e.status)})["finally"](function(){t.submitting=!1}):m.create(u).then(function(e){var a=b.viewState;a||(a={},a.sort_field="created_at",a.sort_direction="desc",a.row_per_page=10),a.active_view=e.data.id,d.setViewState(a,t.module.id,a.id).then(function(){i()})["finally"](function(){t.submitting=!1})})["catch"](function(e){r(e.data,e.status)})["finally"](function(){t.submitting=!1})}}}]);