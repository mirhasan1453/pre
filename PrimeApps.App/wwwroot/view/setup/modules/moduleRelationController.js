"use strict";angular.module("primeapps").controller("ModuleRelationController",["$rootScope","$scope","$filter","$state","$stateParams","ngToast","$modal","$timeout","helper","dragularService","ModuleSetupService","ModuleService","AppService",function(e,l,a,t,n,o,r,i,s,d,u,c,m){var p=a("filter")(e.modules,{name:n.module},!0)[0];if(!p)return o.create({content:a("translate")("Common.NotFound"),className:"warning"}),void t.go("app.dashboard");l.module=angular.copy(p),l.relations=u.processRelations(l.module.relations),l.relationsState=angular.copy(l.relations),l.showFormModal=function(t){if(!t){t={};var n=[];angular.forEach(l.relations,function(e){n.push(e.order)});var o=Math.max.apply(null,n);o=0>o?0:o,t.order=o+1,t.relation_type="one_to_many",t.isNew=!0}l.currentRelation=t,l.currentRelation.hasRelationField=!0,l.currentRelationState=angular.copy(l.currentRelation),l.fields=u.getFields(l.currentRelation),l.currentRelation.detail_view_type||(l.currentRelation.detail_view_type="tab");var i={};i["label_"+e.language+"_plural"]="!"+l.module["label_"+e.language+"_plural"],l.moduleLists=a("filter")(e.modules,i,!0),l.formModal=l.formModal||r({scope:l,templateUrl:"view/setup/modules/relationForm.html",animation:"",backdrop:"static",show:!1}),l.formModal.$promise.then(function(){t.isNew||l.bindDragDrop(),l.formModal.show()})};var f,_;l.bindDragDrop=function(){i(function(){function e(e,l,a){return a!=l?!0:void 0}f&&f.destroy(),_&&_.destroy();var a=document.querySelector("#availableFields"),t=document.querySelector("#selectedFields");f=d([a],{scope:l,containersModel:[l.fields.availableFields],classes:{mirror:"gu-mirror-option",transit:"gu-transit-option"},accepts:e,moves:function(e,l,a){return a.classList.contains("dragable")}}),_=d([t],{scope:l,classes:{mirror:"gu-mirror-option",transit:"gu-transit-option"},containersModel:[l.fields.selectedFields]})},100)},l.relatedModuleChanged=function(){l.currentRelation.relationField=null,l.currentRelation.relatedModule&&(l.currentRelation.hasRelationField=a("filter")(l.currentRelation.relatedModule.fields,{data_type:"lookup",lookup_type:n.module,deleted:!1},!0).length>0),l.currentRelation.display_fields=null,l.fields=u.getFields(l.currentRelation),"many_to_many"===l.currentRelation.relation_type&&l.bindDragDrop()},l.relationTypeChanged=function(){"many_to_many"===l.currentRelation.relation_type&&l.bindDragDrop()},l.save=function(t){if(t.$valid){if(l.saving=!0,t.two_way)var r=t;else var r=angular.copy(l.currentRelation);if(r.display_fields=[],l.fields.selectedFields&&l.fields.selectedFields.length>0)angular.forEach(l.fields.selectedFields,function(l){if(r.display_fields.push(l.name),l.lookup_type){var t=a("filter")(e.modules,{name:l.lookup_type},!0)[0],n=a("filter")(t.fields,{primary:!0},!0)[0];r.display_fields.push(l.name+"."+t.name+"."+n.name+".primary")}});else{var i=a("filter")(r.relatedModule.fields,{primary:!0})[0];r.display_fields.push(i.name)}r.isNew&&(delete r.isNew,l.relations||(l.relations=[]),"many_to_many"===r.relation_type&&(r.relationField={},r.relationField.name=p.name)),u.prepareRelation(r);var s=function(){var e={display_fields:null,hasRelationField:!1,isNew:!0,order:l.currentRelation.order,relatedModule:l.module,relationField:null,relation_type:"many_to_many",$valid:!0,two_way:!0,mainModule:r.related_module};l.currentRelation.hasOwnProperty("label_en_singular")?(e.label_en_singular=l.module.label_en_singular,e.label_en_plural=l.module.label_en_plural):(e.label_tr_singular=l.module.label_tr_singular,e.label_tr_plural=l.module.label_tr_plural),l.fields.selectedFields=[],l.save(e)},d=function(){!r.two_way&&"many_to_many"===r.relation_type&&l.currentRelation.isNew?s():m.getMyAccount(!0).then(function(){l.module=angular.copy(a("filter")(e.modules,{name:n.module},!0)[0]),l.relations=u.processRelations(l.module.relations),o.create({content:a("translate")("Setup.Modules.RelationSaveSuccess"),className:"success"}),l.saving=!1,l.formModal.hide()})},f=function(){l.relations=l.relationsState,l.formModal&&(l.formModal.hide(),l.saving=!1)};if(r.id)c.updateModuleRelation(r,l.module.id).then(function(){d()})["catch"](function(){f()});else{if(r.mainModule)var _=a("filter")(e.modules,{name:r.mainModule},!0)[0].id;c.createModuleRelation(r,r.two_way?_:l.module.id).then(function(){d()})["catch"](function(){f()})}}},l["delete"]=function(e){c.deleteModuleRelation(e.id).then(function(){m.getMyAccount(!0).then(function(){var t=s.arrayObjectIndexOf(l.relations,e);l.relations.splice(t,1),o.create({content:a("translate")("Setup.Modules.RelationDeleteSuccess"),className:"success"})})})["catch"](function(){l.relations=l.relationsState,l.formModal&&(l.formModal.hide(),l.saving=!1)})},l.cancel=function(){angular.forEach(l.currentRelation,function(e,a){l.currentRelation[a]=l.currentRelationState[a]}),l.formModal.hide()}}]);