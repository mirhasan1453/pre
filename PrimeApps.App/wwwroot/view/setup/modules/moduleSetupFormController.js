"use strict";angular.module("primeapps").controller("ModuleFormSetupController",["$rootScope","$scope","$filter","$location","$state","ngToast","$q","$popover","$modal","helper","$timeout","dragularService","defaultLabels","$interval","$cache","systemRequiredFields","systemReadonlyFields","ModuleSetupService","ModuleService","AppService",function(e,l,t,a,i,r,n,o,d,u,s,c,p,m,f,_,y,h,v,g){l.id=a.search().id,l.clone=a.search().clone,l.redirect=a.search().redirect,l.record={},l.currentDeletedFields=[],l.documentSearch=e.user.profile.document_search,l.dataTypes=h.getDataTypes(),l.lookupUser=u.lookupUser,l.calendarColors=[{dark:"#b8c110",light:"#e9ebb9"},{dark:"#01a0e4",light:"#b3e2f5"},{dark:"#61b033",light:"#d0e6c3"},{dark:"#ee6d1a",light:"#fad2bb"},{dark:"#e21550",light:"#f5bacb"},{dark:"#b62f7c",light:"#e8c1d7"},{dark:"#643a8c",light:"#d1c5db"},{dark:"#174c9c",light:"#bacae0"},{dark:"#00995e",light:"#b4e0ce"},{dark:"#e83a21",light:"#f7c4be"}],l.addressTypes=[{name:"country",value:t("translate")("Common.Country")},{name:"city",value:t("translate")("Common.City")},{name:"disrict",value:t("translate")("Common.Disrict")},{name:"street",value:t("translate")("Common.Street")}],l.lookupSearchTypes=[{name:"starts_with",value:t("translate")("Filter.StartsWith")},{name:"contains",value:t("translate")("Filter.Contains")}],l.viewTypes=[{name:"dropdown",value:t("translate")("Common.Dropdown")},{name:"radio",value:t("translate")("Common.Radio")},{name:"checkbox",value:t("translate")("Common.Checkbox")}],l.positions=[{name:"left",value:t("translate")("Common.Left")},{name:"right",value:t("translate")("Common.Right")}];var k={};if(l.id||l.clone){if(k=t("filter")(e.modules,{name:l.id||l.clone},!0)[0],!k)return r.create({content:t("translate")("Common.NotFound"),className:"warning"}),void i.go("app.dashboard");if(l.module=angular.copy(k),l.clone){if("opportunity"===l.clone||"activity"===l.clone)return r.create({content:t("translate")("Common.NotFound"),className:"warning"}),void i.go("app.dashboard");l.module.label_en_plural=l.module.label_en_plural+" (Copy)",l.module.label_en_singular=l.module.label_en_singular+" (Copy)",l.module.label_tr_plural=l.module.label_tr_plural+" (Kopya)",l.module.label_tr_singular=l.module.label_tr_singular+" (Kopya)",l.module.related_modules=[],l.moduleLabelNotChanged=!0,l.module.system_type="custom";var F=[];angular.forEach(e.modules,function(e){F.push(e.order)}),angular.forEach(l.module.fields,function(e){e.deleted||(_.all.indexOf(e.name)<0&&(e.systemRequired=!1),y.all.indexOf(e.name)<0&&(e.systemReadonly=!1))});for(var M=angular.copy(t("filter")(l.module.sections,{deleted:"!true"},!0)),b=angular.copy(t("filter")(l.module.fields,{deleted:"!true"},!0)),w=["owner","created_by","created_at","updated_by","updated_at"],S=[],T=0;T<M.length;T++){var C=M[T];delete C.id;var L="custom_section"+T+1,P=t("filter")(S,{name:C.name},!0)[0];P||S.push({name:C.name,newName:L}),C.name=L}for(var D=0;D<b.length;D++){var x=b[D];w.indexOf(x.name)<0&&(delete x.id,x.name="custom_field"+D+1);var P=t("filter")(S,{name:x.section},!0)[0];x.section=P.newName}l.module.sections=M,l.module.fields=b,l.module.order=Math.max.apply(null,F)+1,l.module.name="custom_module"+k.order+"_c"}l.module.detail_view_type||(l.module.detail_view_type="tab")}else l.module=h.prepareDefaults(k),l.moduleLabelNotChanged=!0;l.module=h.processModule(l.module),l.moduleLayout=h.getModuleLayout(l.module),h.getPicklists().then(function(e){l.picklists=e.data});var O=function(){var e={value:"small",label:t("translate")("Setup.Modules.MultilineTypeSmall")},a={value:"large",label:t("translate")("Setup.Modules.MultilineTypeLarge")};l.multilineTypes=[],l.multilineTypes.push(e),l.multilineTypes.push(a)},E=function(e){u.getPicklists([0],e).then(function(e){l.lookupTypes=e[9e5];var a=t("filter")(l.lookupTypes,{name:"users"},!0).length>0;if(!a){var i={};i.id=9e5,i.label={},i.label.en=p.UserLookupFieldEn,i.label.tr=p.UserLookupFieldTr,i.order=0,i.type=0,i.value="users",l.lookupTypes.unshift(i);var r={};r.id=900100,r.label={},r.label.en=p.ProfileLookupFieldEn,r.label.tr=p.ProfileLookupFieldTr,r.order=0,r.type=0,r.value="profiles",l.lookupTypes.push(r);var n={};n.id=900101,n.label={},n.label.en=p.RoleLookupFieldEn,n.label.tr=p.RoleLookupFieldTr,n.order=0,n.type=0,n.value="roles",l.lookupTypes.push(n)}})},$=function(){var e={value:"off",label:t("translate")("Setup.Modules.RoundingTypeOff")},a={value:"down",label:t("translate")("Setup.Modules.RoundingTypeDown")},i={value:"up",label:t("translate")("Setup.Modules.RoundingTypeUp")};l.roundingTypes=[],l.roundingTypes.push(e),l.roundingTypes.push(a),l.roundingTypes.push(i)},N=function(){var e={value:"alphabetical",label:t("translate")("Setup.Modules.PicklistSortOrderAlphabetical")},a={value:"order",label:t("translate")("Setup.Modules.PicklistSortOrderOrder")};l.sortOrderTypes=[],l.sortOrderTypes.push(e),l.sortOrderTypes.push(a)},q=function(){var e={value:"start_date",label:t("translate")("Setup.Modules.CalendarDateTypeStartDate")},a={value:"end_date",label:t("translate")("Setup.Modules.CalendarDateTypeEndDate")};l.calendarDateTypes=[],l.calendarDateTypes.push(e),l.calendarDateTypes.push(a)};O(),E(!1),$(),N(),q(),h.getDeletedModules().then(function(e){l.deletedModules=e}),l.lookup=function(e){if(!l.currentLookupField.lookupType){var t=n.defer();return t.resolve([]),t.promise}if("users"===l.currentLookupField.lookup_type&&!l.currentLookupField.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="full_name",l.currentLookupField.lookupModulePrimaryField=a}return"number"!==l.currentLookupField.lookupModulePrimaryField.data_type&&"number_auto"!==l.currentLookupField.lookupModulePrimaryField.data_type||!isNaN(parseFloat(e))?(l.currentLookupField.data_type=l.currentLookupField.dataType.name,l.currentLookupField.lookup_type=l.currentLookupField.lookupType.value,v.lookup(e,l.currentLookupField,l.record)):(l.$broadcast("angucomplete-alt:clearInput",l.currentLookupField.name),n.defer().promise)},l.setCurrentLookupField=function(e){l.currentLookupField=angular.copy(e)},l.calculate=function(e){v.calculate(e,l.module,l.record)},l.setDependency=function(e){v.setDependency(e,l.module,l.record),v.setDisplayDependency(l.module,l.record)},l.refreshModule=function(){h.refreshModule(l.moduleLayout,l.module)},l.showEditModal=function(e){l.moduleState=angular.copy(l.module),l.isModuleSaving=e,l.editModal=l.editModal||d({scope:l,templateUrl:"view/setup/modules/editForm.html",animation:"",backdrop:"static",show:!1}),l.icons=v.getIcons(),l.showAdvancedOptionsEdit=!1,l.editModal.$promise.then(l.editModal.show)},l.cancelModule=function(){angular.forEach(l.module,function(e,t){angular.isArray(l.module[t])||angular.isObject(l.module[t])||(l.module[t]=l.moduleState[t])}),l.editModal.hide()},l.hasCalendarDateFields=function(){if("activities"===l.module.name)return!0;var e=t("filter")(l.module.fields,{calendar_date_type:"start_date"},!0)[0],a=t("filter")(l.module.fields,{calendar_date_type:"end_date"},!0)[0];return e&&a};var V=function(){var a={};a.label_en="",a.label_tr="",a.validation={},a.validation.required=!1,a.primary=!1,a.display_form=!0,a.display_detail=!0,a.display_list=!0,a.inline_edit=!0,a.editable=!0,a.show_label=!0,a.deleted=!1;var i=[];return angular.forEach(l.module.fields,function(e){i.push(e.order)}),a.order=Math.max.apply(null,i)+1,a.name="custom_field"+a.order,a.isNew=!0,a.permissions=[],angular.forEach(e.profiles,function(e){e.is_persistent&&e.has_admin_rights&&(e.name=t("translate")("Setup.Profiles.Administrator")),e.is_persistent&&!e.has_admin_rights&&(e.name=t("translate")("Setup.Profiles.Standard")),a.permissions.push({profile_id:e.id,profile_name:e.name,type:"full",profile_is_admin:e.has_admin_rights})}),a};l.showFieldModal=function(a,i,r){if(l.currentRow=a,l.currentColumn=i,l.showPermissionWarning=!1,r){if("lookup"===r.data_type&&(r.lookupType=t("filter")(l.lookupTypes,{value:r.lookup_type},!0)[0]),l.currentFieldState=angular.copy(r),r.default_value&&"lookup"===r.data_type)if("users"!==r.lookup_type){var n=parseInt(r.default_value);v.getRecord(r.lookup_type,n,!0).then(function(e){var l={};l.id=e.data.id,l.primary_value=e.data[r.lookupModulePrimaryField.name],r.temporary_default_value=l})}else if("[me]"===r.default_value){var o={};o.id=0,o.email="[me]",o.full_name=t("translate")("Common.LoggedInUser"),r.default_value=[o]}else v.getRecord(r.lookup_type,n,!0).then(function(e){var l={};l.id=e.data.id,l.email=e.data.email,l.full_name=e.data[r.lookupModulePrimaryField.name],r.default_value=[l]});if(!r.default_value||"date_time"!==r.data_type&&"date"!==r.data_type&&"time"!==r.data_type||"[now]"!==r.default_value||(r.default_value_now=!0),("picklist"===r.data_type||"multiselect"===r.data_type)&&h.getPicklist(r.picklist_id).then(function(a){if(l.defaulPicklistValues=a.data.items,r.default_value)if("picklist"===r.data_type)r.default_value=parseInt(r.default_value),r.default_value=t("filter")(l.defaulPicklistValues,{id:parseInt(r.default_value)},!0)[0];else if("multiselect"===r.data_type){var i=r.default_value.split(";"),n=[];angular.forEach(i,function(a){var i=t("filter")(l.defaulPicklistValues,{id:parseInt(a)},!0)[0];i.labelStr=i["label_"+e.user.tenant_language],n.push(i)}),l.currentField.defaultValueMultiselect=n}}),"checkbox"===r.data_type&&(r.default_value="true"===r.default_value?!0:!1),r.encrypted&&r.encryption_authorized_users_list.length>0){for(var u=[],s=0;s<r.encryption_authorized_users_list.length;s++){var c=t("filter")(e.users,{id:parseInt(r.encryption_authorized_users_list[s])},!0)[0];u.push(c)}r.encryption_authorized_users=u}}else r=V();l.currentField=r,l.currentFieldState=angular.copy(r),l.showAdvancedOptions=!1,l.currentField.dataType=t("filter")(l.dataTypes,{name:l.currentField.data_type},!0)[0],l.setMultilineDataType(),l.fieldModal=l.fieldModal||d({scope:l,templateUrl:"view/setup/modules/fieldForm.html",animation:"",backdrop:"static",show:!1}),l.fieldModal.$promise.then(function(){l.fieldModal.show()})},l.multiselectEncryptionUsers=function(){return t("filter")(e.users,function(e){return 0!==e.order},!0)},l.encryptedFieldChange=function(){l.currentField.encrypted&&(l.currentField.display_list=!1)},l.changeShowLabel=function(){l.currentField.show_label||(l.currentField.editable=!1)},l.changeDefaultValue=function(){l.currentField.default_value&&(l.currentField.show_label=!0)},l.dataTypeChanged=function(){if(l.currentField.dataType&&l.currentField.isNew){var t=l.currentField["label_"+e.language],a=l.currentField.dataType,i=l.currentField.validation.required;switch(l.currentField=V(),l.currentField["label_"+e.language]=t,a&&(l.currentField.dataType=a),i&&(l.currentField.validation.required=i),l.showAdvancedOptions=!1,a.name){case"text_single":l.currentField.validation.max_length=400;case"picklist":case"multiselect":l.currentField.picklist_sortorder="order";break;case"tag":l.currentField.picklist_sortorder="order";break;case"rating":l.currentField.validation.min_length=5;break;case"json":l.currentField.validation.required=!0,l.currentField.display_form=!1,l.currentField.display_list=!1,l.currentField.display_detail=!1,l.currentField.editable=!1,l.currentField.inline_edit=!1}}},l.requiredChanged=function(){l.currentField.validation.required?(l.currentField.display_form=!0,angular.forEach(l.currentField.permissions,function(e){e.type="full"})):l.currentField.permissions=l.currentFieldState.permissions,l.showPermissionWarning=!l.currentFieldState.validation.required&&l.currentField.validation.required},l.lookupTypeChanged=function(){if(l.currentField.lookupType){l.currentField.default_value=null,l.currentField.temporary_default_value=null,l.$broadcast("angucomplete-alt:clearInput","lookupDefaultValue");var a=t("filter")(e.modules,{name:l.currentField.lookupType.value},!0)[0];l.currentField.lookupModulePrimaryField=t("filter")(a.fields,{primary:!0},!0)[0]}},l.calendarDateTypeChanged=function(){l.currentField.calendar_date_type?(l.currentField.validation||(l.currentField.validation={}),l.currentField.validation.required=!0):l.currentField.validation.required=l.currentFieldState.validation.required},l.defaultValueNowChanged=function(){l.currentField.default_value_now&&(l.currentField.default_value=null)},l.setMultilineDataType=function(){l.currentField.dataType&&"text_multi"==l.currentField.dataType.name&&(l.currentField.multiline_type&&"large"===l.currentField.multiline_type?(l.currentField.dataType.maxLength=5,l.currentField.dataType.max=32e3,l.multiLineShowHtml=!0):(l.currentField.dataType.maxLength=4,l.currentField.dataType.max=2e3,l.multiLineShowHtml=!1))},l.bindPicklistDragDrop=function(){s(function(){function e(e,l,t,i){i||(i=10),angular.element(e).on("dragularenter",function(){l.scrollTop+=t,a=m(function(){l.scrollTop+=t},i)}),angular.element(e).on("dragularleave dragularrelease",function(){m.cancel(a)})}l.drakePicklist&&(l.drakePicklist.destroy(),l.drakePicklist=null);var a,i=document.querySelector("#picklistContainer"),r=document.querySelector("#picklistOptionContainer"),n=document.getElementById("rightTopBar"),o=document.getElementById("rightBottomBar");l.drakePicklist=c([i],{scope:l,containersModel:[l.picklistModel.items],classes:{mirror:"gu-mirror-option",transit:"gu-transit-option"},lockY:!0,moves:function(e,l,t){return t.classList.contains("option-handle")}}),angular.element(i).on("dragulardrop",function(){var e=t("filter")(l.sortOrderTypes,{value:"order"},!0)[0];l.currentField.picklist_sortorder=e}),e(n,r,-5),e(o,r,5)},100)};var R=["text_single","number","number_decimal","number_auto","currency","date","date_time","time","email","picklist","combination"];l.filterToCombinations=function(e){return!e.systemRequired&&!e.systemReadonly&&R.indexOf(e.data_type)>-1&&!e.deleted},l.filterToUniqueCombinations=function(e){return e.systemReadonly||"combination"==e.data_type||"number_auto"==e.data_type||"text_multi"==e.data_type||"checkbox"==e.data_type?!1:!0},l.showSectionModal=function(a){if(a)l.currentSectionState=angular.copy(a);else{a={},a.column_count=2,a.label_en="",a.label_tr="",a.display_form=!0,a.display_detail=!0,a.deleted=!1,l.showPermissionWarning=!1,a.permissions=[],angular.forEach(e.profiles,function(e){e.is_persistent&&e.has_admin_rights&&(e.name=t("translate")("Setup.Profiles.Administrator")),e.is_persistent&&!e.has_admin_rights&&(e.name=t("translate")("Setup.Profiles.Standard")),a.permissions.push({profile_id:e.id,profile_name:e.name,type:"full",profile_is_admin:e.has_admin_rights})});var i=[];angular.forEach(l.module.sections,function(e){i.push(e.order)}),a.order=Math.max.apply(null,i)+1,a.name="custom_section"+a.order,a.columns=[];for(var r=1;r<=a.column_count;r++){var n={};n.no=r,a.columns.push(n)}a.isNew=!0}l.currentSection=a,l.currentSectionState=angular.copy(a),l.sectionModal=l.sectionModal||d({scope:l,templateUrl:"view/setup/modules/sectionForm.html",animation:"",backdrop:"static",show:!1}),l.sectionModal.$promise.then(l.sectionModal.show)},l.saveSettings=function(e){e.$valid&&(l.moduleLabelNotChanged=!1,l.module.calendar_color_dark&&(l.module.calendar_color_light=t("filter")(l.calendarColors,{dark:l.module.calendar_color_dark},!0)[0].light),l.isModuleSaving?l.saveModule():l.editModal.hide())},l.saveField=function(a){if(!a.$valid)return void s(function(){var e=document.getElementById("field-form-body");e.scrollTop=e.scrollHeight},0,!1);if("lookup"===l.currentField.dataType.name&&!l.currentField.id){var i=t("filter")(l.module.fields,{data_type:"lookup",deleted:!1},!0);if(i.length>11)return void r.create({content:t("translate")("Setup.Modules.MaxLookupCount"),className:"warning"})}if(l.showAdvancedOptions=!1,l.currentField.lookupType&&(l.currentField.show_as_dropdown,l.currentField.lookup_type=l.currentField.lookupType.value,delete l.currentField.lookupType,delete l.currentField.temporary_default_value),"checkbox"!==l.currentField.dataType.name||l.currentField.default_value||(l.currentField.default_value=!1),"picklist"===l.currentField.dataType.name&&l.currentField.default_value&&l.currentField.default_value.id&&(l.currentField.default_value=l.currentField.default_value.id),void 0===l.currentField.default_value_now||null==l.currentField.default_value_now||"date_time"!==l.currentField.dataType.name&&"date"!==l.currentField.dataType.name&&"time"!==l.currentField.dataType.name||(l.currentField.default_value=l.currentField.default_value_now===!0?"[now]":null),l.currentField.defaultValueMultiselect&&(l.currentField.default_value="",angular.forEach(l.currentField.defaultValueMultiselect,function(e){l.currentField.default_value+=e.id+";"}),l.currentField.default_value=l.currentField.default_value.slice(0,-1)),l.currentField.isNew){delete l.currentField.isNew;var n="en"===e.language?"tr":"en",o=angular.copy(l.currentField);o.data_type=o.dataType.name,o.section=l.currentRow.section.name,o.section_column=l.currentColumn.column.no,o["label_"+n]=o["label_"+e.language],o.validation.readonly=!1,l.module.fields.push(o),l.moduleLayout=h.getModuleLayout(l.module),l.fieldModal.hide(),l.moduleChange=new Date}else l.fieldModal.hide();if("lookup"===l.currentField.dataType.name&&"users"!==l.currentField.lookup_type&&l.currentField.default_value&&(l.currentField.default_value=l.currentField.default_value.id),"lookup"===l.currentField.dataType.name&&"users"===l.currentField.lookup_type&&l.currentField.default_value){var d=l.currentField.default_value[0];l.currentField.default_value=0===d.id?"[me]":d.id}if(l.currentField.calendar_date_type)for(var u=0;u<k.fields.length;u++){var c=k.fields[u];c.calendar_date_type&&c.calendar_date_type===l.currentField.calendar_date_type&&(c.calendar_date_type=null)}},l.saveSection=function(t){if(t.$valid)if(l.currentSection.isNew){delete l.currentSection.isNew;var a="en"===e.language?"tr":"en",i=angular.copy(l.currentSection);i["label_"+a]=i["label_"+e.language],l.module.sections.push(i),l.moduleLayout=h.getModuleLayout(l.module),l.sectionModal.hide(),l.moduleChange=new Date}else l.sectionModal.hide()},l.deleteField=function(e){var a=t("filter")(l.module.fields,{name:e},!0)[0];if(a.name.indexOf("custom_field")>-1){var i=u.arrayObjectIndexOf(l.module.fields,a);l.module.fields.splice(i,1)}else{a.deleted=!0,a.order=999;var r={name:a.name,id:a.id};l.currentDeletedFields.push(r)}l.moduleLayout=h.getModuleLayout(l.module),l.moduleChange=new Date},l.deleteSection=function(e){var a=t("filter")(l.module.sections,{name:e},!0)[0],i=t("filter")(l.module.fields,{section:a.name},!0);if(a.name.indexOf("custom_section")>-1){var r=u.arrayObjectIndexOf(l.module.sections,a);l.module.sections.splice(r,1),angular.forEach(i,function(e){if(e.name.indexOf("custom_field")>-1){var t=u.arrayObjectIndexOf(l.module.fields,e);l.module.fields.splice(t,1)}else e.deleted=!0})}else a.deleted=!0,angular.forEach(i,function(e){e.deleted=!0});l.moduleLayout=h.getModuleLayout(l.module),l.moduleChange=new Date},l.changeSectionColumn=function(){l.moduleLayout=h.getModuleLayout(l.module),l.moduleChange=new Date},l.cancelField=function(){return l.currentField.isNew?(l.picklistsModule&&delete l.picklistsModule[l.currentField.name],l.currentField=null,void l.fieldModal.hide()):(angular.forEach(l.currentField,function(e,t){l.currentField[t]=l.currentFieldState[t]}),void l.fieldModal.hide())},l.cancelSection=function(){angular.forEach(l.currentSection,function(e,t){l.currentSection[t]=l.currentSectionState[t]}),l.sectionModal.hide()},l.getPicklistById=function(e){h.getPicklist(e).then(function(e){l.defaulPicklistValues=e.data.items})},l.fieldValueChange=function(t){v.setDependency(t,l.module,l.record,l.picklistsModule),v.setDisplayDependency(l.module,l.record),l.record.currency&&(l.currencySymbol=l.record.currency.value||e.currencySymbol)},v.getPicklists(l.module).then(function(e){l.picklistsModule=e}),l.multiselect=function(e,t){var a=[];return angular.forEach(l.picklistsModule[t.picklist_id],function(l){l.inactive||l.hidden||(l.labelStr.toLowerCase().indexOf(e.toLowerCase())>-1||l.labelStr.toUpperCase().indexOf(e.toUpperCase())>-1||l.labelStr.toLowerCaseTurkish().indexOf(e.toLowerCaseTurkish())>-1||l.labelStr.toUpperCaseTurkish().indexOf(e.toUpperCaseTurkish())>-1)&&a.push(l)}),a},l.newPicklist=function(){l.picklistModel={},l.showPicklistForm=!0},l.MinMaxValue=function(){(l.currentField.validation.min_length&&!l.currentField.validation.max_length||parseInt(l.currentField.validation.min_length)>parseInt(l.currentField.validation.max_length))&&(l.currentField.validation.max_length=l.currentField.validation.min_length)},l.editPicklist=function(){h.getPicklist(l.currentField.picklist_id).then(function(e){l.picklistModel=h.processPicklist(e.data),l.showPicklistForm=!0,l.bindPicklistDragDrop()})},l.newOption=function(e){e.$submitted=!1,e.$setValidity("minimum",!0),l.picklistModel.items||(l.picklistModel.items=[]);var t={};t.label="";var a=[];angular.forEach(l.picklistModel.items,function(e){a.push(e.order)}),t.order=l.picklistModel.items.length>0?Math.max.apply(null,a)+1:1,t.track=t.order,l.picklistModel.items.push(t),l.bindPicklistDragDrop()},l.deleteOption=function(e){l.picklistModel.items.splice(l.picklistModel.items.indexOf(e),1)},l.savePicklist=function(a){if(a.$valid){var i=null;if(i="tr"===e.language?t("filter")(l.picklists,{label_tr:l.picklistModel.label},!0)[0]:t("filter")(l.picklists,{label_en:l.picklistModel.label},!0)[0],!l.picklistModel.id&&i)return void a.$setValidity("unique",!1);if(l.picklistModel.id&&i&&i.id!=l.picklistModel.id)return void a.$setValidity("unique",!1);if(!l.picklistModel.items||l.picklistModel.items.length<2)return void a.$setValidity("minimum",!1);if(a.$valid){for(var n=0;n<l.picklistModel.items.length;n++){var o=l.picklistModel.items[n];o.order=n+1}l.picklistSaving=!0,h.preparePicklist(l.picklistModel),l.picklistModel.id?h.updatePicklist(l.picklistModel).then(function(){h.getPicklists().then(function(e){l.picklists=e.data,l.showPicklistForm=!1,f.remove("picklist_"+l.picklistModel.id)})["catch"](function(){l.picklistSaving=!0})})["catch"](function(){l.picklistSaving=!0}):h.createPicklist(l.picklistModel).then(function(e){return e.data.id?void h.getPicklists().then(function(t){t.data&&(l.picklists=t.data,l.currentField.picklist_id=e.data.id),l.showPicklistForm=!1})["catch"](function(){l.picklistSaving=!0}):(r.create({content:t("translate")("Common.NotFound"),className:"warning"}),void(l.picklistSaving=!1))})["catch"](function(){l.picklistSaving=!0})}}},l.openLocationModal=function(e){l.filedName=e,l.locationModal=l.frameModal||d({scope:l,controller:"locationFormModalController",templateUrl:"view/app/location/locationFormModal.html",backdrop:"static",show:!1}),l.locationModal.$promise.then(l.locationModal.show)},l.makePrimary=function(e){e.primary=!0,e.validation.required=!0,angular.forEach(l.module.fields,function(l){l.primary=l.name===e.name}),l.moduleLayout=h.getModuleLayout(l.module),l.moduleChange=new Date},l.makePrimaryLookup=function(e){e.primary_lookup=!0,e.validation.required=!0,angular.forEach(l.module.fields,function(l){l.primary_lookup=l.name===e.name}),l.moduleLayout=h.getModuleLayout(l.module),l.moduleChange=new Date};var I=function(){l.notValidFields=[];var e=["created_by","created_at","updated_by","updated_at","owner"];return angular.forEach(l.module.fields,function(a){var i=t("filter")(l.module.sections,{name:a.section},!0)[0];!i.display_form&&a.validation.required&&e.indexOf(a.name)<0&&l.notValidFields.push(a)}),l.notValidFields.length?(l.fieldErrorModal=l.fieldErrorModal||d({scope:l,templateUrl:"view/setup/modules/warningRequiredFieldDisplay.html",animation:"",backdrop:"static",show:!1}),l.fieldErrorModal.$promise.then(l.fieldErrorModal.show),!1):!0},U=function(e,a){angular.forEach(e,function(e){angular.forEach(e.fields,function(a){if(a.field.split(".")[1]==l.module.name){var i=t("filter")(l.module.fields,{primary:!0},!0)[0];a.field=a.field.replace(a.field.split(".")[2],i.name),v.updateView(e,e.id,void 0)}})}),a&&f.remove(a+"_"+a)},A=t("filter")(l.module.fields,{primary:!0},!0)[0];l.saveModule=function(){if(I()&&l.isModuleSaving){if((!l.id||l.clone)&&l.moduleLabelNotChanged)return void l.showEditModal(!0);var a=t("filter")(l.module.fields,{primary:!0},!0)[0];if(A.name!==a.name)for(var n=e.modules.length-1;n>=0;n--)for(var o=e.modules[n].fields.length-1;o>=0;o--)if(e.modules[n].fields[o].lookup_type==l.module.name){var d=e.modules[n].name,u=f.get(d+"_"+d);u?U(u.views,d):v.getViews(e.modules[n].id,void 0,void 0).then(function(e){U(e)})}l.saving=!0;var s=t("filter")(l.module.fields,{deleted:!0},!0);h.refreshModule(l.moduleLayout,l.module),s.length&&(l.module.fields=l.module.fields.concat(s));var c,p=h.prepareModule(angular.copy(l.module),l.picklistsModule,l.deletedModules);!l.id||l.clone?c=v.create(p):(delete p.relations,delete p.dependencies,c=v.update(p,p.id)),c.then(function(){g.getMyAccount(!0).then(function(){var a=l.module.name+"_"+l.module.name;if(f.remove(a),l.currentDeletedFields.length){var n=[];l.currentDeletedFields.forEach(function(l){n.push(l.id),e.activeFilters&&e.activeFilters.hasOwnProperty(a)&&e.activeFilters[a].hasOwnProperty(l.name)&&(Object.keys(e.activeFilters[a]).length>1?delete e.activeFilters[a][l.name]:delete e.activeFilters[a])}),h.deleteFieldsMappings(n)}l.editModal&&l.editModal.hide(),l.redirect?i.go("app.moduleForm",{type:l.module.name}):i.go("app.setup.modules"),r.create({content:t("translate")("Setup.Modules.SaveSuccess"),className:"success"}),(!l.id||l.clone)&&E(!0),f.remove("calendar_events")})})["catch"](function(){l.id?g.getMyAccount(!0).then(function(){l.editModal&&l.editModal.hide(),i.go("app.setup.modules")}):(l.saving=!1,l.editModal&&l.editModal.hide())})}}}]);