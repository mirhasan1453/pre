"use strict";angular.module("primeapps").controller("UserCustomShareFormController",["$rootScope","$location","$scope","$filter","ngToast","guidEmpty","blockUI","$state","UserCustomShareService","helper",function(e,r,s,u,a,t,n,o,i,l){s.id=parseInt(r.search().id),s.language=e.language,s.userOwner={},s.users=angular.copy(e.workgroup.users),s.lookupUserAndGroup=l.lookupUserAndGroup,i.getAll().then(function(e){if(s.userCustomShares=e.data,!s.id)for(var r=0;r<e.data.length;r++){var a=e.data[r];if(u("filter")(s.users,{id:a.user_id},!0)[0]){var t=u("filter")(s.users,{id:a.user_id},!0)[0].email;s.users=u("filter")(s.users,{email:"!"+t},!0)}}}),s.multiselect=function(){return u("filter")(e.modules,function(e){return 0!==e.order},!0)},s.id&&(s.loading=!0,i.get(s.id).then(function(r){s.userOwner.user=r.data.user_id,s.userOwner.shared_user=r.data.shared_user_id;var a=[],t=[];if(r.data.user_groups_list.length>0&&"{}"!==r.data.user_groups_list[0]&&i.getUserGroups().then(function(e){for(var s=r.data.user_groups.replace("{","").replace("}","").split(","),t=0;t<r.data.user_groups_list.length;t++){var n=u("filter")(e.data,{id:parseInt(s[t])},!0)[0],o={description:"User Group",id:n.id,name:n.name,type:"group"};a.push(o)}}),r.data.users_list.length>0)for(var n=0;n<r.data.users_list.length;n++){var o=u("filter")(e.users,{id:parseInt(r.data.users_list[n])},!0)[0],l={description:o.Email,id:o.id,name:o.FullName,type:"user"};a.push(l)}if(r.data.module_list.length>0)for(var d=0;d<r.data.module_list.length;d++){var p=u("filter")(e.modules,{name:r.data.module_list[d]},!0)[0];t.push(p)}s.userOwner.modules=t,s.userOwner.owners=a,s.loading=!1})),s.setFormValid=function(){s.userOwnerForm.shared.$setValidity("minTags",!0)},s.save=function(){if(s.userOwnerForm.$valid){s.saving=!0;var e=null;if(s.userOwner.owners&&s.userOwner.owners.length){s.shared_users=null,s.shared_user_groups=null;for(var r=0;r<s.userOwner.owners.length;r++){var t=s.userOwner.owners[r];"user"===t.type&&(null===s.shared_users?s.shared_users=t.id:s.shared_users+=","+t.id),"group"===t.type&&(null===s.shared_user_groups?s.shared_user_groups=t.id:s.shared_user_groups+=","+t.id)}}if(s.userOwner.modules&&s.userOwner.modules.length)for(var n=0;n<s.userOwner.modules.length;n++){var l=s.userOwner.modules[n];null===e?e=l.name:e+=","+l.name}var d={user_id:s.userOwner.user,shared_user_id:s.userOwner.shared_user,users:s.shared_users,user_groups:s.shared_user_groups,modules:e};s.id?i.update(s.id,d).then(function(){a.create({content:u("translate")("Setup.UserCustomShares.EditSuccess"),className:"success"}),o.go("app.setup.usercustomshares")})["catch"](function(){error(data,status),s.saving=!1}):i.create(d).then(function(){a.create({content:u("translate")("Setup.UserCustomShares.SaveSuccess"),className:"success"}),o.go("app.setup.usercustomshares")})["catch"](function(){error(data,status),s.saving=!1})}},s.cancel=function(){o.go("app.setup.usercustomshares")}}]);